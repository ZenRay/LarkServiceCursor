<!--
=============================================================================
宪章同步影响报告
=============================================================================
版本变更: 1.0.0 → 1.1.0
理由: MINOR 版本升级 - 新增原则和扩展现有原则

修改的原则:
- 扩展: II. 代码质量门禁 - 新增 Docstring 标准格式要求
- 新增: X. 文件操作闭环 (非妥协)

原则总数: 9 条 → 10 条

新增内容详情:
1. **原则 II 扩展 - Docstring 标准**:
   - 强制要求所有公共函数、类、模块包含 Docstring
   - 定义标准格式: Args/Returns/Raises/Example
   - 使用 `----------` 分隔线
   - 英文编写,简洁明确

2. **原则 X - 文件操作闭环**:
   - 强制文件创建、检查、更新形成闭环
   - 禁止过度新建文档,必须原地修改
   - 确保单一事实来源 (Single Source of Truth)
   - 适用于规范、计划、任务、代码、配置文件
   - 明确例外情况 (版本归档、备份、临时文件)

依赖模板更新状态:
- ✅ .specify/templates/plan-template.md: 无需更新
- ✅ .specify/templates/spec-template.md: 无需更新
- ✅ .specify/templates/tasks-template.md: 无需更新
- ✅ .cursor/commands/*.md: 无需更新 (原则 X 为通用行为准则,已内置于 AI 工作流)

影响范围:
- 所有新代码必须包含标准 Docstring
- 所有文档操作必须遵循闭环原则
- 代码审查需增加 Docstring 格式检查

后续待办:
- 无待办项,所有变更已完成

最后修订日期: 2026-01-14
=============================================================================
-->

# Lark Service 项目宪章

## 核心原则

### I. 核心技术栈要求

**强制要求**:
- 必须基于 **Python 3.X** 实现
- 必须采用官方 **lark-oapi SDK** 作为通讯底层
- 严禁自行实现基础调用逻辑,除非 SDK 功能缺失且有充分文档证明

**理由**: 统一技术栈确保长期维护性、安全更新及时性和团队协作效率。官方 SDK 由飞书维护,避免协议变更导致的兼容性风险。

---

### II. 代码质量门禁

**强制要求**:
- 代码必须达不低于 **99%** 的静态类型检查覆盖率 (mypy)
- 必须严格执行 **ruff** 格式化标准
- 所有 PR 必须通过质量门禁检查,无例外
- 所有公共函数、类和模块必须包含符合标准格式的 **Docstring**

**Docstring 标准格式**:
```python
def function_name(arg1: Type1, arg2: Type2) -> ReturnType:
    """
    Brief description in one line.
    
    Args:
    ----------
        arg1: Description of arg1
        arg2: Description of arg2
        
    Returns:
    ----------
        Description of return value
        
    Raises:
    ----------
        ExceptionType: When and why this exception is raised
        
    Example:
    ----------
        >>> result = function_name(value1, value2)
        >>> assert result is not None
    """
    pass
```

**Docstring 要求**:
- 必须包含简要描述(单行)
- 必须包含 `Args` 部分(如有参数)
- 必须包含 `Returns` 部分(如有返回值)
- 必须包含 `Raises` 部分(如抛出异常)
- 建议包含 `Example` 部分展示典型用法
- 使用英文编写,简洁明确
- 每个部分使用 `----------` 分隔线

**理由**: 静态类型检查在编译期捕获大量运行时错误,显著提升代码可靠性。统一格式化标准消除代码审查中的样式争议,聚焦业务逻辑审查。标准化的 Docstring 确保代码自文档化,提升可维护性和团队协作效率。

---

### III. 架构完整性 (非妥协)

**强制要求**:
- 坚持 **领域驱动的模块化设计** (DDD)
- 功能域模块 (如 Messaging、CloudDoc、Contact 等) 之间严禁出现 **循环依赖**
- 每个功能域必须具备清晰的边界和独立的职责
- 跨域交互必须通过明确定义的接口或事件进行

**理由**: 循环依赖会导致模块耦合、测试困难、重构风险高。领域驱动设计确保业务逻辑清晰映射到代码结构,提升可维护性和可扩展性。

---

### IV. 响应一致性

**强制要求**:
- 所有暴露给内部系统的接口必须返回 **标准化响应结构**
- 响应结构必须包含:
  - **业务状态码** (独立于 HTTP 状态码)
  - **请求 ID** (用于全链路追踪)
  - **语义化错误上下文** (包含错误类型、错误消息、可选的错误详情)
- 禁止直接抛出未处理的异常到接口层

**理由**: 统一响应格式简化客户端错误处理逻辑,请求 ID 支持分布式追踪和问题排查,语义化错误提升开发者体验。

---

### V. 安全性底线

**强制要求**:
- 凭证存储必须支持 **加密扩展** (如支持外部密钥管理服务)
- 应用服务的基础敏感配置 (App ID、App Secret等) 仅允许通过 **环境变量** 注入
- 严禁在代码、日志、配置文件中明文存储凭据
- 所有敏感操作必须记录审计日志

**理由**: 防止凭据泄露是安全的第一道防线。环境变量注入支持不同环境隔离,加密扩展为企业级安全需求预留接口。

---

### VI. 环境一致性

**强制要求**:
- 同一个项目环境必须 **物理隔离** 在单一目录内
- 支持合理的子目录分层 (如 src/、tests/、docs/、configs/)
- 不同环境 (开发、测试、生产) 的配置必须通过环境变量或配置文件切换
- 禁止在单一代码库中混合多个不兼容的虚拟环境

**理由**: 环境隔离避免依赖冲突和配置混淆。清晰的目录结构提升项目可读性和工具链集成体验。

---

### VII. 零信任安全 (非妥协)

**强制要求**:
- 敏感信息 (Secrets、Keys、Tokens) 必须通过 **.env** 文件管理
- **.env** 文件必须在 **.gitignore** 中排除,严禁提交到版本控制
- 严禁在代码中出现任何 **硬编码凭据**
- 生产环境建议使用外部密钥管理服务 (如 AWS Secrets Manager、HashiCorp Vault);如未使用,必须:
  - 通过安全的配置管理工具部署 (如 Ansible Vault、加密的配置仓库)
  - 实施严格的服务器访问控制
  - 定期轮换密钥
  - 记录所有密钥访问审计日志

**理由**: 零信任原则假设代码库可能被泄露。.env 管理开发环境密钥,生产环境需要更高级别的保护措施,但具体方案可根据项目规模和资源灵活选择,关键是确保密钥不进入版本控制且有访问审计。

---

### VIII. 测试先行 (非妥协)

**强制要求**:
- 必须先编写 **失败的单元测试**,再进行功能实现
- 严格遵循 **红-绿-重构** 循环:
  1. **红**: 编写测试,验证失败
  2. **绿**: 实现最小可行代码,使测试通过
  3. **重构**: 优化代码结构,保持测试通过
- 所有 PR 必须包含对应的测试代码
- 测试覆盖率目标: 关键业务逻辑 ≥ 90%

**理由**: 测试先行确保需求被正确理解,避免过度设计。失败测试验证测试有效性。TDD 提升代码可测试性和设计质量。

---

### IX. 文档语言规范

**强制要求**:

**代码层面 (必须英文)**:
- 变量命名、函数命名、类命名、模块命名 - 必须使用英文
- 代码注释、文档字符串 (docstring) - 必须使用英文
- 日志消息 - 必须使用英文 (便于日志分析和国际化)
- API 端点路径、参数名 - 必须使用英文

**文档层面 (使用中文)**:
- 需求文档、设计文档、API 使用文档
- README.md、CHANGELOG.md
- 代码审查评论、Issue 描述、PR 描述
- 项目计划、技术方案、架构设计文档

**理由**: 代码使用英文是国际惯例,便于代码复用、开源协作和技术交流。中文文档降低团队内部沟通成本,提升协作效率。明确分离两个层面,各取所长。

---

### X. 文件操作闭环 (非妥协)

**强制要求**:
- 所有文件创建、修改、检查操作必须形成 **闭环**
- 创建文件后,必须在 **同一文档/同一位置** 执行后续的检查和更新
- 严禁过度创建新文档,必须在原有文档上迭代改进
- 文档更新必须使用 **原地修改** (in-place update),而非创建新版本文件
- 验证和修正操作必须在原文件上完成,确保单一事实来源 (Single Source of Truth)

**具体实施**:
- ✅ **正确**: 创建 `spec.md` → 检查 `spec.md` → 更新 `spec.md` (闭环)
- ❌ **错误**: 创建 `spec.md` → 检查 `spec.md` → 创建 `spec_v2.md` (过度新建)
- ✅ **正确**: 发现问题 → 在原文件修复 → 重新验证原文件
- ❌ **错误**: 发现问题 → 创建 `fixes.md` 说明问题 → 原文件未更新

**适用场景**:
- 规范文档 (spec.md) 的创建、验证、修正
- 计划文档 (plan.md) 的创建、完善、更新
- 任务清单 (tasks.md) 的创建、检查、调整
- 代码文件的创建、测试、重构
- 配置文件的创建、验证、修改

**例外情况**:
- 版本归档 (如 `CHANGELOG.md` 记录历史版本)
- 备份文件 (明确标记为 `.backup` 或 `.old`)
- 临时工作文件 (必须在任务完成后删除)

**理由**: 文件闭环确保文档和代码的唯一性和一致性,避免信息分散和版本混乱。原地更新减少文件冗余,降低维护成本,确保团队始终使用最新、最准确的文件版本。

---

## 实施要求

### 强制检查点

每个功能开发必须通过以下检查:

1. **设计阶段**:
   - [ ] 技术栈符合原则 I
   - [ ] 模块依赖关系无循环 (原则 III)
   - [ ] 响应结构设计符合原则 IV
   - [ ] 设计文档遵循闭环操作 (原则 X)

2. **开发阶段**:
   - [ ] 测试先行完成 (原则 VIII)
   - [ ] 代码质量门禁通过 (原则 II)
   - [ ] 所有公共 API 包含标准 Docstring (原则 II)
   - [ ] 无硬编码凭据 (原则 VII)
   - [ ] 代码文件在原地迭代更新 (原则 X)

3. **代码审查阶段**:
   - [ ] 环境配置正确隔离 (原则 VI)
   - [ ] 敏感信息处理符合原则 V 和 VII
   - [ ] Docstring 格式符合标准 (原则 II)
   - [ ] 中文文档完整 (原则 IX)
   - [ ] 无冗余或重复文件 (原则 X)

### 复杂性豁免流程

如果某个设计需要违反非妥协原则 (III、VII、VIII、X),必须:

1. 在设计文档的 **Complexity Tracking** 章节中详细记录:
   - 违反的具体原则
   - 为何必须违反 (技术或业务约束)
   - 更简单方案为何不可行
   - 风险缓解措施

2. 获得技术负责人书面批准
3. 在代码中添加显著注释说明例外情况

---

## 治理规则

### 宪章修订流程

1. **提议**: 任何团队成员可提出修订建议,需包含:
   - 修订理由和背景
   - 影响范围评估
   - 迁移计划 (如有破坏性变更)

2. **审查**: 技术委员会审查提议,评估:
   - 是否与现有原则冲突
   - 实施可行性
   - 团队共识程度

3. **批准**: 需技术委员会 2/3 多数通过

4. **发布**: 更新宪章版本,通知全体成员,更新相关模板

### 版本控制策略

- **主版本 (MAJOR)**: 删除或重新定义原则,破坏性变更
- **次版本 (MINOR)**: 新增原则或重要章节
- **补丁版本 (PATCH)**: 澄清措辞、修正错误、非语义变更

### 合规审查

- 每个 PR 必须通过宪章合规检查
- 季度审查原则执行情况,识别系统性违规
- 年度回顾宪章有效性,评估是否需要修订

### 开发指导

运行时开发指导请参考:
- 功能规范: `/specs/[###-feature-name]/spec.md`
- 实施计划: `/specs/[###-feature-name]/plan.md`
- 任务清单: `/specs/[###-feature-name]/tasks.md`

---

**版本**: 1.1.0 | **批准日期**: 2026-01-14 | **最后修订**: 2026-01-14
