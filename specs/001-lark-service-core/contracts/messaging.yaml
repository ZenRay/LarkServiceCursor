openapi: 3.0.3
info:
  title: Lark Service - Messaging Module API
  description: |
    Messaging module API contract for Lark Service core component.
    Provides interfaces for sending text, rich text, images, files, and interactive cards.

    **Important**: This module wraps TWO Lark Open APIs:
    - **Messaging API (IM v1)**: For sending messages to users/groups
      - Official Doc: https://open.feishu.cn/document/server-docs/im-v1/introduction
    - **CardKit API (CardKit v1)**: For building interactive cards and handling callbacks
      - Official Doc: https://open.feishu.cn/document/cardkit-v1/feishu-card-resource-overview

    Message sending uses IM API, card building and callbacks use CardKit API.
  version: 1.0.0
  contact:
    name: Lark Service Team

servers:
  - url: http://localhost:8000/api/v1
    description: Local development
  - url: https://lark-service.internal/api/v1
    description: Production

tags:
  - name: messaging
    description: Message sending operations (uses IM v1 API)
  - name: media
    description: Image and file upload operations (uses IM v1 API)
  - name: card
    description: Interactive card operations (uses CardKit v1 API)
  - name: callback
    description: Card callback handling (uses CardKit v1 API)

paths:
  /messaging/text:
    post:
      tags:
        - messaging
      summary: Send text message
      operationId: sendTextMessage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TextMessageRequest'
      responses:
        '200':
          description: Message sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limited
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /messaging/image:
    post:
      tags:
        - messaging
      summary: Send image message
      operationId: sendImageMessage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ImageMessageRequest'
      responses:
        '200':
          description: Image message sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
        '400':
          description: Invalid request or image size exceeds 10MB
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /messaging/file:
    post:
      tags:
        - messaging
      summary: Send file message
      operationId: sendFileMessage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FileMessageRequest'
      responses:
        '200':
          description: File message sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
        '400':
          description: Invalid request or file size exceeds 30MB
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /messaging/card:
    post:
      tags:
        - messaging
        - card
      summary: Send interactive card (IM API sends, CardKit API builds)
      operationId: sendInteractiveCard
      description: |
        Send an interactive card message using IM v1 API (msg_type: interactive).
        Card content JSON is built by CardKit module.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CardMessageRequest'
      responses:
        '200':
          description: Interactive card sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
        '400':
          description: Invalid card configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /messaging/batch:
    post:
      tags:
        - messaging
      summary: Batch send messages
      operationId: batchSendMessages
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchMessageRequest'
      responses:
        '200':
          description: Batch send completed (includes individual results)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchSendResponse'

  /media/image/upload:
    post:
      tags:
        - media
      summary: Upload image
      operationId: uploadImage
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - app_id
                - image
              properties:
                app_id:
                  type: string
                  pattern: '^cli_[a-z0-9]{16}$'
                  description: Lark application ID
                image:
                  type: string
                  format: binary
                  description: Image file (max 10MB)
      responses:
        '200':
          description: Image uploaded successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/StandardResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/ImageAsset'
        '400':
          description: Invalid request (invalid app_id, unsupported image format)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '413':
          description: Image size exceeds 10MB limit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: 41301
                message: Image size exceeds maximum limit of 10MB
                request_id: req_xxxxx
                error:
                  type: FileSizeExceeded
                  details: "File size: 12582912 bytes, maximum: 10485760 bytes"

  /media/file/upload:
    post:
      tags:
        - media
      summary: Upload file
      operationId: uploadFile
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - app_id
                - file
              properties:
                app_id:
                  type: string
                  pattern: '^cli_[a-z0-9]{16}$'
                file:
                  type: string
                  format: binary
                  description: File (max 30MB)
      responses:
        '200':
          description: File uploaded successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/StandardResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/FileAsset'
        '400':
          description: Invalid request (invalid app_id, unsupported file format)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '413':
          description: File size exceeds 30MB limit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: 41302
                message: File size exceeds maximum limit of 30MB
                request_id: req_xxxxx
                error:
                  type: FileSizeExceeded
                  details: "File size: 35651584 bytes, maximum: 31457280 bytes"

  /callback/card:
    post:
      tags:
        - callback
        - card
      summary: Handle card callback (CardKit API, internal endpoint)
      operationId: handleCardCallback
      description: |
        Receives callbacks from Lark CardKit API when users interact with cards.
        This endpoint is called by Lark servers, not by internal clients.
        Implements signature verification and routes events to RabbitMQ.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CallbackEvent'
      responses:
        '200':
          description: Callback processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 0

components:
  schemas:
    TextMessageRequest:
      type: object
      required:
        - app_id
        - receiver_id
        - content
      properties:
        app_id:
          type: string
          pattern: '^cli_[a-z0-9]{16}$'
          description: Lark application ID
          example: cli_a1b2c3d4e5f6g7h8
        receiver_id:
          type: string
          minLength: 1
          description: User ID or chat ID
          example: ou_a1b2c3d4e5f6g7h8
        content:
          type: string
          minLength: 1
          description: Text message content
          example: 您有新的工单待处理

    ImageMessageRequest:
      type: object
      required:
        - app_id
        - receiver_id
        - image_key
      properties:
        app_id:
          type: string
          pattern: '^cli_[a-z0-9]{16}$'
        receiver_id:
          type: string
        image_key:
          type: string
          description: Image key from upload API
          example: img_v2_xxxxx

    FileMessageRequest:
      type: object
      required:
        - app_id
        - receiver_id
        - file_key
      properties:
        app_id:
          type: string
          pattern: '^cli_[a-z0-9]{16}$'
        receiver_id:
          type: string
        file_key:
          type: string
          description: File key from upload API
          example: file_v2_xxxxx

    CardMessageRequest:
      type: object
      required:
        - app_id
        - receiver_id
        - card_content
      properties:
        app_id:
          type: string
          pattern: '^cli_[a-z0-9]{16}$'
        receiver_id:
          type: string
        card_content:
          type: object
          description: Interactive card JSON structure
          example:
            header:
              title:
                tag: plain_text
                content: 审批通知
            elements:
              - tag: div
                text:
                  tag: lark_md
                  content: "**申请人**: 张三"
              - tag: action
                actions:
                  - tag: button
                    text:
                      tag: plain_text
                      content: 同意
                    type: primary
                    value: approve

    BatchMessageRequest:
      type: object
      required:
        - app_id
        - receiver_ids
        - msg_type
        - content
      properties:
        app_id:
          type: string
        receiver_ids:
          type: array
          items:
            type: string
          minItems: 1
          maxItems: 200
        msg_type:
          type: string
          enum: [text, post, image, file]
        content:
          type: object

    StandardResponse:
      type: object
      required:
        - code
        - message
        - request_id
      properties:
        code:
          type: integer
          description: Business status code (0 = success)
          example: 0
        message:
          type: string
          description: Human-readable message
          example: Success
        request_id:
          type: string
          description: Unique request ID for tracing
          example: req_a1b2c3d4e5f6g7h8
        data:
          type: object
          description: Response payload

    ErrorResponse:
      type: object
      required:
        - code
        - message
        - request_id
      properties:
        code:
          type: integer
          description: Error code
          example: 40001
        message:
          type: string
          example: Invalid app_id format
        request_id:
          type: string
        error:
          type: object
          properties:
            type:
              type: string
              example: InvalidParameter
            details:
              type: string
              example: app_id must match pattern cli_[a-z0-9]{16}

    BatchSendResponse:
      allOf:
        - $ref: '#/components/schemas/StandardResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                total:
                  type: integer
                  example: 5
                success:
                  type: integer
                  example: 4
                failed:
                  type: integer
                  example: 1
                results:
                  type: array
                  items:
                    type: object
                    properties:
                      receiver_id:
                        type: string
                      status:
                        type: string
                        enum: [success, failed]
                      message_id:
                        type: string
                      error:
                        type: string

    ImageAsset:
      type: object
      required:
        - image_key
        - file_size
      properties:
        image_key:
          type: string
          pattern: '^img_v2_[a-zA-Z0-9_-]+$'
          description: Image key (valid for 30 days)
          example: img_v2_xxxxx
        image_type:
          type: string
          example: message
        file_size:
          type: integer
          description: File size in bytes
          example: 1048576
        upload_time:
          type: string
          format: date-time
          description: Upload timestamp (ISO 8601)
          example: '2026-01-15T10:30:00Z'

    FileAsset:
      type: object
      required:
        - file_key
        - file_name
        - file_size
      properties:
        file_key:
          type: string
          pattern: '^file_v2_[a-zA-Z0-9_-]+$'
          description: File key (valid for 30 days)
          example: file_v2_xxxxx
        file_name:
          type: string
          example: report.pdf
        file_type:
          type: string
          example: application/pdf
        file_size:
          type: integer
          description: File size in bytes
          example: 2097152
        upload_time:
          type: string
          format: date-time
          description: Upload timestamp (ISO 8601)
          example: '2026-01-15T10:30:00Z'

    CallbackEvent:
      type: object
      required:
        - event_type
        - app_id
        - user_id
      properties:
        event_type:
          type: string
          example: card.action.trigger
        app_id:
          type: string
        card_id:
          type: string
        user_id:
          type: string
        action:
          type: object
        signature:
          type: string
        timestamp:
          type: string
          format: date-time

  # ==================== Examples ====================
  examples:
    TextMessageExample:
      summary: Text message request example
      value:
        app_id: cli_a1b2c3d4e5f6g7h8
        receiver_id: ou_a1b2c3d4e5f6g7h8
        content: 您有新的工单待处理

    ErrorResponseExample:
      summary: Error response example
      value:
        code: 40001
        message: Invalid app_id format
        request_id: req_a1b2c3d4e5f6g7h8
        error:
          type: InvalidParameter
          details: app_id must match pattern cli_[a-z0-9]{16}

    EmptyContentErrorExample:
      summary: Empty content error response
      value:
        code: 40002
        message: Message content cannot be empty
        request_id: req_b2c3d4e5f6g7h8i9
        error:
          type: InvalidParameter
          details: "Parameter 'content' must not be empty"

    ReceiverNotFoundErrorExample:
      summary: Receiver not found error response
      value:
        code: 40003
        message: "Receiver not found: ou_invalid123456"
        request_id: req_c3d4e5f6g7h8i9j0
        error:
          type: ReceiverNotFound
          details: "The specified receiver_id does not exist or is not accessible"

    PermissionDeniedErrorExample:
      summary: Permission denied error response
      value:
        code: 40301
        message: Permission denied user cannot receive messages
        request_id: req_d4e5f6g7h8i9j0k1
        error:
          type: PermissionDenied
          details: "User has blocked the bot or does not have permission to receive messages"

    InvalidMediaKeyErrorExample:
      summary: Invalid media key error response
      value:
        code: 40004
        message: "Invalid media key: img_v2_expired123 (expired or not found)"
        request_id: req_e5f6g7h8i9j0k1l2
        error:
          type: InvalidMediaKey
          details: "The image_key/file_key is expired (>30 days) or does not exist"

    RateLimitErrorExample:
      summary: Rate limit error response with retry-after
      value:
        code: 42901
        message: Rate limit exceeded
        request_id: req_f6g7h8i9j0k1l2m3
        error:
          type: RateLimitExceeded
          details: "API rate limit exceeded. Retry after 30 seconds"
          retry_after: 30

    CardMessageExample:
      summary: Interactive card message example
      value:
        app_id: cli_a1b2c3d4e5f6g7h8
        receiver_id: ou_a1b2c3d4e5f6g7h8
        card:
          header:
            title:
              tag: plain_text
              content: 审批申请
          elements:
            - tag: div
              text:
                tag: markdown
                content: "**申请人**: 张三\n**申请事项**: 请假申请\n**时间**: 2026-01-15"
            - tag: action
              actions:
                - tag: button
                  text:
                    tag: plain_text
                    content: 同意
                  value: approve
                  type: primary
                - tag: button
                  text:
                    tag: plain_text
                    content: 拒绝
                  value: reject
                  type: danger
