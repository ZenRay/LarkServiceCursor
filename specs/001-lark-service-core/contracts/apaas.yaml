openapi: 3.0.3
info:
  title: Lark Service - aPaaS Module API
  description: |
    飞书 aPaaS 平台服务模块 API 契约,提供数据空间表格 CRUD、AI 能力调用、工作流触发。

    核心特性:
    - 数据空间表格操作 (查询/更新/删除记录)
    - 并发写冲突检测 (版本控制)
    - AI 能力调用 (需要 user_access_token)
    - 自动化工作流触发 (需要 user_access_token)
    - 超时控制 (AI 调用默认 30秒超时)

    权限要求:
    所有 aPaaS 操作均需要 user_access_token (用户级权限)。
  version: 0.1.0
  contact:
    name: Internal Platform Team

servers:
  - url: http://localhost:8000/api/v1
    description: Local development server

tags:
  - name: Workspace
    description: 工作空间与数据表管理
  - name: DataSpace
    description: 数据空间表格 CRUD 操作
  - name: AI
    description: AI 能力调用
  - name: Workflow
    description: 自动化工作流

paths:
  /apaas/workspaces/{workspace_id}/tables:
    get:
      summary: 查询工作空间下的数据表列表
      description: |
        获取指定工作空间的所有数据表,包含表格 ID、名称、字段定义。
      tags:
        - Workspace
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
        - name: user_access_token
          in: header
          required: true
          description: 用户访问令牌
          schema:
            type: string
        - name: workspace_id
          in: path
          required: true
          description: 工作空间 ID
          schema:
            type: string
            example: "ws_a1b2c3d4e5f6g7h8"
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkspaceTablesResponse'
        '404':
          description: 工作空间不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "WORKSPACE_NOT_FOUND"
                message: "工作空间不存在,可用工作空间列表: ws_001, ws_002"
                request_id: "req_1234567890"
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "PERMISSION_DENIED"
                message: "user_access_token 权限不足,无法访问数据空间。需要权限: apaas:workspace:read"
                request_id: "req_1234567890"

  /apaas/tables/{table_id}/records:
    get:
      summary: 查询数据表记录
      description: |
        根据条件查询数据空间表格的记录,支持过滤、排序、分页。
      tags:
        - DataSpace
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
        - name: user_access_token
          in: header
          required: true
          schema:
            type: string
        - name: table_id
          in: path
          required: true
          description: 数据表 ID
          schema:
            type: string
            example: "tbl_a1b2c3d4e5f6g7h8"
        - name: filter
          in: query
          description: 过滤条件 (JSON 格式)
          schema:
            type: string
            example: '{"status": "active", "age": {"$gt": 18}}'
        - name: sort
          in: query
          description: 排序字段 (如 "created_at desc")
          schema:
            type: string
            example: "created_at desc"
        - name: page_size
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: page_token
          in: query
          schema:
            type: string
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TableRecordsResponse'
        '404':
          description: 数据表不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /apaas/tables/{table_id}/records/{record_id}:
    patch:
      summary: 更新数据表记录
      description: |
        更新数据空间表格的单条记录,支持部分字段更新和版本冲突检测。
      tags:
        - DataSpace
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
        - name: user_access_token
          in: header
          required: true
          schema:
            type: string
        - name: table_id
          in: path
          required: true
          schema:
            type: string
        - name: record_id
          in: path
          required: true
          description: 记录 ID
          schema:
            type: string
            example: "rec_a1b2c3d4e5f6g7h8"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - fields
              properties:
                fields:
                  type: object
                  description: 要更新的字段键值对
                  additionalProperties: true
                  example:
                    name: "新名称"
                    status: "completed"
                    updated_by: "张三"
                version:
                  type: integer
                  description: 记录版本号 (用于并发控制,可选)
                  example: 5
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TableRecordResponse'
        '409':
          description: 版本冲突
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "VERSION_CONFLICT"
                message: "并发写冲突,记录已被其他请求更新。建议重新读取后再更新。当前版本: 6"
                request_id: "req_1234567890"
                error_details:
                  current_version: 6
                  provided_version: 5
        '413':
          description: 配额已满
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "QUOTA_EXCEEDED"
                message: "工作空间存储配额已满,无法创建新记录。建议清理历史数据。"
                request_id: "req_1234567890"

    delete:
      summary: 删除数据表记录
      tags:
        - DataSpace
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
        - name: user_access_token
          in: header
          required: true
          schema:
            type: string
        - name: table_id
          in: path
          required: true
          schema:
            type: string
        - name: record_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 删除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
        '404':
          description: 记录不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /apaas/ai/invoke:
    post:
      summary: 调用 AI 能力
      description: |
        调用飞书 AI 能力 (如文本分析、智能问答等)。

        注意事项:
        - 需要 user_access_token
        - 默认超时时间 30 秒
        - 超时后返回超时错误
      tags:
        - AI
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
        - name: user_access_token
          in: header
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - capability_id
                - input
              properties:
                capability_id:
                  type: string
                  description: AI 能力 ID
                  example: "ai_text_analysis_v1"
                input:
                  type: object
                  description: 输入参数 (根据能力类型而定)
                  additionalProperties: true
                  example:
                    text: "这是一段需要分析的文本"
                    language: "zh-CN"
                timeout:
                  type: integer
                  description: 超时时间 (秒),默认 30 秒
                  default: 30
                  minimum: 1
                  maximum: 60
      responses:
        '200':
          description: 调用成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIInvokeResponse'
        '408':
          description: AI 调用超时
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "AI_TIMEOUT"
                message: "AI 能力调用超过 30 秒未返回,已主动超时"
                request_id: "req_1234567890"

  /apaas/workflows/{workflow_id}/trigger:
    post:
      summary: 触发自动化工作流
      description: |
        触发飞书自动化工作流,传入参数并返回执行 ID。
      tags:
        - Workflow
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
        - name: user_access_token
          in: header
          required: true
          schema:
            type: string
        - name: workflow_id
          in: path
          required: true
          description: 工作流 ID
          schema:
            type: string
            example: "wf_a1b2c3d4e5f6g7h8"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                input_params:
                  type: object
                  description: 工作流输入参数
                  additionalProperties: true
                  example:
                    user_id: "ou_user123"
                    action: "approve"
                    comment: "已审批"
      responses:
        '200':
          description: 触发成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowTriggerResponse'
        '404':
          description: 工作流不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "WORKFLOW_NOT_FOUND"
                message: "工作流不存在或参数错误,请检查 workflow_id 和参数格式"
                request_id: "req_1234567890"

  /apaas/workflows/executions/{execution_id}:
    get:
      summary: 查询工作流执行状态
      tags:
        - Workflow
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
        - name: user_access_token
          in: header
          required: true
          schema:
            type: string
        - name: execution_id
          in: path
          required: true
          description: 执行 ID
          schema:
            type: string
            example: "exec_a1b2c3d4e5f6g7h8"
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowExecutionResponse'

components:
  schemas:
    WorkspaceTablesResponse:
      type: object
      required:
        - code
        - request_id
        - data
      properties:
        code:
          type: string
          example: "OK"
        message:
          type: string
        request_id:
          type: string
        data:
          type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/WorkspaceTable'

    WorkspaceTable:
      type: object
      required:
        - table_id
        - name
      properties:
        table_id:
          type: string
          example: "tbl_a1b2c3d4e5f6g7h8"
        workspace_id:
          type: string
          example: "ws_a1b2c3d4e5f6g7h8"
        name:
          type: string
          example: "客户信息表"
        description:
          type: string
        fields:
          type: array
          items:
            $ref: '#/components/schemas/FieldDefinition'
        record_count:
          type: integer
          example: 1234

    FieldDefinition:
      type: object
      required:
        - field_id
        - name
        - type
      properties:
        field_id:
          type: string
          example: "fld_name"
        name:
          type: string
          example: "客户名称"
        type:
          type: string
          enum:
            - text
            - number
            - date
            - datetime
            - select
            - multi_select
            - user
          example: "text"
        description:
          type: string

    TableRecordsResponse:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        request_id:
          type: string
        data:
          type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/TableRecord'
            has_more:
              type: boolean
            page_token:
              type: string
            total:
              type: integer
              description: 总记录数 (如果支持)

    TableRecordResponse:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        request_id:
          type: string
        data:
          $ref: '#/components/schemas/TableRecord'

    TableRecord:
      type: object
      required:
        - record_id
        - fields
      properties:
        record_id:
          type: string
          example: "rec_a1b2c3d4e5f6g7h8"
        table_id:
          type: string
          example: "tbl_a1b2c3d4e5f6g7h8"
        fields:
          type: object
          description: 字段键值对
          additionalProperties: true
          example:
            name: "客户A"
            status: "active"
            created_at: "2026-01-14T10:00:00Z"
        version:
          type: integer
          description: 记录版本号 (用于并发控制)
          example: 5
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    AIInvokeResponse:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        request_id:
          type: string
        data:
          type: object
          properties:
            capability_id:
              type: string
            output:
              type: object
              description: AI 能力输出结果
              additionalProperties: true
              example:
                sentiment: "positive"
                keywords: ["产品", "优秀", "推荐"]
                confidence: 0.95
            execution_time_ms:
              type: integer
              description: 执行耗时 (毫秒)
              example: 1234

    WorkflowTriggerResponse:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        request_id:
          type: string
        data:
          type: object
          properties:
            execution_id:
              type: string
              description: 工作流执行 ID
              example: "exec_a1b2c3d4e5f6g7h8"
            workflow_id:
              type: string
            status:
              type: string
              enum:
                - pending
                - running
                - completed
                - failed
              example: "running"
            triggered_at:
              type: string
              format: date-time

    WorkflowExecutionResponse:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        request_id:
          type: string
        data:
          type: object
          properties:
            execution_id:
              type: string
            workflow_id:
              type: string
            status:
              type: string
              enum:
                - pending
                - running
                - completed
                - failed
                - timeout
            output:
              type: object
              description: 工作流输出结果
              additionalProperties: true
            error_message:
              type: string
              description: 错误信息 (失败时)
            started_at:
              type: string
              format: date-time
            completed_at:
              type: string
              format: date-time

    StandardResponse:
      type: object
      required:
        - code
        - request_id
      properties:
        code:
          type: string
          example: "OK"
        message:
          type: string
          example: "操作成功"
        request_id:
          type: string

    ErrorResponse:
      type: object
      required:
        - code
        - message
        - request_id
      properties:
        code:
          type: string
          enum:
            - WORKSPACE_NOT_FOUND
            - TABLE_NOT_FOUND
            - RECORD_NOT_FOUND
            - WORKFLOW_NOT_FOUND
            - PERMISSION_DENIED
            - VERSION_CONFLICT
            - QUOTA_EXCEEDED
            - AI_TIMEOUT
            - INVALID_PARAMETER
            - TOKEN_EXPIRED
            - RATE_LIMITED
            - INTERNAL_ERROR
        message:
          type: string
        request_id:
          type: string
        error_details:
          type: object
          additionalProperties: true
