openapi: 3.0.3
info:
  title: Lark Service - aPaaS Data Space Module API
  description: |
    飞书 aPaaS 数据空间服务模块 API 契约,提供数据空间表格 CRUD 操作。

    核心特性:
    - 数据空间表格操作 (查询/创建/更新/删除记录)
    - 批量操作 (批量创建/批量更新)
    - 字段定义查询
    - 分页查询 (page_token 机制)
    - 过滤查询

    能力范围:
    - ✅ 包含: 数据空间表格(workspace-table)的 CRUD 操作
    - ❌ 不包含: AI 能力调用、工作流触发(不在 aPaaS 数据平台范畴)

    权限要求:
    所有 aPaaS 操作均需要 user_access_token (用户级权限)。

    参考文档:
    https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/apaas-v1/workspace-table/list
  version: 0.2.0
  contact:
    name: Internal Platform Team

servers:
  - url: http://localhost:8000/api/v1
    description: Local development server

tags:
  - name: Workspace
    description: 工作空间与数据表管理
  - name: DataSpace
    description: 数据空间表格 CRUD 操作
  - name: Fields
    description: 字段定义查询

paths:
  /apaas/workspaces/{workspace_id}/tables:
    get:
      summary: 查询工作空间下的数据表列表
      description: |
        获取指定工作空间的所有数据表,包含表格 ID、名称、字段定义。
      tags:
        - Workspace
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
        - name: user_access_token
          in: header
          required: true
          description: 用户访问令牌
          schema:
            type: string
        - name: workspace_id
          in: path
          required: true
          description: 工作空间 ID
          schema:
            type: string
            example: "ws_a1b2c3d4e5f6g7h8"
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkspaceTablesResponse'
        '404':
          description: 工作空间不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "WORKSPACE_NOT_FOUND"
                message: "工作空间不存在,可用工作空间列表: ws_001, ws_002"
                request_id: "req_1234567890"
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "PERMISSION_DENIED"
                message: "user_access_token 权限不足,无法访问数据空间。需要权限: apaas:workspace:read"
                request_id: "req_1234567890"

  /apaas/tables/{table_id}/fields:
    get:
      summary: 查询数据表的字段定义
      description: |
        获取指定数据表的所有字段定义,包含字段 ID、名称、类型、选项等。
      tags:
        - Fields
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
        - name: user_access_token
          in: header
          required: true
          schema:
            type: string
        - name: table_id
          in: path
          required: true
          description: 数据表 ID
          schema:
            type: string
            example: "tbl_a1b2c3d4e5f6g7h8"
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FieldDefinitionsResponse'
        '404':
          description: 数据表不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /apaas/tables/{table_id}/records:
    get:
      summary: 查询数据表记录
      description: |
        根据条件查询数据空间表格的记录,支持过滤、分页。
      tags:
        - DataSpace
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
        - name: user_access_token
          in: header
          required: true
          schema:
            type: string
        - name: table_id
          in: path
          required: true
          description: 数据表 ID
          schema:
            type: string
            example: "tbl_a1b2c3d4e5f6g7h8"
        - name: page_token
          in: query
          required: false
          description: 分页标记,首次请求不填
          schema:
            type: string
        - name: page_size
          in: query
          required: false
          description: 分页大小,默认 20,最大 500
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 500
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                filter:
                  type: object
                  description: 过滤条件
                  properties:
                    conjunction:
                      type: string
                      enum: [and, or]
                      default: and
                    conditions:
                      type: array
                      items:
                        type: object
                        required:
                          - field_name
                          - operator
                          - value
                        properties:
                          field_name:
                            type: string
                          operator:
                            type: string
                            enum: [is, is_not, contains, does_not_contain, is_empty, is_not_empty, is_greater, is_greater_or_equal, is_less, is_less_or_equal]
                          value:
                            description: 值 (类型根据字段类型而定)
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TableRecordsResponse'
        '404':
          description: 数据表不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      summary: 创建数据表记录
      description: |
        在指定数据表中创建一条新记录。
      tags:
        - DataSpace
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
        - name: user_access_token
          in: header
          required: true
          schema:
            type: string
        - name: table_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - fields
              properties:
                fields:
                  type: object
                  description: 字段值映射 (field_name -> value)
                  additionalProperties: true
                  example:
                    Name: "张三"
                    Age: 30
                    Email: "zhangsan@example.com"
      responses:
        '200':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TableRecordResponse'
        '400':
          description: 参数错误 (必填字段缺失、字段类型不匹配等)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /apaas/tables/{table_id}/records/batch:
    post:
      summary: 批量创建数据表记录
      description: |
        在指定数据表中批量创建多条记录。
      tags:
        - DataSpace
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
        - name: user_access_token
          in: header
          required: true
          schema:
            type: string
        - name: table_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - records
              properties:
                records:
                  type: array
                  description: 记录列表
                  maxItems: 500
                  items:
                    type: object
                    required:
                      - fields
                    properties:
                      fields:
                        type: object
                        additionalProperties: true
      responses:
        '200':
          description: 批量创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchRecordsResponse'

    put:
      summary: 批量更新数据表记录
      description: |
        批量更新指定数据表中的多条记录。
      tags:
        - DataSpace
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
        - name: user_access_token
          in: header
          required: true
          schema:
            type: string
        - name: table_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - records
              properties:
                records:
                  type: array
                  description: 记录列表
                  maxItems: 500
                  items:
                    type: object
                    required:
                      - record_id
                      - fields
                    properties:
                      record_id:
                        type: string
                      fields:
                        type: object
                        additionalProperties: true
      responses:
        '200':
          description: 批量更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchRecordsResponse'

  /apaas/tables/{table_id}/records/{record_id}:
    get:
      summary: 查询单条记录
      tags:
        - DataSpace
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
        - name: user_access_token
          in: header
          required: true
          schema:
            type: string
        - name: table_id
          in: path
          required: true
          schema:
            type: string
        - name: record_id
          in: path
          required: true
          description: 记录 ID
          schema:
            type: string
            example: "rec_a1b2c3d4e5f6g7h8"
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TableRecordResponse'
        '404':
          description: 记录不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      summary: 更新数据表记录
      description: |
        更新指定记录,支持部分字段更新。
      tags:
        - DataSpace
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
        - name: user_access_token
          in: header
          required: true
          schema:
            type: string
        - name: table_id
          in: path
          required: true
          schema:
            type: string
        - name: record_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - fields
              properties:
                fields:
                  type: object
                  description: 需要更新的字段 (支持部分更新)
                  additionalProperties: true
                  example:
                    Status: "已完成"
                    UpdatedBy: "ou_user123"
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TableRecordResponse'
        '404':
          description: 记录不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: 并发冲突 (如果支持版本控制)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "CONFLICT"
                message: "记录已被其他用户修改,请刷新后重试"
                request_id: "req_1234567890"

    delete:
      summary: 删除数据表记录
      tags:
        - DataSpace
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
        - name: user_access_token
          in: header
          required: true
          schema:
            type: string
        - name: table_id
          in: path
          required: true
          schema:
            type: string
        - name: record_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 删除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
        '404':
          description: 记录不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    WorkspaceTablesResponse:
      type: object
      required:
        - code
        - request_id
        - data
      properties:
        code:
          type: string
          example: "OK"
        message:
          type: string
        request_id:
          type: string
        data:
          type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/WorkspaceTable'

    WorkspaceTable:
      type: object
      required:
        - table_id
        - name
      properties:
        table_id:
          type: string
          example: "tbl_a1b2c3d4e5f6g7h8"
        workspace_id:
          type: string
          example: "ws_a1b2c3d4e5f6g7h8"
        name:
          type: string
          example: "客户信息表"
        description:
          type: string
          example: "存储客户基本信息和联系方式"
        field_count:
          type: integer
          description: 字段数量
          example: 10

    FieldDefinitionsResponse:
      type: object
      required:
        - code
        - request_id
        - data
      properties:
        code:
          type: string
          example: "OK"
        message:
          type: string
        request_id:
          type: string
        data:
          type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/FieldDefinition'

    FieldDefinition:
      type: object
      required:
        - field_id
        - field_name
        - field_type
      properties:
        field_id:
          type: string
          example: "fld_a1b2c3d4e5f6g7h8"
        field_name:
          type: string
          example: "客户名称"
        field_type:
          type: string
          enum:
            - text
            - number
            - single_select
            - multi_select
            - date
            - datetime
            - checkbox
            - person
            - phone
            - email
            - url
            - attachment
            - link
            - formula
            - lookup
          example: "text"
        is_required:
          type: boolean
          description: 是否必填
          default: false
        description:
          type: string
          example: "客户的公司名称或个人姓名"
        options:
          type: array
          description: 选项列表 (仅 single_select 和 multi_select 类型)
          items:
            type: object
            properties:
              id:
                type: string
              name:
                type: string
              color:
                type: string
          example:
            - id: "opt_1"
              name: "重要客户"
              color: "red"
            - id: "opt_2"
              name: "普通客户"
              color: "blue"

    TableRecordsResponse:
      type: object
      required:
        - code
        - request_id
        - data
      properties:
        code:
          type: string
          example: "OK"
        message:
          type: string
        request_id:
          type: string
        data:
          type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/TableRecord'
            has_more:
              type: boolean
              description: 是否有更多数据
            page_token:
              type: string
              description: 下一页标记

    TableRecordResponse:
      type: object
      required:
        - code
        - request_id
        - data
      properties:
        code:
          type: string
          example: "OK"
        message:
          type: string
        request_id:
          type: string
        data:
          $ref: '#/components/schemas/TableRecord'

    TableRecord:
      type: object
      required:
        - record_id
        - fields
      properties:
        record_id:
          type: string
          example: "rec_a1b2c3d4e5f6g7h8"
        table_id:
          type: string
          example: "tbl_a1b2c3d4e5f6g7h8"
        fields:
          type: object
          description: 字段值映射 (field_name -> value)
          additionalProperties: true
          example:
            Name: "张三"
            Age: 30
            Email: "zhangsan@example.com"
            Status: "活跃"
            CreatedAt: "2024-01-15T10:30:00Z"
        created_time:
          type: string
          format: date-time
          description: 创建时间 (ISO 8601)
          example: "2024-01-15T10:30:00Z"
        modified_time:
          type: string
          format: date-time
          description: 修改时间 (ISO 8601)
          example: "2024-01-16T14:20:00Z"
        created_by:
          type: object
          description: 创建人
          properties:
            id:
              type: string
            name:
              type: string
        modified_by:
          type: object
          description: 修改人
          properties:
            id:
              type: string
            name:
              type: string

    BatchRecordsResponse:
      type: object
      required:
        - code
        - request_id
        - data
      properties:
        code:
          type: string
          example: "OK"
        message:
          type: string
        request_id:
          type: string
        data:
          type: object
          properties:
            records:
              type: array
              description: 操作结果列表
              items:
                type: object
                properties:
                  record_id:
                    type: string
                  success:
                    type: boolean
                  error:
                    type: string
                    description: 错误信息 (仅失败时)

    StandardResponse:
      type: object
      required:
        - code
        - request_id
      properties:
        code:
          type: string
          example: "OK"
        message:
          type: string
          example: "操作成功"
        request_id:
          type: string
          example: "req_1234567890"

    ErrorResponse:
      type: object
      required:
        - code
        - message
        - request_id
      properties:
        code:
          type: string
          description: 错误码
          example: "INVALID_PARAMETER"
        message:
          type: string
          description: 错误描述
          example: "参数 table_id 格式错误"
        request_id:
          type: string
          description: 请求 ID,用于问题追踪
          example: "req_1234567890"
        details:
          type: object
          description: 错误详情 (可选)
          additionalProperties: true
