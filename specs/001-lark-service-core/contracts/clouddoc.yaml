openapi: 3.0.0
info:
  title: CloudDoc API Contract
  version: 1.0.0
  description: |
    飞书云文档 API 契约定义
    包含 Doc 文档、Bitable 多维表格、Sheet 电子表格、媒体管理等功能

servers:
  - url: https://open.feishu.cn/open-apis
    description: 飞书开放平台

components:
  schemas:
    # ==================== Wiki 知识库相关 ====================
    WikiNode:
      type: object
      required:
        - space_id
        - node_token
        - obj_token
        - obj_type
        - node_type
        - has_child
        - title
      properties:
        space_id:
          type: string
          pattern: '^[0-9]+$'
          description: 知识空间 ID
        node_token:
          type: string
          pattern: '^[a-zA-Z0-9_-]+$'
          description: 节点 token
        obj_token:
          type: string
          description: 实际的文档 token
        obj_type:
          type: string
          enum: [doc, docx, sheet, mindnote, bitable, file]
          description: 文档类型
        parent_node_token:
          type: string
          description: 父节点 token
          nullable: true
        node_type:
          type: string
          enum: [origin, shortcut]
          description: 节点类型 (原始节点或快捷方式)
        origin_node_token:
          type: string
          description: 快捷方式指向的原始节点 token
          nullable: true
        has_child:
          type: boolean
          description: 是否有子节点
        title:
          type: string
          description: 节点标题
        obj_create_time:
          type: integer
          format: int64
          description: 文档创建时间 (Unix timestamp)
        obj_edit_time:
          type: integer
          format: int64
          description: 文档编辑时间
        node_create_time:
          type: integer
          format: int64
          description: 节点创建时间
        creator:
          type: string
          description: 创建者 open_id
        owner:
          type: string
          description: 所有者 open_id

    WikiSpace:
      type: object
      required:
        - space_id
        - name
        - space_type
        - visibility
      properties:
        space_id:
          type: string
          pattern: '^[0-9]+$'
          description: 知识空间 ID
        name:
          type: string
          description: 空间名称
        description:
          type: string
          description: 空间描述
          nullable: true
        space_type:
          type: string
          enum: [team, personal]
          description: 空间类型
        visibility:
          type: string
          enum: [public, private]
          description: 可见性

    # ==================== Document 相关 ====================
    Document:
      type: object
      required:
        - doc_id
        - title
      properties:
        doc_id:
          type: string
          pattern: '^(doxcn|doccn)[a-zA-Z0-9]{20,}$'
          description: 文档 ID (doxcn 或 doccn 开头,后跟 20+ 字符)
          example: doxcn1234567890abcdefghij
        title:
          type: string
          minLength: 1
          maxLength: 255
          description: 文档标题
        folder_id:
          type: string
          pattern: '^fld_[a-zA-Z0-9]{16}$'
          description: 所属文件夹 ID
          nullable: true
        owner_id:
          type: string
          pattern: '^ou_[a-zA-Z0-9]{16,32}$'
          description: 文档所有者 open_id
          nullable: true
        create_time:
          type: string
          format: date-time
          description: 创建时间
          nullable: true
        update_time:
          type: string
          format: date-time
          description: 更新时间
          nullable: true
        url:
          type: string
          format: uri
          description: 文档访问链接
        block_count:
          type: integer
          minimum: 0
          description: 文档 block 总数

    ContentBlock:
      type: object
      required:
        - type
        - content
      properties:
        block_id:
          type: string
          pattern: '^[a-zA-Z0-9_-]{20,}$'
          description: Block ID (更新时需要,20+ 字符)
        type:
          type: string
          enum: [paragraph, heading, image, table, code, list, divider]
          description: Block 类型
        content:
          oneOf:
            - type: string
            - type: object
          description: Block 内容 (根据 type 不同而不同)
        attributes:
          type: object
          description: Block 属性
          properties:
            style:
              type: string
              enum: [normal, bold, italic, underline]
            level:
              type: integer
              minimum: 1
              maximum: 6
              description: 标题级别 (仅 heading 类型)
            language:
              type: string
              description: 代码语言 (仅 code 类型)

    # ==================== Bitable 相关 ====================
    BaseRecord:
      type: object
      required:
        - fields
      properties:
        record_id:
          type: string
          pattern: '^rec[a-zA-Z0-9]{20,}$'
          nullable: true
          description: 记录 ID
        fields:
          type: object
          additionalProperties: true
          description: 字段键值对
        created_by:
          type: string
          description: 创建者 ID
        created_time:
          type: integer
          format: int64
          description: 创建时间 (Unix timestamp)
        last_modified_by:
          type: string
          description: 最后修改者 ID
        last_modified_time:
          type: integer
          format: int64
          description: 最后修改时间 (Unix timestamp)

    QueryFilter:
      type: object
      required:
        - conjunction
        - conditions
      properties:
        conjunction:
          type: string
          enum: [and, or]
          description: 多条件连接方式
        conditions:
          type: array
          items:
            $ref: '#/components/schemas/FilterCondition'
          minItems: 1
          maxItems: 20

    FilterCondition:
      type: object
      required:
        - field_name
        - operator
        - value
      properties:
        field_name:
          type: string
          description: 字段名称
        operator:
          type: string
          enum: [is, is_not, contains, not_contains, gt, lt, gte, lte, is_empty, is_not_empty]
          description: 操作符
        value:
          description: 比较值 (is_empty/is_not_empty 时可为 null)
          nullable: true

    PaginationParams:
      type: object
      properties:
        page_size:
          type: integer
          minimum: 1
          maximum: 500
          default: 100
          description: 每页记录数
        page_token:
          type: string
          description: 分页标记
        sort:
          type: array
          items:
            type: object
            required:
              - field_name
            properties:
              field_name:
                type: string
              desc:
                type: boolean
                default: false

    # ==================== Sheet 相关 ====================
    SheetRange:
      type: object
      required:
        - range
      properties:
        range:
          type: string
          pattern: '^([A-Z]+[0-9]+:[A-Z]+[0-9]+|[A-Z]+:[A-Z]+|[0-9]+:[0-9]+|[A-Z]+[0-9]+)$'
          description: |
            范围表示法:
            - A1:B10 (单元格范围)
            - A:C (整列)
            - 3:5 (整行)
            - A1 (单个单元格)
          example: A1:B10
        sheet_name:
          type: string
          description: Sheet 名称 (跨 sheet 时需要)

    CellValue:
      oneOf:
        - type: string
        - type: number
        - type: boolean
        - type: 'null'
      description: 单元格值

    CellFormat:
      type: object
      properties:
        font:
          type: object
          properties:
            size:
              type: integer
              minimum: 8
              maximum: 72
            bold:
              type: boolean
            italic:
              type: boolean
            color:
              type: string
              pattern: '^#[0-9A-Fa-f]{6}$'
        background_color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
        alignment:
          type: string
          enum: [left, center, right, justify]

    # ==================== Media 相关 ====================
    MediaAsset:
      type: object
      required:
        - file_token
        - file_type
        - size
      properties:
        file_token:
          type: string
          pattern: '^file_v2_[a-zA-Z0-9]{32}$'
          description: 文件 token
        file_name:
          type: string
          maxLength: 255
          description: 文件名
        file_type:
          type: string
          description: 文件类型
        size:
          type: integer
          minimum: 1
          maximum: 31457280
          description: 文件大小 (字节)
        url:
          type: string
          format: uri
          description: 文件下载链接

    # ==================== Permission 相关 ====================
    Permission:
      type: object
      required:
        - member_type
        - permission
      properties:
        member_type:
          type: string
          enum: [user, department, group, anyone]
          description: 成员类型
        member_id:
          type: string
          description: 成员 ID (anyone 时为 null)
          nullable: true
        member_name:
          type: string
          description: 成员名称
        permission:
          type: string
          enum: [read, write, comment, manage]
          description: |
            权限类型:
            - read: 可阅读
            - write: 可编辑
            - comment: 可评论
            - manage: 可管理
        granted_by:
          type: string
          description: 授予者 ID
        granted_at:
          type: string
          format: date-time
          description: 授予时间

    # ==================== Error 相关 ====================
    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: integer
          description: 错误码
        message:
          type: string
          description: 错误消息
        details:
          type: object
          description: 错误详情
        request_id:
          type: string
          description: 请求 ID

paths:
  # ==================== Wiki 知识库操作 ====================
  /wiki/v2/spaces/{space_id}/nodes/{node_token}:
    get:
      summary: 获取知识库节点信息
      operationId: getWikiNode
      description: |
        获取知识库节点的详细信息,包括实际的文档 token (obj_token)。
        知识库文档需要先通过此 API 获取 obj_token,再使用对应的文档 API 访问内容。
      tags:
        - Wiki
      parameters:
        - name: space_id
          in: path
          required: true
          schema:
            type: string
            pattern: '^[0-9]+$'
          description: 知识空间 ID
        - name: node_token
          in: path
          required: true
          schema:
            type: string
          description: 节点 token
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 0
                  msg:
                    type: string
                    example: success
                  data:
                    type: object
                    properties:
                      node:
                        $ref: '#/components/schemas/WikiNode'
        '404':
          description: 节点不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /wiki/v2/spaces/{space_id}/nodes:
    get:
      summary: 获取知识库节点列表
      operationId: listWikiNodes
      description: 获取知识空间下的节点列表
      tags:
        - Wiki
      parameters:
        - name: space_id
          in: path
          required: true
          schema:
            type: string
        - name: parent_node_token
          in: query
          schema:
            type: string
          description: 父节点 token (不传则获取根节点)
        - name: page_size
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
        - name: page_token
          in: query
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  msg:
                    type: string
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/WikiNode'
                      has_more:
                        type: boolean
                      page_token:
                        type: string

  /wiki/v2/spaces:
    get:
      summary: 获取知识空间列表
      operationId: listWikiSpaces
      description: 获取用户有权限访问的知识空间列表
      tags:
        - Wiki
      parameters:
        - name: page_size
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
        - name: page_token
          in: query
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  msg:
                    type: string
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/WikiSpace'
                      has_more:
                        type: boolean
                      page_token:
                        type: string

  # ==================== Doc 文档操作 ====================
  /docx/v1/documents:
    post:
      summary: 创建文档
      operationId: createDocument
      tags:
        - Doc
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
              properties:
                title:
                  type: string
                  minLength: 1
                  maxLength: 255
                folder_id:
                  type: string
                  pattern: '^fld_[a-zA-Z0-9]{16}$'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 0
                  msg:
                    type: string
                    example: success
                  data:
                    $ref: '#/components/schemas/Document'
        '400':
          description: 参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /docx/v1/documents/{document_id}/blocks:
    post:
      summary: 追加文档内容
      operationId: appendContent
      tags:
        - Doc
      parameters:
        - name: document_id
          in: path
          required: true
          schema:
            type: string
            pattern: '^doc_[a-zA-Z0-9]{16}$'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - blocks
              properties:
                blocks:
                  type: array
                  items:
                    $ref: '#/components/schemas/ContentBlock'
                  minItems: 1
                  maxItems: 100
                position:
                  type: string
                  enum: [start, end]
                  default: end
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  msg:
                    type: string
                  data:
                    type: object
                    properties:
                      block_ids:
                        type: array
                        items:
                          type: string
        '404':
          description: 文档不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      summary: 获取文档内容
      operationId: getDocumentContent
      tags:
        - Doc
      parameters:
        - name: document_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  msg:
                    type: string
                  data:
                    type: object
                    properties:
                      document:
                        $ref: '#/components/schemas/Document'
                      blocks:
                        type: array
                        items:
                          $ref: '#/components/schemas/ContentBlock'

  /docx/v1/documents/{document_id}/blocks/{block_id}:
    patch:
      summary: 更新 Block
      operationId: updateBlock
      tags:
        - Doc
      parameters:
        - name: document_id
          in: path
          required: true
          schema:
            type: string
        - name: block_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContentBlock'
      responses:
        '200':
          description: 成功

  # ==================== Bitable 多维表格操作 ====================
  /bitable/v1/apps/{app_token}/tables/{table_id}/records:
    post:
      summary: 创建记录
      operationId: createRecord
      tags:
        - Bitable
      parameters:
        - name: app_token
          in: path
          required: true
          schema:
            type: string
        - name: table_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - fields
              properties:
                fields:
                  type: object
                  additionalProperties: true
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  msg:
                    type: string
                  data:
                    type: object
                    properties:
                      record:
                        $ref: '#/components/schemas/BaseRecord'

    get:
      summary: 查询记录
      operationId: queryRecords
      tags:
        - Bitable
      parameters:
        - name: app_token
          in: path
          required: true
          schema:
            type: string
        - name: table_id
          in: path
          required: true
          schema:
            type: string
        - name: filter
          in: query
          schema:
            type: string
            description: JSON 格式的过滤器
        - name: page_size
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 100
        - name: page_token
          in: query
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  msg:
                    type: string
                  data:
                    type: object
                    properties:
                      records:
                        type: array
                        items:
                          $ref: '#/components/schemas/BaseRecord'
                      has_more:
                        type: boolean
                      page_token:
                        type: string
                      total:
                        type: integer

  /bitable/v1/apps/{app_token}/tables/{table_id}/records/{record_id}:
    put:
      summary: 更新记录
      operationId: updateRecord
      tags:
        - Bitable
      parameters:
        - name: app_token
          in: path
          required: true
          schema:
            type: string
        - name: table_id
          in: path
          required: true
          schema:
            type: string
        - name: record_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - fields
              properties:
                fields:
                  type: object
                  additionalProperties: true
      responses:
        '200':
          description: 成功

    delete:
      summary: 删除记录
      operationId: deleteRecord
      tags:
        - Bitable
      parameters:
        - name: app_token
          in: path
          required: true
          schema:
            type: string
        - name: table_id
          in: path
          required: true
          schema:
            type: string
        - name: record_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功

  # ==================== Sheet 电子表格操作 ====================
  /sheets/v2/spreadsheets/{spreadsheet_token}/values/{range}:
    get:
      summary: 读取 Sheet 数据
      operationId: getSheetData
      tags:
        - Sheet
      parameters:
        - name: spreadsheet_token
          in: path
          required: true
          schema:
            type: string
        - name: range
          in: path
          required: true
          schema:
            type: string
          description: 范围 (如 A1:B10)
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  msg:
                    type: string
                  data:
                    type: object
                    properties:
                      values:
                        type: array
                        items:
                          type: array
                          items:
                            $ref: '#/components/schemas/CellValue'

    put:
      summary: 更新 Sheet 数据
      operationId: updateSheetData
      tags:
        - Sheet
      parameters:
        - name: spreadsheet_token
          in: path
          required: true
          schema:
            type: string
        - name: range
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - values
              properties:
                values:
                  type: array
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/CellValue'
      responses:
        '200':
          description: 成功

  # ==================== 媒体管理 ====================
  /drive/v1/medias/upload:
    post:
      summary: 上传文档媒体
      operationId: uploadDocMedia
      tags:
        - Media
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - file_name
                - parent_type
                - parent_node
              properties:
                file:
                  type: string
                  format: binary
                file_name:
                  type: string
                parent_type:
                  type: string
                  enum: [doc, bitable, sheet]
                parent_node:
                  type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  msg:
                    type: string
                  data:
                    $ref: '#/components/schemas/MediaAsset'

  /drive/v1/medias/{file_token}/download:
    get:
      summary: 下载文档媒体
      operationId: downloadDocMedia
      tags:
        - Media
      parameters:
        - name: file_token
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary

  # ==================== 权限管理 ====================
  /drive/v1/permissions/{token}/members:
    post:
      summary: 授予权限
      operationId: grantPermission
      tags:
        - Permission
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Permission'
      responses:
        '200':
          description: 成功

    get:
      summary: 查询权限列表
      operationId: listPermissions
      tags:
        - Permission
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  msg:
                    type: string
                  data:
                    type: object
                    properties:
                      permissions:
                        type: array
                        items:
                          $ref: '#/components/schemas/Permission'
                      total:
                        type: integer

  /drive/v1/permissions/{token}/members/{member_id}:
    delete:
      summary: 撤销权限
      operationId: revokePermission
      tags:
        - Permission
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
        - name: member_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功
