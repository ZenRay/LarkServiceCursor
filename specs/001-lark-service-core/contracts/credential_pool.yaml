openapi: 3.0.3
info:
  title: Lark Service - Credential Pool API (Internal)
  description: |
    Token 凭证池内部 API 契约 (仅供内部模块使用,不对外暴露)。
    
    核心功能:
    - 自动 Token 获取与刷新
    - 多应用隔离 (按 app_id)
    - PostgreSQL 持久化存储
    - 懒加载启动策略
    - 并发安全控制 (线程锁 + 进程锁)
    - 主动失效检测 (到期前 10% 时间窗口自动刷新)
    
    使用场景:
    此 API 仅供 Lark Service 内部模块调用,用于透明获取 Token。
    调用方无需关心 Token 获取、刷新、过期处理,凭证池自动管理。
  version: 0.1.0
  contact:
    name: Internal Platform Team

servers:
  - url: http://localhost:8000/internal/v1
    description: Internal service endpoint

tags:
  - name: Token
    description: Token 获取与管理
  - name: Health
    description: 健康检查

paths:
  /credential-pool/tokens/{token_type}:
    get:
      summary: 获取指定类型的 Token
      description: |
        获取有效的 Token,优先从缓存/数据库读取,缓存未命中或即将过期时自动刷新。
        
        支持的 Token 类型:
        - app_access_token: 应用级 Token (无需用户授权)
        - tenant_access_token: 租户级 Token (无需用户授权)
        - user_access_token: 用户级 Token (需要用户首次认证)
        
        懒加载策略:
        Token 在首次使用时按需获取,非启动时预加载。
      tags:
        - Token
      parameters:
        - name: app_id
          in: query
          required: true
          description: 飞书应用 ID (多应用隔离)
          schema:
            type: string
            example: "cli_a1b2c3d4e5f6g7h8"
        - name: token_type
          in: path
          required: true
          description: Token 类型
          schema:
            type: string
            enum:
              - app_access_token
              - tenant_access_token
              - user_access_token
        - name: user_id
          in: query
          description: 用户 ID (仅 user_access_token 需要)
          schema:
            type: string
            example: "ou_user123"
      responses:
        '200':
          description: Token 获取成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
              examples:
                app_access_token:
                  value:
                    code: "OK"
                    message: "Token 获取成功"
                    request_id: "req_1234567890"
                    data:
                      token_type: "app_access_token"
                      token_value: "t-g104***SAMPLE***cldRchGBJoiAuYyf0V00"
                      expires_at: "2026-01-14T12:30:00Z"
                      cached: true
                      source: "database"
        '401':
          description: 用户未认证 (user_access_token)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "USER_AUTH_REQUIRED"
                message: "用户未完成首次认证,请先通过飞书卡片或消息链接完成认证"
                request_id: "req_1234567890"
                error_details:
                  auth_methods:
                    - "card"
                    - "link"
                  auth_url: "https://open.feishu.cn/auth?..."
        '404':
          description: 应用配置不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "APP_NOT_FOUND"
                message: "应用 cli_xxx 不存在或已禁用,请检查应用配置管理"
                request_id: "req_1234567890"
        '500':
          description: Token 获取失败
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "TOKEN_ACQUISITION_ERROR"
                message: "Token 获取失败: 应用 Secret 错误"
                request_id: "req_1234567890"

  /credential-pool/tokens/refresh:
    post:
      summary: 手动触发 Token 刷新
      description: |
        手动触发指定应用的 Token 刷新 (仅用于测试/调试)。
        正常情况下 Token 会自动刷新,无需手动调用此接口。
      tags:
        - Token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - app_id
                - token_type
              properties:
                app_id:
                  type: string
                  example: "cli_a1b2c3d4e5f6g7h8"
                token_type:
                  type: string
                  enum:
                    - app_access_token
                    - tenant_access_token
                    - user_access_token
                user_id:
                  type: string
                  description: 用户 ID (仅 user_access_token 需要)
      responses:
        '200':
          description: 刷新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '500':
          description: 刷新失败
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /credential-pool/health:
    get:
      summary: 凭证池健康检查
      description: |
        检查凭证池服务状态,包括数据库连接、锁状态等。
      tags:
        - Health
      responses:
        '200':
          description: 健康
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "healthy"
                timestamp: "2026-01-14T10:30:00Z"
                components:
                  database:
                    status: "up"
                    connection_pool_size: 10
                    active_connections: 3
                  lock_manager:
                    status: "up"
                    active_locks: 2
                  cache:
                    status: "up"
                    cached_tokens: 5
        '503':
          description: 不健康
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "unhealthy"
                timestamp: "2026-01-14T10:30:00Z"
                components:
                  database:
                    status: "down"
                    error: "Connection refused"

  /credential-pool/stats:
    get:
      summary: 获取凭证池统计信息
      description: |
        获取 Token 管理统计信息 (用于监控和调试)。
      tags:
        - Health
      responses:
        '200':
          description: 统计信息
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsResponse'
              example:
                total_apps: 3
                total_tokens: 15
                tokens_by_type:
                  app_access_token: 5
                  tenant_access_token: 5
                  user_access_token: 5
                refresh_events_last_hour: 12
                failed_refresh_last_hour: 0
                cache_hit_rate: 0.95
                avg_refresh_time_ms: 234

components:
  schemas:
    TokenResponse:
      type: object
      required:
        - code
        - request_id
        - data
      properties:
        code:
          type: string
          example: "OK"
        message:
          type: string
          example: "Token 获取成功"
        request_id:
          type: string
          example: "req_1234567890"
        data:
          $ref: '#/components/schemas/TokenData'

    TokenData:
      type: object
      required:
        - token_type
        - token_value
        - expires_at
      properties:
        token_type:
          type: string
          enum:
            - app_access_token
            - tenant_access_token
            - user_access_token
          example: "app_access_token"
        token_value:
          type: string
          description: Token 值 (敏感信息)
          example: "t-g104***SAMPLE***cldRchGBJoiAuYyf0V00"
        expires_at:
          type: string
          format: date-time
          description: 过期时间
          example: "2026-01-14T12:30:00Z"
        cached:
          type: boolean
          description: 是否从缓存读取
          example: true
        source:
          type: string
          enum:
            - memory
            - database
            - api
          description: Token 来源
          example: "database"
        app_id:
          type: string
          example: "cli_a1b2c3d4e5f6g7h8"
        user_id:
          type: string
          description: 用户 ID (仅 user_access_token)
          example: "ou_user123"
        refreshed_at:
          type: string
          format: date-time
          description: 上次刷新时间
          example: "2026-01-14T10:30:00Z"

    HealthResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum:
            - healthy
            - degraded
            - unhealthy
          example: "healthy"
        timestamp:
          type: string
          format: date-time
        components:
          type: object
          properties:
            database:
              $ref: '#/components/schemas/ComponentHealth'
            lock_manager:
              $ref: '#/components/schemas/ComponentHealth'
            cache:
              $ref: '#/components/schemas/ComponentHealth'

    ComponentHealth:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum:
            - up
            - down
            - degraded
        error:
          type: string
          description: 错误信息 (如果 down)
        details:
          type: object
          additionalProperties: true

    StatsResponse:
      type: object
      properties:
        total_apps:
          type: integer
          description: 总应用数
        total_tokens:
          type: integer
          description: 总 Token 数
        tokens_by_type:
          type: object
          properties:
            app_access_token:
              type: integer
            tenant_access_token:
              type: integer
            user_access_token:
              type: integer
        refresh_events_last_hour:
          type: integer
          description: 过去 1 小时刷新次数
        failed_refresh_last_hour:
          type: integer
          description: 过去 1 小时刷新失败次数
        cache_hit_rate:
          type: number
          format: float
          description: 缓存命中率 (0.0 ~ 1.0)
          example: 0.95
        avg_refresh_time_ms:
          type: integer
          description: 平均刷新耗时 (毫秒)

    ErrorResponse:
      type: object
      required:
        - code
        - message
        - request_id
      properties:
        code:
          type: string
          enum:
            - USER_AUTH_REQUIRED
            - APP_NOT_FOUND
            - APP_DISABLED
            - TOKEN_ACQUISITION_ERROR
            - TOKEN_REFRESH_FAILED
            - DATABASE_ERROR
            - LOCK_TIMEOUT
            - INVALID_PARAMETER
            - INTERNAL_ERROR
        message:
          type: string
        request_id:
          type: string
        error_details:
          type: object
          additionalProperties: true
