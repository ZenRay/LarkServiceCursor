# Feature Specification: WebSocket ç”¨æˆ·æˆæƒæ–¹æ¡ˆ

**Feature Branch**: `002-websocket-user-auth`
**Created**: 2026-01-19
**Status**: Draft
**Input**: å®ç°åŸºäºWebSocketé•¿è¿æ¥çš„ç”¨æˆ·æˆæƒæ–¹æ¡ˆ,é€šè¿‡äº¤äº’å¼å¡ç‰‡è·å–user_access_token,æ”¯æŒaPaaSé«˜çº§åŠŸèƒ½

---

## ğŸ“ åŠŸèƒ½æ¦‚è¿°

ä¸º Lark Service é¡¹ç›®å®ç°åŸºäº WebSocket é•¿è¿æ¥çš„ç”¨æˆ·æˆæƒæ–¹æ¡ˆ,é€šè¿‡äº¤äº’å¼å¡ç‰‡è·å– `user_access_token`,è§£é” aPaaS é«˜çº§åŠŸèƒ½(AI èƒ½åŠ›ã€å·¥ä½œæµè§¦å‘ç­‰)ã€‚

**æ ¸å¿ƒä»·å€¼**:
- âœ… **æ— éœ€å…¬ç½‘ HTTP ç«¯ç‚¹** - éƒ¨ç½²æç®€,å†…ç½‘ç¯å¢ƒå³å¯ä½¿ç”¨
- âœ… **çº¯é£ä¹¦å†…é—­ç¯** - ç”¨æˆ·æ— éœ€è·³è½¬æµè§ˆå™¨,ä½“éªŒæµç•…
- âœ… **å®æ—¶æ¥æ”¶äº‹ä»¶** - WebSocket æ¨é€,å“åº”é€Ÿåº¦å¿«
- âœ… **å¯æ‰©å±•æ€§å¼º** - å¯å¤ç”¨åˆ°ç¾¤æ¶ˆæ¯ã€å®¡æ‰¹é€šçŸ¥ç­‰åœºæ™¯

---

## Clarifications

### Session 2026-01-19

- **Q**: å½“ WebSocket è¿æ¥10æ¬¡é‡è¿å¤±è´¥å,ç³»ç»Ÿåº”è¯¥å¦‚ä½•å¤„ç†? â†’ **A**: (1) é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å·²å­˜å‚¨çš„ Token,ä¼˜å…ˆä½¿ç”¨ç¼“å­˜ Token; (2) é™çº§ç­–ç•¥é»˜è®¤è‡ªåŠ¨åˆ‡æ¢åˆ° HTTP å›è°ƒå¤‡ç”¨æ–¹æ¡ˆ; (3) é™çº§è¡Œä¸ºå¯é€šè¿‡é…ç½®å‚æ•° `fallback_to_http_callback` æ§åˆ¶(é»˜è®¤ true)

- **Q**: ä»å¡ç‰‡å›è°ƒäº‹ä»¶ä¸­è·å– open_id å,å¦‚ä½•æ¢å– user_access_token? â†’ **A**: ä½¿ç”¨å¡ç‰‡å›è°ƒäº‹ä»¶ä¸­çš„ä¸´æ—¶æˆæƒç (authorization_code)è°ƒç”¨ `/open-apis/authen/v1/oidc/access_token` æ¢å–;åŒæ—¶éœ€è¦é¢å¤–è¯·æ±‚ç”¨æˆ·ä¿¡æ¯å¹¶å­˜å‚¨(å§“åã€user_idã€open_idã€union_idã€æ‰‹æœºå·ã€é‚®ç®±ç­‰)

- **Q**: ç”¨æˆ·ä¿¡æ¯(å§“åã€æ‰‹æœºã€é‚®ç®±ç­‰)çš„æ›´æ–°ç­–ç•¥æ˜¯ä»€ä¹ˆ? â†’ **A**: (1) æ¯æ¬¡ Token åˆ·æ–°æ—¶åŒæ­¥æ›´æ–°ç”¨æˆ·ä¿¡æ¯; (2) åŒæ—¶æ”¯æŒå®šæœŸå¼‚æ­¥ä»»åŠ¡æ‰¹é‡æ›´æ–°,é€šè¿‡é…ç½®å‚æ•°æ§åˆ¶: `user_info_sync_enabled`(æ˜¯å¦å¯ç”¨,é»˜è®¤ false)ã€`user_info_sync_schedule`(æ›´æ–°æ—¶é—´,é»˜è®¤ "0 2 * * *" å³æ¯å¤©å‡Œæ™¨2ç‚¹)

- **Q**: æˆæƒå¡ç‰‡åº”è¯¥å±•ç¤ºå“ªäº›æ ¸å¿ƒä¿¡æ¯æ¥æé«˜ç”¨æˆ·æˆæƒæ„æ„¿? â†’ **A**: ç®€æ´ç‰ˆ(ç”¨é€”+æƒé™èŒƒå›´+éšç§é“¾æ¥);é€šè¿‡å‚æ•° `include_detailed_description` æ§åˆ¶æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†è¯´æ˜(é»˜è®¤ true æ˜¾ç¤º);å…è®¸é€šè¿‡ `auth_card_template_id` å‚æ•°è‡ªå®šä¹‰å¡ç‰‡æ¨¡æ¿,å¤ç”¨ç°æœ‰ CardKit æœåŠ¡èƒ½åŠ›

- **Q**: å½“ Token å®Œå…¨è¿‡æœŸä¸”æ— æ³•åˆ·æ–°æ—¶,ç³»ç»Ÿåº”è¯¥å¦‚ä½•æç¤ºç”¨æˆ·? â†’ **A**: è‡ªåŠ¨å‘é€æ–°æˆæƒå¡ç‰‡å¹¶é™„å¸¦å‹å¥½æç¤ºæ¶ˆæ¯(å¦‚"æ‚¨çš„æˆæƒå·²è¿‡æœŸ,éœ€è¦é‡æ–°æˆæƒä»¥ç»§ç»­ä½¿ç”¨ XX åŠŸèƒ½"),è®©ç”¨æˆ·ç‚¹å‡»å¡ç‰‡æŒ‰é’®å³å¯å®Œæˆé‡æ–°æˆæƒ

---

## User Scenarios & Testing

### User Story 1 - ç”¨æˆ·é€šè¿‡å¡ç‰‡å®Œæˆæˆæƒ (Priority: P1) ğŸ¯ MVP

ç”¨æˆ·éœ€è¦ä½¿ç”¨éœ€è¦ä¸ªäººæƒé™çš„åŠŸèƒ½(å¦‚ aPaaS AI èƒ½åŠ›)æ—¶,ç³»ç»Ÿé€šè¿‡äº¤äº’å¼å¡ç‰‡å¼•å¯¼ç”¨æˆ·å®Œæˆæˆæƒ,å…¨ç¨‹åœ¨é£ä¹¦å†…å®Œæˆã€‚

**Why this priority**: è¿™æ˜¯è·å– user_access_token çš„æ ¸å¿ƒæµç¨‹,æ²¡æœ‰å®ƒå°±æ— æ³•è®¿é—®ä»»ä½•éœ€è¦ç”¨æˆ·æƒé™çš„ aPaaS åŠŸèƒ½ã€‚

**Independent Test**: å‘é€æˆæƒå¡ç‰‡ â†’ ç”¨æˆ·ç‚¹å‡»"æˆæƒ"æŒ‰é’® â†’ ç³»ç»Ÿæ¥æ”¶ WebSocket äº‹ä»¶ â†’ è·å– user_access_token â†’ å­˜å‚¨åˆ°æ•°æ®åº“ â†’ å¡ç‰‡æ›´æ–°æ˜¾ç¤ºæˆåŠŸã€‚

**Acceptance Scenarios**:

1. **Given** ç”¨æˆ·å°šæœªæˆæƒä¸”å°è¯•è°ƒç”¨éœ€è¦ user_access_token çš„ API
   **When** ç³»ç»Ÿæ£€æµ‹åˆ°ç¼ºå°‘æˆæƒ(æ•°æ®åº“ä¸­æ— æœ‰æ•ˆ Token)
   **Then** ç³»ç»Ÿè‡ªåŠ¨å‘é€æˆæƒè¯·æ±‚å¡ç‰‡ç»™ç”¨æˆ·

2. **Given** ç”¨æˆ·å·²æœ‰å­˜å‚¨çš„æœ‰æ•ˆ Token
   **When** è°ƒç”¨éœ€è¦ user_access_token çš„ API
   **Then** ç³»ç»Ÿç›´æ¥ä½¿ç”¨å·²å­˜å‚¨çš„ Token,æ— éœ€é‡æ–°æˆæƒ

3. **Given** ç”¨æˆ·æ”¶åˆ°æˆæƒå¡ç‰‡
   **When** ç”¨æˆ·ç‚¹å‡»"æˆæƒ"æŒ‰é’®
   **Then** é£ä¹¦é€šè¿‡ WebSocket æ¨é€å¡ç‰‡å›è°ƒäº‹ä»¶åˆ°ç³»ç»Ÿ

4. **Given** ç³»ç»Ÿæ¥æ”¶åˆ°å¡ç‰‡å›è°ƒäº‹ä»¶
   **When** äº‹ä»¶ä¸­åŒ…å«ç”¨æˆ·çš„ä¸´æ—¶æˆæƒç (authorization_code)
   **Then** ç³»ç»Ÿè°ƒç”¨é£ä¹¦ API æ¢å– user_access_token å¹¶è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯(å§“åã€IDã€æ‰‹æœºã€é‚®ç®±ç­‰)å¹¶å­˜å‚¨

5. **Given** user_access_token å·²æˆåŠŸè·å–
   **When** ç³»ç»Ÿå­˜å‚¨ Token åˆ°æ•°æ®åº“
   **Then** å¡ç‰‡æ›´æ–°æ˜¾ç¤º"æˆæƒæˆåŠŸ"

---

### User Story 2 - WebSocket é•¿è¿æ¥è‡ªåŠ¨ç®¡ç† (Priority: P1) ğŸ¯ åŸºç¡€è®¾æ–½

ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨ä¸é£ä¹¦å»ºç«‹ WebSocket é•¿è¿æ¥,æ¥æ”¶å®æ—¶äº‹ä»¶,å¹¶è‡ªåŠ¨å¤„ç†æ–­çº¿é‡è¿ã€‚

**Why this priority**: WebSocket è¿æ¥æ˜¯æ¥æ”¶å¡ç‰‡å›è°ƒäº‹ä»¶çš„åŸºç¡€,å¿…é¡»ä¼˜å…ˆå®ç°ã€‚

**Independent Test**: å¯åŠ¨ç³»ç»Ÿ â†’ éªŒè¯ WebSocket è¿æ¥å»ºç«‹ â†’ æ¨¡æ‹Ÿæ–­çº¿ â†’ éªŒè¯è‡ªåŠ¨é‡è¿ â†’ å‘é€æµ‹è¯•äº‹ä»¶ â†’ éªŒè¯æˆåŠŸæ¥æ”¶ã€‚

**Acceptance Scenarios**:

1. **Given** ç³»ç»Ÿå¯åŠ¨ä¸”é…ç½®äº† app_id å’Œ app_secret
   **When** ç³»ç»Ÿåˆå§‹åŒ– WebSocket å®¢æˆ·ç«¯
   **Then** æˆåŠŸä¸é£ä¹¦æœåŠ¡å™¨å»ºç«‹è¿æ¥

2. **Given** WebSocket è¿æ¥å·²å»ºç«‹
   **When** ç½‘ç»œä¸­æ–­æˆ–è¿æ¥æ–­å¼€
   **Then** ç³»ç»Ÿè‡ªåŠ¨ä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥é‡è¿(1sâ†’2sâ†’4sâ†’8s,æœ€å¤š10æ¬¡)

3. **Given** WebSocket è¿æ¥æ­£å¸¸
   **When** é£ä¹¦æ¨é€å¡ç‰‡å›è°ƒäº‹ä»¶
   **Then** ç³»ç»Ÿçš„äº‹ä»¶åˆ†å‘å™¨æ­£ç¡®è·¯ç”±åˆ°æˆæƒå¤„ç†å™¨

---

### User Story 3 - Token ç”Ÿå‘½å‘¨æœŸç®¡ç† (Priority: P2)

ç³»ç»Ÿè‡ªåŠ¨ç®¡ç† user_access_token çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ,åŒ…æ‹¬è¿‡æœŸæ£€æµ‹ã€è‡ªåŠ¨åˆ·æ–°ã€å¤šç”¨æˆ·éš”ç¦»ã€‚

**Why this priority**: ç¡®ä¿ Token æŒç»­å¯ç”¨,é¿å…ç”¨æˆ·é¢‘ç¹é‡æ–°æˆæƒã€‚

**Independent Test**: æ¨¡æ‹Ÿ Token å³å°†è¿‡æœŸ â†’ ç³»ç»Ÿè‡ªåŠ¨åˆ·æ–° â†’ éªŒè¯æ–° Token å¯ç”¨ã€‚

**Acceptance Scenarios**:

1. **Given** user_access_token å‰©ä½™æœ‰æ•ˆæœŸå°‘äº10%
   **When** ç³»ç»Ÿæ£€æµ‹åˆ° Token å³å°†è¿‡æœŸ
   **Then** è‡ªåŠ¨è°ƒç”¨åˆ·æ–° API è·å–æ–° Token å¹¶åŒæ­¥æ›´æ–°ç”¨æˆ·ä¿¡æ¯

2. **Given** ç³»ç»Ÿå­˜å‚¨äº†å¤šä¸ªç”¨æˆ·çš„ Token
   **When** è°ƒç”¨ API æ—¶æŒ‡å®šä¸åŒçš„ user_id
   **Then** ç³»ç»Ÿæ­£ç¡®ä½¿ç”¨å¯¹åº”ç”¨æˆ·çš„ Token

3. **Given** é…ç½®å¯ç”¨äº†å®šæœŸç”¨æˆ·ä¿¡æ¯åŒæ­¥(`user_info_sync_enabled=true`)
   **When** åˆ°è¾¾é…ç½®çš„åŒæ­¥æ—¶é—´(å¦‚æ¯å¤©å‡Œæ™¨2ç‚¹)
   **Then** ç³»ç»Ÿå¼‚æ­¥æ‰¹é‡æ›´æ–°æ‰€æœ‰ç”¨æˆ·çš„ä¿¡æ¯

---

### User Story 4 - aPaaS åŠŸèƒ½é›†æˆ (Priority: P2)

aPaaS å®¢æˆ·ç«¯è‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨ user_access_token,æ”¯æŒ AI èƒ½åŠ›è°ƒç”¨ã€å·¥ä½œæµè§¦å‘ç­‰é«˜çº§åŠŸèƒ½ã€‚

**Why this priority**: è¿™æ˜¯è·å– user_access_token çš„æœ€ç»ˆç›®æ ‡ã€‚

**Independent Test**: è°ƒç”¨ aPaaS AI API â†’ ç³»ç»Ÿè‡ªåŠ¨ä½¿ç”¨ user_access_token â†’ éªŒè¯ AI è°ƒç”¨æˆåŠŸã€‚

**Acceptance Scenarios**:

1. **Given** ç”¨æˆ·å·²æˆæƒä¸” user_access_token æœ‰æ•ˆ
   **When** è°ƒç”¨ aPaaS AI èƒ½åŠ› API
   **Then** ç³»ç»Ÿè‡ªåŠ¨æ³¨å…¥ user_access_token å¹¶æˆåŠŸè°ƒç”¨

2. **Given** ç”¨æˆ·å°šæœªæˆæƒ
   **When** è°ƒç”¨éœ€è¦ user_access_token çš„ aPaaS API
   **Then** ç³»ç»ŸæŠ›å‡º AuthenticationRequired å¼‚å¸¸å¹¶è‡ªåŠ¨å‘é€æˆæƒå¡ç‰‡

3. **Given** user_access_token å·²å®Œå…¨è¿‡æœŸä¸”æ— æ³•åˆ·æ–°
   **When** ç”¨æˆ·å°è¯•è°ƒç”¨ aPaaS API
   **Then** ç³»ç»Ÿè‡ªåŠ¨å‘é€æ–°æˆæƒå¡ç‰‡,é™„å¸¦å‹å¥½æç¤ºæ¶ˆæ¯,å¼•å¯¼ç”¨æˆ·é‡æ–°æˆæƒ

---

### Edge Cases

**ç½‘ç»œå’Œè¿æ¥å¼‚å¸¸**:
- WebSocket è¿æ¥å¤±è´¥ â†’ è®°å½•æ—¥å¿—,æŒ‡æ•°é€€é¿é‡è¯•,10æ¬¡å¤±è´¥åé»˜è®¤åˆ‡æ¢åˆ° HTTP å›è°ƒå¤‡ç”¨æ–¹æ¡ˆ(å¯é€šè¿‡é…ç½®å‚æ•° `fallback_to_http_callback` æ§åˆ¶,é»˜è®¤ true)
- é™çº§å‰ä¼˜å…ˆæ£€æŸ¥å·²å­˜å‚¨çš„ Token â†’ å¦‚æœ‰æœ‰æ•ˆ Token åˆ™ç»§ç»­ä½¿ç”¨ç¼“å­˜,ä»…å½±å“æ–°æˆæƒæµç¨‹
- è¿æ¥ä¸­æ–­æ—¶æ”¶åˆ°æˆæƒè¯·æ±‚ â†’ åŠ å…¥å¾…å¤„ç†é˜Ÿåˆ—,è¿æ¥æ¢å¤åæ‰¹é‡å¤„ç†
- é‡è¿æœŸé—´ä¸¢å¤±äº‹ä»¶ â†’ é£ä¹¦ä¼šç¼“å­˜äº‹ä»¶,é‡è¿åè‡ªåŠ¨æ¨é€

**æˆæƒæµç¨‹å¼‚å¸¸**:
- ç”¨æˆ·æ‹’ç»æˆæƒ â†’ å¡ç‰‡æ˜¾ç¤º"æˆæƒè¢«æ‹’ç»",API è¿”å›é”™è¯¯
- ç”¨æˆ·å¤šæ¬¡ç‚¹å‡»æˆæƒæŒ‰é’® â†’ ä½¿ç”¨ session_id å»é‡,åªå¤„ç†ä¸€æ¬¡
- æˆæƒå¡ç‰‡è¿‡æœŸæœªæ“ä½œ â†’ 10åˆ†é’Ÿåä¼šè¯è‡ªåŠ¨è¿‡æœŸ
- æ¢å– Token å¤±è´¥ â†’ è®°å½•é”™è¯¯,å¡ç‰‡æ˜¾ç¤ºå‹å¥½æç¤º
- Token å®Œå…¨è¿‡æœŸä¸”æ— æ³•åˆ·æ–° â†’ è‡ªåŠ¨å‘é€æ–°æˆæƒå¡ç‰‡,é™„å¸¦å‹å¥½æç¤º("æ‚¨çš„æˆæƒå·²è¿‡æœŸ,éœ€è¦é‡æ–°æˆæƒä»¥ç»§ç»­ä½¿ç”¨ XX åŠŸèƒ½")

**å¤šç”¨æˆ·å’Œå¹¶å‘**:
- åŒä¸€ç”¨æˆ·å¤šè®¾å¤‡åŒæ—¶æˆæƒ â†’ æœ€åå®Œæˆçš„æˆæƒç”Ÿæ•ˆ
- å¤šç”¨æˆ·åŒæ—¶è¯·æ±‚æˆæƒ â†’ ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºç‹¬ç«‹ä¼šè¯,äº’ä¸å¹²æ‰°
- é«˜å¹¶å‘æˆæƒè¯·æ±‚ â†’ é™æµä¿æŠ¤(æ¯ç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤š5æ¬¡)

---

## Requirements

### Functional Requirements

#### WebSocket é•¿è¿æ¥ç®¡ç†

- **FR-001**: ç³»ç»Ÿ MUST åœ¨å¯åŠ¨æ—¶è‡ªåŠ¨å»ºç«‹ WebSocket é•¿è¿æ¥,ä½¿ç”¨ lark-oapi SDK çš„ `lark.ws.Client`
- **FR-002**: ç³»ç»Ÿ MUST æ³¨å†Œå¡ç‰‡å›è°ƒäº‹ä»¶å¤„ç†å™¨ `register_p2_card_action_trigger`
- **FR-003**: ç³»ç»Ÿ MUST å®ç°è‡ªåŠ¨æ–­çº¿é‡è¿,ä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥(1sâ†’2sâ†’4sâ†’8s),æœ€å¤šé‡è¯•10æ¬¡
- **FR-003-a**: ç³»ç»Ÿ MUST åœ¨10æ¬¡é‡è¿å¤±è´¥å,æ ¹æ®é…ç½®å‚æ•° `fallback_to_http_callback` å†³å®šæ˜¯å¦åˆ‡æ¢åˆ° HTTP å›è°ƒæ–¹æ¡ˆ(é»˜è®¤ true)
- **FR-003-b**: ç³»ç»Ÿ MUST åœ¨é™çº§å‰ä¼˜å…ˆæ£€æŸ¥å¹¶ä½¿ç”¨å·²å­˜å‚¨çš„æœ‰æ•ˆ Token,é™çº§ä»…å½±å“æ–°æˆæƒæµç¨‹
- **FR-004**: ç³»ç»Ÿ MUST æ¯30ç§’å‘é€å¿ƒè·³ ping æ¶ˆæ¯ä¿æŒè¿æ¥
- **FR-005**: ç³»ç»Ÿ MUST è®°å½• WebSocket çŠ¶æ€å˜åŒ–åˆ°ç»“æ„åŒ–æ—¥å¿—

#### æˆæƒå¡ç‰‡å‘é€ä¸å¤„ç†

- **FR-006**: ç³»ç»Ÿ MUST æä¾› `send_auth_card(app_id, user_id, session_id, options)` æ–¹æ³•
- **FR-006-a**: æ–¹æ³• MUST æ”¯æŒ options å‚æ•°,åŒ…å«:
  - `include_detailed_description` (bool) - æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†è¯´æ˜(é»˜è®¤ true)
  - `auth_card_template_id` (str) - è‡ªå®šä¹‰å¡ç‰‡æ¨¡æ¿ ID(å¯é€‰,é»˜è®¤ä½¿ç”¨å†…ç½®æ¨¡æ¿)
- **FR-006-b**: ç³»ç»Ÿ MUST å¤ç”¨ç°æœ‰ Phase 3 çš„ CardBuilder æœåŠ¡æ„å»ºæˆæƒå¡ç‰‡
- **FR-007**: æˆæƒå¡ç‰‡é»˜è®¤ç‰ˆæœ¬(è¯¦ç»†)MUST åŒ…å«:æˆæƒç”¨é€”è¯´æ˜ã€æƒé™èŒƒå›´åˆ—è¡¨ã€"æˆæƒ"æŒ‰é’®ã€éšç§æ”¿ç­–é“¾æ¥
- **FR-007-a**: æˆæƒå¡ç‰‡ç®€æ´ç‰ˆæœ¬(include_detailed_description=false)MUST åŒ…å«:ç®€è¦ç”¨é€”ã€"æˆæƒ"æŒ‰é’®ã€éšç§æ”¿ç­–é“¾æ¥
- **FR-008**: å¡ç‰‡æŒ‰é’®çš„ action.value MUST åŒ…å« session_id
- **FR-009**: ç³»ç»Ÿ MUST ä»å¡ç‰‡å›è°ƒäº‹ä»¶ä¸­æå–ä¸´æ—¶æˆæƒç (authorization_code)å’Œ session_id
- **FR-010**: ç³»ç»Ÿ MUST ä½¿ç”¨æˆæƒç è°ƒç”¨ `/open-apis/authen/v1/oidc/access_token` API æ¢å– user_access_token
- **FR-010-a**: ç³»ç»Ÿ MUST åœ¨è·å– Token å,è°ƒç”¨ `/open-apis/contact/v3/users/:user_id` è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
- **FR-010-b**: ç³»ç»Ÿ MUST å­˜å‚¨ç”¨æˆ·ä¿¡æ¯åŒ…æ‹¬:å§“å(name)ã€ç”¨æˆ·ID(user_id)ã€OpenID(open_id)ã€UnionID(union_id)ã€æ‰‹æœºå·(mobile)ã€é‚®ç®±(email)
- **FR-011**: ç³»ç»Ÿ MUST åœ¨æˆæƒæˆåŠŸåæ›´æ–°å¡ç‰‡æ˜¾ç¤º

#### æˆæƒä¼šè¯ç®¡ç†

- **FR-012**: ç³»ç»Ÿ MUST åˆ›å»ºæˆæƒä¼šè¯æ—¶ç”Ÿæˆå”¯ä¸€ session_id (UUID)
- **FR-013**: ç³»ç»Ÿ MUST å­˜å‚¨ä¼šè¯åˆ° `user_auth_sessions` è¡¨
- **FR-014**: ç³»ç»Ÿ MUST åœ¨å®Œæˆæˆæƒåæ›´æ–°ä¼šè¯çŠ¶æ€ä¸º completed
- **FR-015**: ç³»ç»Ÿ MUST å®šæ—¶æ¸…ç†è¿‡æœŸä¼šè¯(æ¯å°æ—¶)

#### Token å­˜å‚¨ä¸ç®¡ç†

- **FR-016**: ç³»ç»Ÿ MUST å­˜å‚¨ user_access_token åˆ°æ•°æ®åº“
- **FR-017**: user_access_token MUST åŠ å¯†å­˜å‚¨
- **FR-018**: ç³»ç»Ÿ MUST æ”¯æŒå¤šç”¨æˆ·éš”ç¦»,æ¯ä¸ª (app_id, user_id) ç‹¬ç«‹ç®¡ç†
- **FR-019**: ç³»ç»Ÿ MUST æä¾› `get_user_access_token(app_id, user_id)` æ–¹æ³•,ä¼˜å…ˆè¿”å›å·²å­˜å‚¨çš„æœ‰æ•ˆ Token
- **FR-020**: ç³»ç»Ÿ MUST åœ¨ Token å‰©ä½™æœ‰æ•ˆæœŸå°‘äº10%æ—¶è‡ªåŠ¨åˆ·æ–°
- **FR-020-a**: ç³»ç»Ÿ MUST åœ¨åˆ·æ–° Token æ—¶åŒæ­¥æ›´æ–°ç”¨æˆ·è¯¦ç»†ä¿¡æ¯(å§“åã€æ‰‹æœºã€é‚®ç®±ç­‰)
- **FR-021**: ç³»ç»Ÿ MUST åœ¨è°ƒç”¨ä»»ä½•éœ€è¦ user_access_token çš„ API å‰,å…ˆæ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰æœ‰æ•ˆ Token
- **FR-021-a**: ç³»ç»Ÿ MAY æ”¯æŒå®šæœŸå¼‚æ­¥æ‰¹é‡æ›´æ–°ç”¨æˆ·ä¿¡æ¯,é€šè¿‡é…ç½®å‚æ•° `user_info_sync_enabled` æ§åˆ¶(é»˜è®¤ false)
- **FR-021-b**: ç³»ç»Ÿ MUST æä¾›é…ç½®å‚æ•° `user_info_sync_schedule` æŒ‡å®šæ›´æ–°æ—¶é—´(é»˜è®¤ "0 2 * * *",Cron æ ¼å¼)

#### aPaaS å®¢æˆ·ç«¯é›†æˆ

- **FR-022**: aPaaSClient MUST æä¾› `_get_user_access_token()` æ–¹æ³•,ä¼˜å…ˆä½¿ç”¨å·²å­˜å‚¨çš„ Token
- **FR-023**: aPaaSClient MUST åœ¨éœ€è¦æ—¶è‡ªåŠ¨è·å– user_access_token
- **FR-024**: aPaaSClient MUST åœ¨ç¼ºå°‘æˆæƒæ—¶(æ•°æ®åº“ä¸­æ— æœ‰æ•ˆ Token)è‡ªåŠ¨å‘é€æˆæƒå¡ç‰‡
- **FR-025**: aPaaSClient MUST åœ¨ Token è¿‡æœŸæ—¶è‡ªåŠ¨åˆ·æ–°å¹¶é‡è¯•
- **FR-025-a**: aPaaSClient MUST åœ¨ Token å®Œå…¨è¿‡æœŸä¸”æ— æ³•åˆ·æ–°æ—¶,è‡ªåŠ¨å‘é€æ–°æˆæƒå¡ç‰‡å¹¶é™„å¸¦å‹å¥½æç¤ºæ¶ˆæ¯

#### å®‰å…¨ä¸ç›‘æ§

- **FR-026**: ç³»ç»Ÿ MUST éªŒè¯æ‰€æœ‰ WebSocket äº‹ä»¶çš„ç­¾å
- **FR-027**: ç³»ç»Ÿ MUST å¯¹æˆæƒè¯·æ±‚é™æµ(æ¯ç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤š5æ¬¡)
- **FR-028**: ç³»ç»Ÿ MUST åœ¨æ—¥å¿—ä¸­è„±æ• Token å’Œå¯†é’¥
- **FR-029**: ç³»ç»Ÿ MUST æä¾› Prometheus æŒ‡æ ‡:
  - websocket_connection_status (è¿æ¥çŠ¶æ€)
  - user_auth_sessions_total (æˆæƒä¼šè¯æ€»æ•°)
  - user_auth_success_rate (æˆæƒæˆåŠŸç‡)
- **FR-030**: ç³»ç»Ÿ MUST æä¾›é…ç½®å‚æ•°:
  - `fallback_to_http_callback` - æ§åˆ¶é™çº§è¡Œä¸º(é»˜è®¤ true)
  - `user_info_sync_enabled` - æ˜¯å¦å¯ç”¨å®šæœŸç”¨æˆ·ä¿¡æ¯åŒæ­¥(é»˜è®¤ false)
  - `user_info_sync_schedule` - ç”¨æˆ·ä¿¡æ¯åŒæ­¥æ—¶é—´(é»˜è®¤ "0 2 * * *",Cron æ ¼å¼)
  - `include_detailed_description` - æˆæƒå¡ç‰‡æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†è¯´æ˜(é»˜è®¤ true)
  - `auth_card_template_id` - è‡ªå®šä¹‰æˆæƒå¡ç‰‡æ¨¡æ¿ ID(å¯é€‰)

---

### Key Entities

#### UserAuthSession (æˆæƒä¼šè¯)

å¤ç”¨ç°æœ‰ `user_auth_sessions` è¡¨å¹¶æ‰©å±•:
- session_id (VARCHAR(64), PRIMARY KEY) - ä¼šè¯ ID
- app_id (VARCHAR(64)) - åº”ç”¨ ID
- user_id (VARCHAR(64)) - é£ä¹¦ç”¨æˆ· ID
- open_id (VARCHAR(64)) - ç”¨æˆ· OpenID
- union_id (VARCHAR(64)) - ç”¨æˆ· UnionID
- user_name (VARCHAR(128)) - ç”¨æˆ·å§“å
- mobile (VARCHAR(32)) - æ‰‹æœºå·
- email (VARCHAR(128)) - é‚®ç®±
- auth_method (VARCHAR(32)) - è®¤è¯æ–¹å¼ "websocket_card"
- state (VARCHAR(16)) - çŠ¶æ€ (pending/completed/expired)
- user_access_token (VARCHAR(512), ENCRYPTED) - Token(åŠ å¯†)
- token_expires_at (TIMESTAMP) - Token è¿‡æœŸæ—¶é—´
- created_at, expires_at, completed_at (TIMESTAMP) - æ—¶é—´æˆ³

#### WebSocketClient (WebSocket å®¢æˆ·ç«¯)

æ–°å¢ Python ç±» `src/lark_service/events/websocket_client.py`:
- app_id, app_secret (str) - åº”ç”¨å‡­è¯
- ws_client (lark.ws.Client) - SDK å®¢æˆ·ç«¯å®ä¾‹
- event_handler (EventDispatcherHandler) - äº‹ä»¶åˆ†å‘å™¨
- connection_status (ConnectionStatus) - è¿æ¥çŠ¶æ€

æ–¹æ³•:
- `connect()` - å»ºç«‹è¿æ¥
- `register_handler(event_type, handler_func)` - æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
- `start()` - å¯åŠ¨å®¢æˆ·ç«¯

#### AuthSessionManager (ä¼šè¯ç®¡ç†å™¨)

æ–°å¢ Python ç±» `src/lark_service/auth/session_manager.py`:
- `create_session(app_id, user_id)` â†’ UserAuthSession
- `get_session(session_id)` â†’ UserAuthSession | None
- `complete_session(session_id, token, expires_at, user_info)` â†’ None
- `get_active_token(app_id, user_id)` â†’ str | None
- `refresh_token(app_id, user_id)` â†’ str (åŒæ—¶æ›´æ–°ç”¨æˆ·ä¿¡æ¯)
- `cleanup_expired_sessions()` â†’ int
- `sync_user_info_batch()` â†’ int (å¼‚æ­¥æ‰¹é‡æ›´æ–°ç”¨æˆ·ä¿¡æ¯,å¯é€‰åŠŸèƒ½)

#### CardAuthHandler (å¡ç‰‡æˆæƒå¤„ç†å™¨)

æ–°å¢ Python ç±» `src/lark_service/auth/card_auth_handler.py`:
- `send_auth_card(app_id, user_id, session_id, options)` â†’ str
  - options: dict åŒ…å« `include_detailed_description` å’Œ `auth_card_template_id`
  - å†…éƒ¨è°ƒç”¨ Phase 3 çš„ CardBuilder æ„å»ºå¡ç‰‡
- `handle_card_auth_event(event: P2CardActionTrigger)` â†’ Response
- `_exchange_token(authorization_code)` â†’ (token, expires_at, user_info)
- `_fetch_user_info(user_access_token)` â†’ dict (åŒ…å«å§“åã€IDã€æ‰‹æœºã€é‚®ç®±ç­‰)

---

## Success Criteria

### ç”¨æˆ·ä½“éªŒæŒ‡æ ‡

- **SC-001**: ç”¨æˆ·å®Œæˆæˆæƒçš„å¹³å‡æ—¶é—´ â‰¤ 15ç§’
- **SC-002**: æˆæƒæˆåŠŸç‡ â‰¥ 95%
- **SC-003**: ç”¨æˆ·æ— éœ€è·³å‡ºé£ä¹¦åº”ç”¨(100%é£ä¹¦å†…é—­ç¯)

### ç³»ç»Ÿå¯é æ€§æŒ‡æ ‡

- **SC-004**: WebSocket è¿æ¥å¯ç”¨ç‡ â‰¥ 99.9%
- **SC-005**: WebSocket æ–­çº¿åé‡è¿æˆåŠŸç‡ â‰¥ 99%
- **SC-006**: ç³»ç»Ÿæ”¯æŒ 1000 å¹¶å‘æˆæƒä¼šè¯
- **SC-007**: Token åˆ·æ–°æˆåŠŸç‡ â‰¥ 98%

### åŠŸèƒ½å®Œæ•´æ€§æŒ‡æ ‡

- **SC-008**: æ‰€æœ‰éœ€è¦ user_access_token çš„ aPaaS API éƒ½èƒ½è‡ªåŠ¨ä½¿ç”¨ WebSocket æˆæƒ
- **SC-009**: WebSocket è¿æ¥å¤±è´¥æ—¶èƒ½åœ¨5åˆ†é’Ÿå†…è§¦å‘å‘Šè­¦
- **SC-010**: è¿‡æœŸä¼šè¯æ¸…ç†å‡†ç¡®ç‡ 100%

### å®‰å…¨æ€§æŒ‡æ ‡

- **SC-011**: 100% çš„ WebSocket äº‹ä»¶ç»è¿‡ç­¾åéªŒè¯
- **SC-012**: 100% çš„ user_access_token åŠ å¯†å­˜å‚¨
- **SC-013**: æ—¥å¿—ä¸­ 0% çš„æ•æ„Ÿä¿¡æ¯ä»¥æ˜æ–‡å‡ºç°

---

## Assumptions

### æŠ€æœ¯å‡è®¾

1. lark-oapi SDK (v1.5.2+) çš„ `lark.ws.Client` ç¨³å®šå¯ç”¨
2. é£ä¹¦ä¼šç¼“å­˜æœªé€è¾¾çš„äº‹ä»¶,é‡è¿åè‡ªåŠ¨æ¨é€
3. `user_auth_sessions` è¡¨å·²é€šè¿‡ Alembic åˆ›å»º
4. é¡¹ç›®å·²éƒ¨åˆ†å¼‚æ­¥åŒ–,æ”¯æŒ asyncio

### ä¸šåŠ¡å‡è®¾

1. ç”¨æˆ·æˆæƒæˆåŠŸç‡ç›®æ ‡ 95%
2. é£ä¹¦ user_access_token æœ‰æ•ˆæœŸ 7-30 å¤©
3. é£ä¹¦æä¾› Token åˆ·æ–° API
4. æˆæƒèŒƒå›´å›ºå®šä¸º "aPaaS æ•°æ®ç©ºé—´è¯»å†™"

### è¿ç»´å‡è®¾

1. ç”Ÿäº§ç¯å¢ƒç½‘ç»œç¨³å®š,WebSocket ä¸­æ–­é¢‘ç‡ < 1æ¬¡/å¤©
2. PostgreSQL èƒ½æ‰¿å—æ¯ç§’ 100 æ¬¡æˆæƒä¼šè¯æŸ¥è¯¢
3. Prometheus å’Œ Grafana å·²éƒ¨ç½²
4. ç³»ç»Ÿæ”¯æŒå®šæ—¶ä»»åŠ¡(cron/APScheduler)

---

## Dependencies

### å¤–éƒ¨ä¾èµ–

1. **lark-oapi SDK** (v1.5.2+): `lark.ws.Client` å’Œ `EventDispatcherHandler`
2. **é£ä¹¦ OpenAPI**:
   - `/open-apis/authen/v1/access_token` - æ¢å– Token
   - `/open-apis/im/v1/messages/create` - å‘é€å¡ç‰‡
3. **é£ä¹¦å¡ç‰‡æ¨¡æ¿**: éœ€è¦åˆ›å»ºæˆæƒå¡ç‰‡æ¨¡æ¿

### å†…éƒ¨ä¾èµ–

1. **Phase 2 (Token ç®¡ç†)**: å¤ç”¨ `user_auth_sessions` è¡¨å’Œ CredentialPool
2. **Phase 3 (æ¶ˆæ¯æœåŠ¡)**: ä½¿ç”¨ MessagingClient å‘é€å¡ç‰‡
3. **Phase 3 (CardKit)**: ä½¿ç”¨ CardBuilder æ„å»ºæˆæƒå¡ç‰‡(æ”¯æŒè‡ªå®šä¹‰æ¨¡æ¿)
4. **Phase 5 (aPaaS)**: å¢å¼º aPaaS å®¢æˆ·ç«¯æ”¯æŒ user_access_token

### åŸºç¡€è®¾æ–½ä¾èµ–

1. PostgreSQL æ•°æ®åº“(å·²åº”ç”¨ Alembic è¿ç§»)
2. Prometheus + Grafana (å¯é€‰,ç”¨äºç›‘æ§)
3. æ—¥å¿—ç³»ç»Ÿ(JSON æ ¼å¼ç»“æ„åŒ–æ—¥å¿—)
4. ç½‘ç»œ(å…è®¸ WebSocket è¿æ¥åˆ°é£ä¹¦æœåŠ¡å™¨)

---

## Out of Scope

ä»¥ä¸‹åŠŸèƒ½**ä¸åœ¨æœ¬åŠŸèƒ½èŒƒå›´å†…**:

1. **OAuth 2.0 HTTP å›è°ƒæ–¹æ¡ˆ** - ä»…å®ç° WebSocket æ–¹æ¡ˆ
2. **æˆæƒèŒƒå›´åŠ¨æ€è°ƒæ•´** - æˆæƒèŒƒå›´å›ºå®š
3. **å¤šåº”ç”¨æˆæƒèšåˆ** - æ¯ä¸ªåº”ç”¨ç‹¬ç«‹ç®¡ç†
4. **æˆæƒå¡ç‰‡å¤šè¯­è¨€** - ä»…æ”¯æŒä¸­æ–‡
5. **æˆæƒç®¡ç† Web UI** - ä»…æä¾› API å’Œ CLI

---

## Notes

### å®ç°å»ºè®®

1. **å‚è€ƒ example.py**: ä½¿ç”¨ lark-oapi SDK çš„ `lark.ws.Client` å’Œ `EventDispatcherHandler`
2. **å¤ç”¨ç°æœ‰ç»„ä»¶**: å°½é‡å¤ç”¨ CredentialPool å’Œ MessagingClient
3. **æµ‹è¯•é©±åŠ¨å¼€å‘**: å…ˆå†™æµ‹è¯•,åå†™å®ç°
4. **æ—¥å¿—ä¼˜å…ˆ**: åœ¨å…³é”®æ­¥éª¤æ·»åŠ ç»“æ„åŒ–æ—¥å¿—

### æŠ€æœ¯é€‰å‹

1. **å¼‚æ­¥å®ç°**: ä½¿ç”¨ asyncio,ä¸ WebSocket ç‰¹æ€§åŒ¹é…
2. **äº‹ä»¶åˆ†å‘**: ä½¿ç”¨ SDK çš„ EventDispatcherHandler.builder() æ¨¡å¼
3. **æ•°æ®åº“ ORM**: ä½¿ç”¨ SQLAlchemy 2.0
4. **å¡ç‰‡æ„å»º**: ä½¿ç”¨é£ä¹¦å¡ç‰‡æ­å»ºå·¥å…·åˆ›å»ºæ¨¡æ¿

### é£é™©æç¤º

1. WebSocket ç¨³å®šæ€§é£é™© â†’ å®ç°æ–­çº¿é‡è¿
2. Token åˆ·æ–°æ”¯æŒä¸ç¡®å®š â†’ éœ€éªŒè¯é£ä¹¦ API
3. å¹¶å‘å‹åŠ› â†’ å¢åŠ è¿æ¥æ± å¤§å°æˆ–å¼•å…¥ç¼“å­˜

### åç»­ä¼˜åŒ–

1. v0.3.0: æ”¯æŒå¤šè¯­è¨€æˆæƒå¡ç‰‡
2. v0.3.0: å®ç° OAuth å¤‡ç”¨æ–¹æ¡ˆ
3. v0.4.0: æä¾› Web UI ç®¡ç†ç•Œé¢
4. v0.4.0: æ”¯æŒåŠ¨æ€æˆæƒèŒƒå›´
