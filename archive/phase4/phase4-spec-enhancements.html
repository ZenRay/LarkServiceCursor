

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phase 4 需求补充文档 - CloudDoc &amp; Contact &mdash; Lark Service 0.2.0 文档</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=ad3000b3"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/translations.js?v=beaddf03"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Lark Service
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">快速开始</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Lark Service - 项目文档索引</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#id1">🎯 快速导航</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#id2">📚 核心文档 (25+)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id3">1. 产品与规格 (4个)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#api-5">2. 架构与API (5个)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id4">3. 开发指南 (6个)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id5">4. 部署与配置 (6个)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id6">5. 功能特性 (2个) 🆕</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id7">6. 技术专题 (3个)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id8">7. 发布说明 (1个) 🆕</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#id9">📊 项目状态与报告</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#v0-5-0">当前状态 (v0.5.0) 🎉</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id10">检查清单</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id11">历史归档</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#id12">🔧 模块使用说明</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#core">Core 核心模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#messaging">Messaging 消息模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#clouddoc">CloudDoc 云文档模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#contact">Contact 通讯录模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#cardkit">CardKit 卡片模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#apaas">aPaaS 数据空间模块</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#id13">📖 快速开始</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id14">1. 查看项目概览</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id15">2. 本地开发</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id16">3. 代码质量检查</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#git">4. Git工作流</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#id17">📋 项目规范</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id18">代码规范</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id19">Git规范</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id20">质量门禁</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#id21">🔍 相关资源</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id22">官方文档</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id23">项目链接</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id24">项目指标</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#id25">📞 获取帮助</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id26">问题排查</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../README.html#id27">文档导航</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">安装指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#id2">环境要求</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#pip">使用 pip 安装</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#id3">开发环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#id4">生产环境</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#docker">使用 Docker 部署</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#id5">1. 克隆项目</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#id6">2. 配置环境变量</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#id7">3. 启动服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#id8">4. 运行数据库迁移</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#id9">5. 配置飞书应用</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#id10">验证安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#id11">下一步</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">5分钟快速开始</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#id2">前置条件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#id3">步骤 1: 安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#id4">步骤 2: 配置环境变量</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#id5">步骤 3: 初始化数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#id6">步骤 4: 添加飞书应用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#id">步骤 5: 获取接收者 ID</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#id7">方式 1: 群聊 ID（推荐用于测试）</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#open-id">方式 2: 用户 open_id</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#id8">步骤 6: 发送第一条消息</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#id9">步骤 7: 发送交互式卡片</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#id10">🎉 完成！</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#id11">下一步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#id12">常见问题</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#q-open-id">Q: 如何获取用户的 open_id？</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#q-token">Q: 如何处理 token 过期？</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#q">Q: 如何启用日志？</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../quick-reference.html">代码质量检查工具快速参考</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../quick-reference.html#id2">🎯 核心命令</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../quick-reference.html#id3">日常开发流程</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quick-reference.html#id4">辅助命令</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../quick-reference.html#id5">📋 检查内容详解</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../quick-reference.html#git-check">git check 会运行以下检查：</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quick-reference.html#id6">关键配置差异</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../quick-reference.html#id7">⚙️ 配置文件对应关系</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quick-reference.html#id8">🔧 常见问题</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../quick-reference.html#q1-mypy-commit">Q1: 为什么本地 mypy 通过，但 commit 失败？</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quick-reference.html#q2-tests">Q2: tests/ 的类型注解错误要修复吗？</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quick-reference.html#q3">Q3: 如何只检查特定目录？</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../quick-reference.html#id9">📖 完整工作流示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quick-reference.html#id10">🚀 首次设置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quick-reference.html#id11">📚 更多信息</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">使用指南</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage/app-management.html">应用管理 (Application Management)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../usage/app-management.html#id1">概述</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id2">核心概念</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/app-management.html#app-id">5层 app_id 解析优先级</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/app-management.html#id3">场景 1: 单应用场景</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id4">示例代码</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id5">返回值示例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/app-management.html#id6">场景 2: 多应用场景 - 客户端级别默认值</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id7">示例代码</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id8">返回值示例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/app-management.html#id9">场景 3: 动态切换应用 - 使用上下文管理器</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id10">示例代码</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id11">输出示例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/app-management.html#id12">场景 4: 方法参数覆盖 - 最高优先级</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id13">示例代码</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id14">返回值示例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/app-management.html#id15">场景 5: 嵌套上下文管理器</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id16">示例代码</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id17">输出示例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/app-management.html#id18">实用工具方法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id">获取当前应用 ID</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id19">列出所有可用应用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id20">输出示例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/app-management.html#id21">错误处理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id22">未指定 app_id</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id23">应用不存在</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/app-management.html#id24">线程安全注意事项</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id25">推荐做法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/app-management.html#id26">示例代码</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/app-management.html#id27">最佳实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/app-management.html#id28">相关文档</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/messaging.html">消息服务</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../usage/messaging.html#id2">基本用法</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/messaging.html#id3">应用管理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/messaging.html#id4">快速示例</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/card.html">卡片服务</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../usage/card.html#id2">功能特点</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/card.html#id3">快速开始</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#id4">基础使用</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/card.html#id5">预定义卡片模板</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#notification-card">1. 通知卡片 (Notification Card)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#approval-card">2. 审批卡片 (Approval Card)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#form-card">3. 表单卡片 (Form Card)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/card.html#id6">自定义卡片构建</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#build-card">使用 build_card 方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#id7">常用卡片元素</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../usage/card.html#div">文本元素 (div)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../usage/card.html#markdown">Markdown 文本</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../usage/card.html#button">按钮 (button)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../usage/card.html#hr">分割线 (hr)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../usage/card.html#img">图片 (img)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../usage/card.html#column-set">多列布局 (column_set)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/card.html#id8">卡片交互回调</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#id9">设置回调服务器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#id10">卡片回调数据结构</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/card.html#id11">更新卡片</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#cardupdater">使用 CardUpdater</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#id12">在回调中更新卡片</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/card.html#id13">高级用法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#id14">条件渲染</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#id15">数据绑定</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#id16">卡片链</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/card.html#id17">最佳实践</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#id18">1. 卡片设计原则</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#id19">2. 错误处理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#id20">3. 回调安全验证</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#id21">4. 性能优化</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/card.html#id22">故障排查</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#id23">卡片发送失败</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/card.html#id24">回调未触发</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/card.html#id25">相关文档</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/contact.html">通讯录服务</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../usage/contact.html#id2">应用管理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/contact.html#id3">快速示例</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/clouddoc.html">云文档服务</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../usage/clouddoc.html#id2">应用管理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/clouddoc.html#id3">快速示例</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/apaas.html">aPaaS 数据空间</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../usage/apaas.html#id1">应用管理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/apaas.html#id2">快速示例</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/auth.html">WebSocket 用户授权</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../usage/auth.html#id1">概述</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id2">核心特性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id3">授权流程</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/auth.html#id4">前置条件</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id5">1. 数据库配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id6">2. 飞书应用配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id7">3. 环境变量</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/auth.html#id8">基本用法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id9">初始化组件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id10">发送授权卡片</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id11">检查授权状态</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#user-access-token">使用 user_access_token</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/auth.html#id12">高级用法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id13">自定义授权卡片</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#token">Token 自动刷新</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id14">会话管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id15">清理过期会话</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/auth.html#id16">WebSocket 事件处理（可选）</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/auth.html#id17">生产部署注意事项</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id18">1. 公网访问要求</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../usage/auth.html#id19">开发环境方案</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../usage/auth.html#id20">生产环境方案</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id21">2. 回调服务器配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#oauth-redirect-uri">3. 配置 OAuth Redirect URI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id22">4. 环境变量</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/auth.html#id23">错误处理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id24">常见错误</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../usage/auth.html#id25">1. 授权码过期</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../usage/auth.html#id26">2. Token 刷新失败</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../usage/auth.html#id27">3. 会话不存在</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/auth.html#id28">监控指标</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/auth.html#id29">完整示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/auth.html#id30">限制与注意事项</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id31">⚠️ 公网要求</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id32">⚠️ 授权流程</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/auth.html#id33">⚠️ Token 管理</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/auth.html#id34">相关文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/auth.html#api">API 参考</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/scheduler.html">Scheduler 定时任务</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../usage/scheduler.html#id1">功能特点</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/scheduler.html#id2">快速开始</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#id3">基础用法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#id4">使用预定义任务</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/scheduler.html#id5">预定义任务</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#sync-user-info">1. 用户信息同步 (<code class="docutils literal notranslate"><span class="pre">sync_user_info</span></code>)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#token-check-token-expiry">2. Token 过期检查 (<code class="docutils literal notranslate"><span class="pre">check_token_expiry</span></code>)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#token-cleanup-expired-tokens">3. 过期 Token 清理 (<code class="docutils literal notranslate"><span class="pre">cleanup_expired_tokens</span></code>)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#scheduler-health-check">4. 健康检查 (<code class="docutils literal notranslate"><span class="pre">scheduler_health_check</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/scheduler.html#id6">自定义任务</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#id7">创建自定义任务</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#interval-job">Interval Job 选项</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#cron-job">Cron Job 表达式</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/scheduler.html#id8">任务管理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#id9">查看所有任务</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#id10">移除任务</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/scheduler.html#docker">Docker 中运行</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/scheduler.html#prometheus">Prometheus 监控</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#id11">任务执行计数器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#id12">任务执行时长</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#grafana">Grafana 查询示例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/scheduler.html#id13">最佳实践</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#id14">1. 错误处理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#id15">2. 超时控制</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#id16">3. 幂等性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#id17">4. 分布式锁</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/scheduler.html#id18">故障排查</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#id19">任务未执行</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/scheduler.html#id20">任务执行失败</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/scheduler.html#id21">下一步</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/advanced.html">高级用法</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../usage/advanced.html#id2">目录</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/advanced.html#id3">多应用管理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/advanced.html#id4">动态应用切换策略</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/advanced.html#id5">多服务客户端协同</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/advanced.html#id6">自定义重试策略</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/advanced.html#id7">批量操作优化</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/advanced.html#id8">批量发送消息</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/advanced.html#apaas">批量创建aPaaS记录</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/advanced.html#id9">错误处理最佳实践</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/advanced.html#id10">分级错误处理</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/advanced.html#id11">日志配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/advanced.html#id12">自定义日志级别</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/advanced.html#id13">性能优化</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/advanced.html#token">Token缓存</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/advanced.html#id14">连接池复用</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/advanced.html#id15">安全最佳实践</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../usage/advanced.html#id16">敏感信息保护</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/advanced.html#id17">数据库文件权限</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usage/advanced.html#id18">Token过期处理</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../usage/advanced.html#id19">相关文档</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API 参考</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api-examples.html">API使用示例</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api-examples.html#id1">快速开始</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-examples.html#id2">消息发送示例</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api-examples.html#id3">发送文本消息</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-examples.html#id4">发送富文本消息</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-examples.html#id5">发送卡片消息</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api-examples.html#id6">通讯录操作示例</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api-examples.html#id7">获取用户信息</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-examples.html#id8">查询部门信息</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api-examples.html#id9">云文档操作示例</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api-examples.html#id10">操作电子表格</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-examples.html#id11">操作多维表格</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api-examples.html#id12">完整应用示例</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api-examples.html#id13">消息通知机器人</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api-rate-limiting-guide.html">API速率限制配置指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api-rate-limiting-guide.html#id1">📋 概述</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-rate-limiting-guide.html#id2">🎯 限流策略</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#fixed-window">1. 固定窗口（Fixed Window）</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#sliding-window">2. 滑动窗口（Sliding Window）</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#token-bucket">3. 令牌桶（Token Bucket）</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api-rate-limiting-guide.html#id3">⚙️ 配置方法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#id4">环境变量配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#id5">代码配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#fastapi">FastAPI中间件集成</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api-rate-limiting-guide.html#id6">📊 预定义限流配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-rate-limiting-guide.html#id7">🔍 响应头</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#too-many-requests">429 Too Many Requests响应</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api-rate-limiting-guide.html#id8">🧪 测试速率限制</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#id9">单元测试</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#id10">压力测试</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#id11">手动测试</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api-rate-limiting-guide.html#id12">📈 监控指标</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#grafana">Grafana告警</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api-rate-limiting-guide.html#id13">🎯 最佳实践</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#id14">1. 选择合适的限流策略</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#id15">2. 合理设置限额</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#id16">3. 提供清晰的错误信息</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#id17">4. 客户端重试策略</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#id18">5. 用户标识</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api-rate-limiting-guide.html#id19">⚠️ 注意事项</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#id20">分布式部署</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#id21">白名单</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#id22">成本考虑</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api-rate-limiting-guide.html#id23">🔧 故障排查</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#id24">问题1: 频繁触发限流</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#id25">问题2: 限流不生效</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-rate-limiting-guide.html#id26">问题3: 性能影响</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api-rate-limiting-guide.html#id27">📚 参考资料</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/core.html">核心模块</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/auth.html">认证模块</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/messaging.html">消息模块</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/contact.html">通讯录模块</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/clouddoc.html">云文档模块</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/apaas.html">aPaaS 模块</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/events.html">事件模块</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/scheduler.html">调度模块</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/services.html">服务模块</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/monitoring.html">监控模块</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/server.html">服务器模块</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/utils.html">工具模块</a><ul class="simple">
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">部署与运维</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html">LarkService 生产环境部署指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id1">目录</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id2">系统要求</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id3">硬件要求</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id4">软件要求</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id5">前置准备</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#docker-docker-compose">1. 安装 Docker 和 Docker Compose</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id6">2. 获取代码</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id7">3. 配置飞书应用</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id8">环境配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id9">1. 创建环境变量文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#env">2. 编辑 <code class="docutils literal notranslate"><span class="pre">.env</span></code> 文件</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id10">基础配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id11">飞书应用配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id12">数据库配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#rabbitmq">RabbitMQ 配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id13">监控配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#token">Token 监控配置</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id14">部署步骤</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id15">1. 构建镜像</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id16">2. 启动服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id17">3. 验证部署</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id18">检查服务健康状态</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id19">验证数据库连接</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id20">验证 RabbitMQ</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id21">监控配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#prometheus">1. Prometheus</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#grafana">2. Grafana</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id22">访问 Grafana</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id23">导入仪表板</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id24">导入步骤</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id25">3. 告警规则</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id26">运维管理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id27">日常维护</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id28">查看日志</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id29">重启服务</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id30">更新服务</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id31">数据备份</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#postgresql">PostgreSQL 备份</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id32">恢复备份</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id33">日志轮转</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id34">故障排查</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id35">常见问题</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id36">1. 服务无法启动</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id37">2. Token 刷新失败</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id38">3. 数据库连接失败</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id39">4. Prometheus 无法抓取指标</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id40">性能优化</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id41">数据库优化</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id42">Token 缓存优化</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id43">安全加固</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id44">1. 网络隔离</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#https">2. 使用 HTTPS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id45">3. 密钥管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id46">4. 最小权限原则</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id47">扩展部署</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id48">高可用部署</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id49">多实例部署</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id50">负载均衡</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#kubernetes">Kubernetes 部署</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id51">联系与支持</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#id52">附录</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#a">A. 端口列表</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#b">B. 环境变量完整列表</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/PRODUCTION_DEPLOYMENT.html#c-docker-compose">C. Docker Compose 服务依赖图</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../deployment.html">部署指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../deployment.html#id2">快速链接</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment.html#id3">2. 依赖服务部署</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#postgresql">2.1 PostgreSQL 部署</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment.html#docker">本地开发 (Docker)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment.html#id4">生产环境 (云服务)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment.html#fr-118-new">数据备份与恢复 (FR-118) ⭐ NEW</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#rabbitmq">2.2 RabbitMQ 部署</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment.html#id5">本地开发 (Docker)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment.html#id6">生产环境 (云服务)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#docker-compose">2.3 Docker Compose 一键部署</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment.html#id7">3. 集成方式选择</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id8">3.1 子项目集成 (推荐) ⭐</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#pypi">3.2 PyPI 包安装 (备选)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id9">3.3 集成方式对比</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment.html#id10">4. 在不同应用中使用</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#django">4.1 Django 应用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#flask">4.2 Flask 应用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#apache-airflow">4.3 Apache Airflow</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#fastapi">4.4 FastAPI 应用</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment.html#id11">5. 环境变量配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id12">5.1 必需环境变量</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id13">5.2 生成加密密钥</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id14">5.3 不同环境的配置管理</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment.html#id15">开发环境</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment.html#id16">测试环境</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment.html#id17">生产环境</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment.html#id18">6. 初始化应用配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#cli">5.1 使用 CLI 添加应用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#python-api">5.2 使用 Python API 添加应用</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment.html#id19">7. 数据库迁移</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#alembic">6.1 初始化 Alembic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id20">6.2 执行迁移</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id21">6.3 创建新迁移</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment.html#id22">8. 健康检查</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id23">7.1 数据库连接检查</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id24">7.2 RabbitMQ 连接检查</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment.html#id25">9. 监控和日志</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id26">8.1 日志配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id27">8.2 监控指标</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment.html#id28">10. 安全最佳实践</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id29">9.1 密钥管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id30">9.2 网络安全</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id31">9.3 数据库安全</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment.html#id32">10. 故障排查</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id33">10.1 常见问题</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id34">10.2 调试模式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id35">10.3 查看日志</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment.html#id36">11. 性能优化</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id37">11.1 数据库优化</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id38">11.2 连接池配置</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment.html#id39">12. 备份和恢复</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id40">12.1 备份策略概览</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id41">12.2 自动化备份脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id42">12.3 PostgreSQL 备份</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#sqlite">12.4 SQLite 配置备份</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id43">12.5 数据库迁移回滚</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id44">12.6 备份验证</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment.html#id45">12.7 灾难恢复演练</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring.html">监控指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../monitoring.html#prometheus">Prometheus 监控</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../monitoring.html#id2">关键指标</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../monitoring.html#websocket">WebSocket 连接</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../monitoring.html#id3">授权流程</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../monitoring.html#token">Token 管理</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../observability-guide.html">可观测性与监控指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../observability-guide.html#id2">📊 可观测性目标</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../observability-guide.html#id3">三大支柱</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../observability-guide.html#chk088-chk089">📝 日志规范 (CHK088, CHK089)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../observability-guide.html#id4">日志格式标准</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../observability-guide.html#chk088">构建日志规范 (CHK088)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../observability-guide.html#chk089">配置加载日志 (CHK089)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../observability-guide.html#id5">关键操作日志</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../observability-guide.html#chk030-chk090">📈 健康检查 (CHK030, CHK090)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../observability-guide.html#chk030">健康检查响应时间阈值 (CHK030)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../observability-guide.html#id6">健康检查端点实现</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../observability-guide.html#chk090">监控指标 (CHK090)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../observability-guide.html#kubernetes">Kubernetes 健康检查配置</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../observability-guide.html#grafana">📊 Grafana 仪表盘</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../observability-guide.html#id7">推荐仪表盘</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../observability-guide.html#id8">告警规则</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../observability-guide.html#id9">✅ 可观测性检查清单</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../observability-guide.html#id10">日志检查</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../observability-guide.html#id11">指标检查</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../observability-guide.html#id12">健康检查</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../observability-guide.html#id13">告警检查</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../grafana-setup-guide.html">Grafana配置指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../grafana-setup-guide.html#id1">1. 访问Grafana</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../grafana-setup-guide.html#prometheus">2. 配置Prometheus数据源</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../grafana-setup-guide.html#id2">步骤 1: 添加数据源</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../grafana-setup-guide.html#id3">步骤 2: 配置参数</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../grafana-setup-guide.html#id4">步骤 3: 保存并测试</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../grafana-setup-guide.html#lark-service">3. 导入Lark Service监控仪表板</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../grafana-setup-guide.html#id5">方法 1: 从文件导入</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../grafana-setup-guide.html#json">方法 2: 直接粘贴JSON</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../grafana-setup-guide.html#id6">4. 仪表板内容</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../grafana-setup-guide.html#http">HTTP性能</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../grafana-setup-guide.html#token">Token管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../grafana-setup-guide.html#api">API调用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../grafana-setup-guide.html#id7">系统资源</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../grafana-setup-guide.html#id8">业务指标</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../grafana-setup-guide.html#id9">5. 告警配置（可选）</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../grafana-setup-guide.html#id10">创建告警规则</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../grafana-setup-guide.html#id11">推荐告警</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../grafana-setup-guide.html#id12">6. 自定义面板</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../grafana-setup-guide.html#id13">添加新面板</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../grafana-setup-guide.html#promql">常用PromQL查询</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../grafana-setup-guide.html#id14">7. 故障排查</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../grafana-setup-guide.html#id15">问题: 仪表板无数据</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../grafana-setup-guide.html#id16">问题: 指标值为0</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../grafana-setup-guide.html#id17">8. 相关链接</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tracing-guide.html">分布式追踪配置指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tracing-guide.html#id2">📋 概述</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tracing-guide.html#id3">🎯 追踪策略</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tracing-guide.html#request-id">Request ID 规范</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tracing-guide.html#id4">🔧 实现方案</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tracing-guide.html#id5">1. Request ID 生成器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tracing-guide.html#fastapi">2. FastAPI 中间件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tracing-guide.html#id6">3. 异步任务追踪</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tracing-guide.html#id7">4. 飞书回调追踪</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tracing-guide.html#id8">📊 追踪字段标准</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tracing-guide.html#id9">日志必需字段</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tracing-guide.html#id10">跨服务传递</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tracing-guide.html#id11">🔍 追踪查询</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tracing-guide.html#elasticsearch-kibana">Elasticsearch/Kibana 查询</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tracing-guide.html#grafana-loki">Grafana Loki 查询</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tracing-guide.html#postgresql">PostgreSQL 慢查询关联</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tracing-guide.html#id12">📈 追踪指标</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tracing-guide.html#prometheus-metrics">Prometheus Metrics</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tracing-guide.html#id13">🚀 最佳实践</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tracing-guide.html#id14">1. 始终传播 request_id</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tracing-guide.html#id15">2. 异步任务包含原始 request_id</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tracing-guide.html#id16">3. 错误日志包含完整上下文</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tracing-guide.html#id17">4. 性能追踪</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tracing-guide.html#id18">🔗 相关文档</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">故障排查</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#id2">常见问题</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../troubleshooting.html#id3">数据库连接失败</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../troubleshooting.html#token">Token 获取失败</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../troubleshooting.html#oauth">OAuth 回调失败</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../error-codes.html">错误码文档</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../error-codes.html#xxx">系统错误码 (1xxx)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../error-codes.html#token-2xxx">Token错误码 (2xxx)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../error-codes.html#api-3xxx">API错误码 (3xxx)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../error-codes.html#api-99991xxx">飞书API错误码 (99991xxx)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../error-codes.html#id2">业务错误码 (4xxx)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../error-codes.html#id3">使用示例</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../error-handling-guide.html">异常处理与恢复策略指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../error-handling-guide.html#id2">核心原则</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../error-handling-guide.html#chk052">启动失败处理 (CHK052)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../error-handling-guide.html#id3">退出码规范</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../error-handling-guide.html#id4">配置加载失败</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../error-handling-guide.html#id5">数据库连接失败</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../error-handling-guide.html#id6">服务降级策略</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../error-handling-guide.html#chk058">数据库初始化回滚 (CHK058)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../error-handling-guide.html#alembic">Alembic 迁移失败</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../error-handling-guide.html#sqlite">SQLite 初始化失败</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../error-handling-guide.html#id7">运行时错误处理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../error-handling-guide.html#api">API 调用错误</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../error-handling-guide.html#id8">数据库错误</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../error-handling-guide.html#id9">自动恢复场景</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../error-handling-guide.html#id10">检查清单</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../error-recovery-guide.html">错误恢复指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../error-recovery-guide.html#id2">目录</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../error-recovery-guide.html#token">Token相关错误</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../error-recovery-guide.html#token-99991663">错误1: Token过期 (99991663)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../error-recovery-guide.html#id3">错误2: 凭据无效 (99991400/99991401)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../error-recovery-guide.html#id4">数据库连接错误</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../error-recovery-guide.html#id5">错误3: 数据库连接失败</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../error-recovery-guide.html#id6">错误4: 数据库死锁</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../error-recovery-guide.html#api">API调用错误</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../error-recovery-guide.html#api-99991405">错误5: API限流 (99991405)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../error-recovery-guide.html#id7">错误6: 网络超时</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../error-recovery-guide.html#id8">缓存错误</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../error-recovery-guide.html#redis">错误7: Redis连接失败</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../error-recovery-guide.html#id9">错误8: 缓存雪崩</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../error-recovery-guide.html#id10">配置错误</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../error-recovery-guide.html#id11">错误9: 环境变量缺失</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../error-recovery-guide.html#id12">消息队列错误</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../error-recovery-guide.html#rabbitmq">错误10: RabbitMQ连接失败</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../error-recovery-guide.html#id13">通用恢复策略</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../error-recovery-guide.html#id14">1. 健康检查</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../error-recovery-guide.html#id15">2. 日志分析</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../error-recovery-guide.html#id16">3. 监控告警</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../error-recovery-guide.html#id17">4. 回滚策略</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../error-recovery-guide.html#id18">5. 紧急联系</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../error-recovery-guide.html#id19">最佳实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../error-recovery-guide.html#id20">相关文档</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../security-guide.html">安全配置指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../security-guide.html#blocker">🚨 安全需求清单 (Blocker)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#must">配置安全 (MUST)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#id2">密钥管理 (MUST)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#id3">依赖安全 (MUST)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#id4">容器安全 (MUST)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#id5">环境隔离 (MUST)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../security-guide.html#id6">🔐 加密密钥管理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#id7">密钥作用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#id8">为什么需要加密?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../security-guide.html#id9">🚀 部署配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#id10">开发环境</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../security-guide.html#id11">1. 生成加密密钥</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../security-guide.html#env">2. 配置 .env 文件</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../security-guide.html#id12">3. 重要提醒</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#id13">生产环境</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../security-guide.html#a">方案 A: 系统环境变量 (推荐)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../security-guide.html#b-docker-secrets">方案 B: Docker Secrets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../security-guide.html#c-kubernetes-secrets">方案 C: Kubernetes Secrets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../security-guide.html#d">方案 D: 云服务密钥管理</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../security-guide.html#id14">🔄 密钥轮换</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#id15">何时需要轮换密钥?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#id16">轮换步骤</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../security-guide.html#id17">📁 文件权限管理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#sqlite-fr-079-fr-080">SQLite 配置文件权限 (FR-079, FR-080)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#env-fr-094">生产环境 .env 文件权限 (FR-094)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../security-guide.html#fr-081">🔖 配置敏感度分类 (FR-081)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#public">Public (公开级)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#internal">Internal (内部级)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#secret">Secret (机密级)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#fr-084">日志脱敏规则 (FR-084)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../security-guide.html#id18">🛡️ 依赖安全管理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#fr-086">安全扫描工具 (FR-086)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#fr-087">依赖更新策略 (FR-087)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#fr-088">依赖版本锁定 (FR-088)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../security-guide.html#id19">🐳 容器安全</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#docker-fr-089-fr-091">Docker 镜像最佳实践 (FR-089, FR-091)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#fr-090">镜像安全扫描 (FR-090)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#ci-cd">CI/CD 集成示例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../security-guide.html#id20">🔄 密钥轮换流程</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#cli-fr-083">CLI 密钥轮换命令 (FR-083)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#id21">轮换频率建议</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../security-guide.html#id22">✅ 安全检查清单</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#id23">开发环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#id24">生产环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#id25">数据库</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../security-guide.html#id26">🔍 常见问题</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#q1">Q1: 如果忘记了加密密钥怎么办?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#q2-123456">Q2: 可以使用弱密钥吗 (如 &quot;123456&quot;)?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#q3">Q3: 多个环境可以共用一个密钥吗?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#q4">Q4: 数据库文件可以直接复制到其他环境吗?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security-guide.html#q5">Q5: 如何验证密钥是否正确?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../security-guide.html#id27">📚 相关文档</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">架构与设计</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html">飞书 Token 刷新机制详解</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#id1">📋 概述</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#id2">🔑 Token 类型</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#app-access-token">1. App Access Token (应用级访问令牌)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#tenant-access-token">2. Tenant Access Token (租户级访问令牌)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#user-access-token">3. User Access Token (用户级访问令牌)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#id3">🔄 Token 类型对比总结</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#id4">🚨 常见误区</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#token-app-secret">❌ 误区 1: Token 过期就需要重新生成 app_secret</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#id5">❌ 误区 2: 所有 Token 都需要监控过期</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#id6">❌ 误区 3: Token 刷新失败就是 app_secret 的问题</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#id7">📊 监控和通知策略</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#app-access-token-tenant-access-token">App Access Token / Tenant Access Token</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#id8">User Access Token</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#larkservice">🔧 LarkService 实现细节</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#credentialpool">CredentialPool 自动刷新逻辑</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#tokenexpirymonitor">TokenExpiryMonitor 智能通知</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#id9">🎯 最佳实践</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#id10">1. 定期任务配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#id11">2. 通知内容模板</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#refresh-token-7">Refresh Token 7 天预警</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#refresh-token-3">Refresh Token 3 天严重警告</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#refresh-token">Refresh Token 已过期</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#id12">📚 参考资料</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture/token-refresh-mechanism.html#id13">🤝 感谢</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture.html">Lark Service 架构设计文档</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../architecture.html#id1">1. 系统概述</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id2">1.1 设计目标</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id3">1.2 核心特性</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture.html#id4">2. 系统架构</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id5">2.1 完整系统架构图</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id6">2.2 数据流图</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../architecture.html#id7">2.2.1 发送消息流程</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../architecture.html#id8">2.2.2 用户查询流程 (带缓存)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../architecture.html#token">2.2.3 Token 自动刷新流程</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id9">2.3 模块依赖关系</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture.html#id10">3. Token 管理架构</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id11">3.1 Token 生命周期</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id12">3.2 并发控制</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture.html#id13">5. 安全架构</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id14">5.1 加密策略</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id15">5.2 零信任原则</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture.html#id16">6. 性能优化</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id17">6.1 缓存策略</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id18">6.2 连接池</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id19">6.3 重试策略</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture.html#id20">7. 可观测性</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id21">7.1 日志架构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id22">7.2 监控指标</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id23">7.3 请求追踪</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture.html#id24">8. 部署架构</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id25">8.1 部署架构图</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#docker-compose">8.2 容器化部署 (Docker Compose)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id26">8.3 本地开发</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id27">8.4 生产部署</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture.html#id28">9. 扩展性设计</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id29">9.1 添加新模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../architecture.html#id30">9.2 添加新 Token 类型</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture.html#id31">10. 技术栈总结</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../features/token-monitoring.html">Token 过期监控 (Token Expiry Monitoring)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../features/token-monitoring.html#id1">概述</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#token">Token 类型说明</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#id2">监控功能</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../features/token-monitoring.html#id3">功能特性</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#id4">多级通知机制</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#id5">通知内容</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../features/token-monitoring.html#id6">预警通知 (7 天)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../features/token-monitoring.html#id7">严重警告 (3 天)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#id8">配置监控参数</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#id9">手动检查 Token 状态</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../features/token-monitoring.html#id10">监控和可视化</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#prometheus">Prometheus 指标</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#grafana">Grafana 面板</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#id11">Prometheus 告警</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../features/token-monitoring.html#id12">Token 续期流程</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#id13">在飞书开放平台续期</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#id14">验证更新</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../features/token-monitoring.html#api">API 参考</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#tokenexpirymonitor">TokenExpiryMonitor 类</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../features/token-monitoring.html#id15">最佳实践</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#id16">1. 设置管理员通知</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#id17">2. 定期检查监控面板</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#id18">3. 提前续期</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#id19">4. 建立续期流程</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#id20">5. 配置备用联系方式</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../features/token-monitoring.html#id21">故障排查</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#id22">未收到通知</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#id23">通知发送失败</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../features/token-monitoring.html#id24">Prometheus 指标缺失</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../features/token-monitoring.html#id25">参考资料</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">测试与验证</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html">真实飞书环境集成验证指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id2">📋 验证清单</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id3">1. 配置真实飞书应用凭据</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id4">1.1 创建飞书应用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id5">1.2 获取应用凭证</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id6">1.3 配置应用权限</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id7">消息与群组</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id8">通讯录</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id9">1.4 配置环境变量</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id10">1.5 重启服务</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#app-access-token">2. 验证 App Access Token 自动刷新</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id11">2.1 启动服务并观察日志</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#token">2.2 触发 Token 获取</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#prometheus">2.3 验证 Prometheus 指标</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#user-access-token-oauth">3. 验证 User Access Token OAuth 流程</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#oauth">3.1 配置 OAuth 回调</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id12">3.2 启动 OAuth 授权流程</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id13">3.3 完成授权</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#user-access-token">3.4 交换 User Access Token</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id14">4. 验证 Token 过期通知功能</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id15">4.1 手动触发 Token 过期检查</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id16">4.2 检查飞书消息</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id17">4.3 验证 Prometheus 指标</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#grafana">5. 验证 Grafana 仪表板数据显示</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id18">5.1 访问 Grafana</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id19">5.2 导入仪表板</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id20">导入系统概览仪表板</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id21">导入 Token 监控仪表板</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#scheduler">导入 Scheduler 任务仪表板</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id22">5.3 验证数据显示</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id23">系统概览仪表板</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id24">Token 监控仪表板</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id25">Scheduler 任务仪表板</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id26">5.4 生成测试数据</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id27">6. 验证定时任务执行</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id28">6.1 查看 Scheduler 日志</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id29">6.2 验证任务执行频率</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id30">6.3 查看 Prometheus 指标</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id31">📊 完整验证报告</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id32">功能验证结果</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id33">性能指标</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id34">🐛 常见问题</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#q1-token">Q1: Token 刷新失败</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#q2">Q2: 收不到飞书通知</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#q3-grafana">Q3: Grafana 无数据</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/INTEGRATION_VERIFICATION.html#id35">📝 下一步</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../TESTING-GUIDE.html">测试指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../TESTING-GUIDE.html#id2">📖 概述</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../TESTING-GUIDE.html#id3">🚀 快速开始</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id4">安装测试环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id5">运行测试</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id6">查看覆盖率</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../TESTING-GUIDE.html#id7">📋 覆盖率要求</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id8">整体要求</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id9">覆盖率阈值</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id10">模块覆盖率目标</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../TESTING-GUIDE.html#id11">🎯 测试编写指南</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id12">测试结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#mock">Mock策略</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id13">测试覆盖场景</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../TESTING-GUIDE.html#id14">📊 查看覆盖率报告</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#html">HTML报告</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id15">终端报告</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../TESTING-GUIDE.html#id16">🔧 常用命令</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id17">测试筛选</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id18">调试</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id19">性能</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../TESTING-GUIDE.html#id20">📝 测试命名规范</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id21">文件命名</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id22">类命名</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id23">方法命名</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../TESTING-GUIDE.html#ci-cd">🎯 CI/CD集成</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#github-actions">GitHub Actions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id24">覆盖率检查</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id25">失败处理</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../TESTING-GUIDE.html#id26">📚 参考资源</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#pytest">Pytest文档</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id27">项目示例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../TESTING-GUIDE.html#id28">❓ 常见问题</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#q">Q: 覆盖率不增加?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#q-mock-sdk">Q: 如何Mock SDK?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id29">Q: 测试太慢?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TESTING-GUIDE.html#id30">Q: 覆盖率如何提升?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../integration-test-guide.html">集成测试指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../integration-test-guide.html#id2">📋 测试分类</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#unit-tests">1. 单元测试 (Unit Tests)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#integration-tests">2. 集成测试 (Integration Tests)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../integration-test-guide.html#id3">🔧 配置集成测试环境</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#id4">步骤1: 创建配置文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#id5">步骤2: 填写必需的配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#id6">步骤3: 填写模块测试数据(可选)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../integration-test-guide.html#contact">Contact模块测试</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../integration-test-guide.html#clouddoc">CloudDoc模块测试</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../integration-test-guide.html#id7">🚀 运行集成测试</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#id8">运行所有集成测试</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#id9">运行特定模块的集成测试</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../integration-test-guide.html#id10">Contact模块</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../integration-test-guide.html#id11">CloudDoc模块</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../integration-test-guide.html#bitable">Bitable模块</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../integration-test-guide.html#sheet">Sheet模块</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#id12">运行特定测试类</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../integration-test-guide.html#id13">📊 当前测试状态</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#id14">Contact模块 ✅</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#clouddoc-doc">CloudDoc - Doc客户端 ✅</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#clouddoc-bitable">CloudDoc - Bitable客户端 ⚠️</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#clouddoc-sheet">CloudDoc - Sheet客户端 ⚠️</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../integration-test-guide.html#id15">🔑 权限要求</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#id16">Contact模块权限</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#id17">CloudDoc模块权限</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../integration-test-guide.html#id18">读操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../integration-test-guide.html#id19">写操作(可选)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../integration-test-guide.html#id20">📝 测试数据准备</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#token">获取测试Token</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#id21">配置写权限测试</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../integration-test-guide.html#id22">⚠️ 注意事项</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../integration-test-guide.html#id23">🐛 故障排查</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#id24">测试被跳过</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#id25">认证失败</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#id26">找不到资源</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../integration-test-guide.html#id27">Bitable测试失败</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../integration-test-guide.html#id28">📚 相关文档</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">发布说明</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../releases/v0.5.0.html">LarkService v0.5.0 发布说明</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../releases/v0.5.0.html#id1">📅 发布信息</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/v0.5.0.html#id2">🎯 版本亮点</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id3">1. ✅ 生产环境完整支持</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id4">2. 📊 监控与可观测性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id5">3. ⏰ 定时任务系统</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#token">4. 🔐 Token 管理优化</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/v0.5.0.html#id6">🚀 新功能</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#docker">Docker &amp; 容器化</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id7">监控系统</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#apscheduler">APScheduler 定时任务</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id8">Token 监控增强</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/v0.5.0.html#id9">🔧 改进与优化</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id10">架构改进</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id11">性能优化</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id12">代码质量</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/v0.5.0.html#id13">📖 文档更新</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id14">新增文档</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id15">更新文档</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/v0.5.0.html#breaking-changes">🔄 Breaking Changes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id16">⚠️ 重要变更</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../releases/v0.5.0.html#id17">1. Token 监控逻辑调整</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../releases/v0.5.0.html#id18">2. 环境变量新增</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/v0.5.0.html#bug">🐛 Bug 修复</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/v0.5.0.html#id19">📦 依赖更新</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id20">新增依赖</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id21">更新依赖</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/v0.5.0.html#id22">🔍 已知问题</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id23">限制与待改进</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#v0-6-0">计划改进 (v0.6.0)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/v0.5.0.html#id24">🚀 快速开始</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id25">1. 克隆仓库</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id26">2. 配置环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id27">3. 启动服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id28">4. 验证部署</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/v0.5.0.html#id29">📊 统计数据</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id30">项目规模</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id31">功能模块</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/v0.5.0.html#id32">🙏 致谢</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id33">核心贡献者</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id34">特别感谢</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/v0.5.0.html#id35">📞 获取帮助</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id36">文档资源</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#id37">社区支持</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/v0.5.0.html#id38">🗺️ 未来规划</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#v0-6-0-2026-q2">v0.6.0 (2026-Q2)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v0.5.0.html#v0-7-0-2026-q3">v0.7.0 (2026-Q3)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/v0.5.0.html#id39">📜 许可证</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Lark Service</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Phase 4 需求补充文档 - CloudDoc &amp; Contact</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/archive/phase4/phase4-spec-enhancements.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="phase-4-clouddoc-contact">
<h1>Phase 4 需求补充文档 - CloudDoc &amp; Contact<a class="headerlink" href="#phase-4-clouddoc-contact" title="Link to this heading"></a></h1>
<p><strong>版本</strong>: v1.0
<strong>创建日期</strong>: 2026-01-15
<strong>基于</strong>: Phase 4 需求评审报告
<strong>补充范围</strong>: 数据结构、限制、错误码、性能需求、安全需求等</p>
<p>本文档补充 Phase 4 需求文档中缺失的技术细节,作为 <code class="docutils literal notranslate"><span class="pre">spec.md</span></code> 的附件。</p>
<hr class="docutils" />
<section id="id1">
<h2>目录<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#clouddoc-%E6%A8%A1%E5%9D%97%E8%A1%A5%E5%85%85"><span class="xref myst">CloudDoc 模块补充</span></a></p></li>
<li><p><a class="reference internal" href="#contact-%E6%A8%A1%E5%9D%97%E8%A1%A5%E5%85%85"><span class="xref myst">Contact 模块补充</span></a></p></li>
<li><p><a class="reference internal" href="#%E9%94%99%E8%AF%AF%E7%A0%81%E4%BD%93%E7%B3%BB"><span class="xref myst">错误码体系</span></a></p></li>
<li><p><a class="reference internal" href="#%E9%9D%9E%E5%8A%9F%E8%83%BD%E6%80%A7%E9%9C%80%E6%B1%82"><span class="xref myst">非功能性需求</span></a></p></li>
<li><p><a class="reference internal" href="#%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81%E8%A7%84%E8%8C%83"><span class="xref myst">数据验证规范</span></a></p></li>
</ul>
</section>
<hr class="docutils" />
<section id="clouddoc">
<h2>CloudDoc 模块补充<a class="headerlink" href="#clouddoc" title="Link to this heading"></a></h2>
<section id="id2">
<h3>0. 知识库文档特殊说明 ⚠️<a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<section id="wiki-vs-drive">
<h4>0.1 知识库 (Wiki) vs 云空间 (Drive)<a class="headerlink" href="#wiki-vs-drive" title="Link to this heading"></a></h4>
<p>飞书的云文档可以存放在两个位置,token 获取方式不同:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>存放位置</p></th>
<th class="head"><p>文档标识</p></th>
<th class="head"><p>获取方式</p></th>
<th class="head"><p>API 路径</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>云空间 (Drive)</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">doc_token</span></code></p></td>
<td><p>直接使用文档链接中的 token</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/docx/v1/documents/{document_id}</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>知识库 (Wiki)</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">node_token</span></code></p></td>
<td><p>需要先通过知识库 API 获取</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/wiki/v2/spaces/{space_id}/nodes/{node_token}</span></code></p></td>
</tr>
</tbody>
</table>
</section>
<section id="id3">
<h4>0.2 知识库文档的访问流程<a class="headerlink" href="#id3" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. 通过知识库 API 获取节点信息</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_wiki_node_info</span><span class="p">(</span><span class="n">space_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">node_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;获取知识库节点信息</span>

<span class="sd">    Args:</span>
<span class="sd">        space_id: 知识空间 ID</span>
<span class="sd">        node_token: 节点 token (从知识库链接获取)</span>

<span class="sd">    Returns:</span>
<span class="sd">        节点信息,包含 obj_token (实际的文档 token)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">wiki</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">space_node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">space_id</span><span class="o">=</span><span class="n">space_id</span><span class="p">,</span>
        <span class="n">node_token</span><span class="o">=</span><span class="n">node_token</span>
    <span class="p">)</span>

    <span class="c1"># 2. 从响应中获取实际的文档 token</span>
    <span class="n">obj_token</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">obj_token</span>
    <span class="n">obj_type</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">obj_type</span>  <span class="c1"># &quot;doc&quot;, &quot;sheet&quot;, &quot;bitable&quot; 等</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;obj_token&quot;</span><span class="p">:</span> <span class="n">obj_token</span><span class="p">,</span>  <span class="c1"># 实际的文档 token</span>
        <span class="s2">&quot;obj_type&quot;</span><span class="p">:</span> <span class="n">obj_type</span><span class="p">,</span>    <span class="c1"># 文档类型</span>
        <span class="s2">&quot;node_token&quot;</span><span class="p">:</span> <span class="n">node_token</span> <span class="c1"># 知识库节点 token</span>
    <span class="p">}</span>

<span class="c1"># 3. 使用 obj_token 访问文档内容</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_wiki_document_content</span><span class="p">(</span><span class="n">space_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">node_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;获取知识库文档内容&quot;&quot;&quot;</span>
    <span class="c1"># 先获取节点信息</span>
    <span class="n">node_info</span> <span class="o">=</span> <span class="n">get_wiki_node_info</span><span class="p">(</span><span class="n">space_id</span><span class="p">,</span> <span class="n">node_token</span><span class="p">)</span>
    <span class="n">obj_token</span> <span class="o">=</span> <span class="n">node_info</span><span class="p">[</span><span class="s2">&quot;obj_token&quot;</span><span class="p">]</span>

    <span class="c1"># 使用 obj_token 访问文档</span>
    <span class="k">if</span> <span class="n">node_info</span><span class="p">[</span><span class="s2">&quot;obj_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;doc&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_document_content</span><span class="p">(</span><span class="n">obj_token</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">node_info</span><span class="p">[</span><span class="s2">&quot;obj_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;docx&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_docx_content</span><span class="p">(</span><span class="n">obj_token</span><span class="p">)</span>
    <span class="c1"># ... 其他类型</span>
</pre></div>
</div>
</section>
<section id="url-token">
<h4>0.3 通用文档 URL 解析和 Token 获取工具 ⭐<a class="headerlink" href="#url-token" title="Link to this heading"></a></h4>
<p>这是一个核心工具类,统一处理所有文档 URL 的解析和 token 获取逻辑。</p>
<section id="documenturlresolver">
<h5>0.3.1 完整的 DocumentUrlResolver 工具类<a class="headerlink" href="#documenturlresolver" title="Link to this heading"></a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lark_oapi.api.wiki.v2</span><span class="w"> </span><span class="kn">import</span> <span class="n">SpaceNodeService</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DocumentInfo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;文档信息&quot;&quot;&quot;</span>
    <span class="n">doc_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;docx&quot;</span><span class="p">,</span> <span class="s2">&quot;sheet&quot;</span><span class="p">,</span> <span class="s2">&quot;bitable&quot;</span><span class="p">,</span> <span class="s2">&quot;doc&quot;</span><span class="p">,</span> <span class="s2">&quot;mindnote&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">]</span>
    <span class="n">doc_token</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># 实际可用的文档 token</span>
    <span class="n">source_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;wiki&quot;</span><span class="p">,</span> <span class="s2">&quot;drive&quot;</span><span class="p">]</span>  <span class="c1"># 来源类型</span>

    <span class="c1"># 知识库特有字段</span>
    <span class="n">space_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">node_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># 元数据</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">owner</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DocumentUrlResolver</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;文档 URL 解析和 Token 获取工具</span>

<span class="sd">    统一处理知识库和云空间文档的 URL 解析和 token 获取:</span>
<span class="sd">    - 云空间文档: 通过正则表达式直接提取 doc_token</span>
<span class="sd">    - 知识库文档: 先解析 URL,再调用 API 获取 obj_token</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ==================== URL 格式定义 ====================</span>

    <span class="c1"># 知识库链接格式</span>
    <span class="c1"># 示例: https://example.feishu.cn/wiki/7123456789/wikcnAbCdEfGhIjKlMnOpQr</span>
    <span class="n">WIKI_LINK_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;https://[^/]+/wiki/([^/]+)/([^/?]+)&#39;</span>

    <span class="c1"># 云空间文档链接格式</span>
    <span class="c1"># 示例: https://example.feishu.cn/docx/doxcnAbCdEfGhIjKlMnOpQr</span>
    <span class="n">DRIVE_DOC_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;https://[^/]+/(docx|doc)/([^/?]+)&#39;</span>

    <span class="c1"># 云空间表格链接格式</span>
    <span class="c1"># 示例: https://example.feishu.cn/sheets/shtcnAbCdEfGhIjKlMnOpQr</span>
    <span class="n">DRIVE_SHEET_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;https://[^/]+/sheets?/([^/?]+)&#39;</span>

    <span class="c1"># 云空间多维表格链接格式</span>
    <span class="c1"># 示例: https://example.feishu.cn/base/bascnAbCdEfGhIjKlMnOpQr</span>
    <span class="n">DRIVE_BITABLE_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;https://[^/]+/base/([^/?]+)&#39;</span>

    <span class="c1"># 云空间文件链接格式</span>
    <span class="c1"># 示例: https://example.feishu.cn/file/boxcnAbCdEfGhIjKlMnOpQr</span>
    <span class="n">DRIVE_FILE_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;https://[^/]+/file/([^/?]+)&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wiki_service</span><span class="p">:</span> <span class="n">SpaceNodeService</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;初始化</span>

<span class="sd">        Args:</span>
<span class="sd">            wiki_service: 知识库节点服务 (用于获取知识库文档的 obj_token)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wiki_service</span> <span class="o">=</span> <span class="n">wiki_service</span>

    <span class="c1"># ==================== 主要接口 ====================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DocumentInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;解析文档 URL 并获取可用的 doc_token</span>

<span class="sd">        这是主要的入口方法,自动识别文档类型并获取 token。</span>

<span class="sd">        Args:</span>
<span class="sd">            url: 飞书文档 URL</span>

<span class="sd">        Returns:</span>
<span class="sd">            DocumentInfo: 包含 doc_token 和文档元信息</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: URL 格式无法识别</span>
<span class="sd">            ApiError: 知识库 API 调用失败</span>

<span class="sd">        Examples:</span>
<span class="sd">            # 云空间文档 (直接提取 token)</span>
<span class="sd">            &gt;&gt;&gt; info = resolver.resolve_url(&quot;https://example.feishu.cn/docx/doxcn123&quot;)</span>
<span class="sd">            &gt;&gt;&gt; info.doc_token  # &quot;doxcn123&quot;</span>
<span class="sd">            &gt;&gt;&gt; info.source_type  # &quot;drive&quot;</span>

<span class="sd">            # 知识库文档 (需要调用 API)</span>
<span class="sd">            &gt;&gt;&gt; info = resolver.resolve_url(&quot;https://example.feishu.cn/wiki/7123/wikcn456&quot;)</span>
<span class="sd">            &gt;&gt;&gt; info.doc_token  # &quot;doxcn789&quot; (从 API 获取的 obj_token)</span>
<span class="sd">            &gt;&gt;&gt; info.source_type  # &quot;wiki&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. 尝试解析为云空间文档 (优先,因为不需要 API 调用)</span>
        <span class="n">drive_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_parse_drive_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">drive_info</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">drive_info</span>

        <span class="c1"># 2. 尝试解析为知识库文档 (需要 API 调用)</span>
        <span class="n">wiki_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_parse_wiki_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wiki_info</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wiki_info</span>

        <span class="c1"># 3. 无法识别</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;无法识别的飞书文档链接: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;支持的格式:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  - 知识库: https://xxx.feishu.cn/wiki/</span><span class="se">{{</span><span class="s2">space_id</span><span class="se">}}</span><span class="s2">/</span><span class="se">{{</span><span class="s2">node_token</span><span class="se">}}\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  - 文档: https://xxx.feishu.cn/docx/</span><span class="se">{{</span><span class="s2">doc_token</span><span class="se">}}\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  - 表格: https://xxx.feishu.cn/sheets/</span><span class="se">{{</span><span class="s2">sheet_token</span><span class="se">}}\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  - 多维表格: https://xxx.feishu.cn/base/</span><span class="se">{{</span><span class="s2">base_token</span><span class="se">}}\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  - 文件: https://xxx.feishu.cn/file/</span><span class="se">{{</span><span class="s2">file_token</span><span class="se">}}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_doc_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;快捷方法: 仅获取 doc_token</span>

<span class="sd">        Args:</span>
<span class="sd">            url: 飞书文档 URL</span>

<span class="sd">        Returns:</span>
<span class="sd">            doc_token: 可用的文档 token</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; token = resolver.get_doc_token(&quot;https://example.feishu.cn/docx/doxcn123&quot;)</span>
<span class="sd">            &gt;&gt;&gt; token  # &quot;doxcn123&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">doc_token</span>

    <span class="c1"># ==================== 云空间文档解析 (正则表达式) ====================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_try_parse_drive_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DocumentInfo</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;尝试解析云空间文档 URL (通过正则表达式)</span>

<span class="sd">        云空间文档的 token 可以直接从 URL 中提取,无需 API 调用。</span>

<span class="sd">        Returns:</span>
<span class="sd">            DocumentInfo 或 None (如果不是云空间链接)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. 尝试匹配文档 (docx/doc)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DRIVE_DOC_PATTERN</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">doc_type</span> <span class="o">=</span> <span class="s2">&quot;docx&quot;</span> <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;docx&quot;</span> <span class="k">else</span> <span class="s2">&quot;doc&quot;</span>
            <span class="k">return</span> <span class="n">DocumentInfo</span><span class="p">(</span>
                <span class="n">doc_type</span><span class="o">=</span><span class="n">doc_type</span><span class="p">,</span>
                <span class="n">doc_token</span><span class="o">=</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;drive&quot;</span>
            <span class="p">)</span>

        <span class="c1"># 2. 尝试匹配表格 (sheets)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DRIVE_SHEET_PATTERN</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DocumentInfo</span><span class="p">(</span>
                <span class="n">doc_type</span><span class="o">=</span><span class="s2">&quot;sheet&quot;</span><span class="p">,</span>
                <span class="n">doc_token</span><span class="o">=</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;drive&quot;</span>
            <span class="p">)</span>

        <span class="c1"># 3. 尝试匹配多维表格 (base)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DRIVE_BITABLE_PATTERN</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DocumentInfo</span><span class="p">(</span>
                <span class="n">doc_type</span><span class="o">=</span><span class="s2">&quot;bitable&quot;</span><span class="p">,</span>
                <span class="n">doc_token</span><span class="o">=</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;drive&quot;</span>
            <span class="p">)</span>

        <span class="c1"># 4. 尝试匹配文件 (file)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DRIVE_FILE_PATTERN</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DocumentInfo</span><span class="p">(</span>
                <span class="n">doc_type</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">,</span>
                <span class="n">doc_token</span><span class="o">=</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;drive&quot;</span>
            <span class="p">)</span>

        <span class="c1"># 不是云空间链接</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># ==================== 知识库文档解析 (API 调用) ====================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_try_parse_wiki_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DocumentInfo</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;尝试解析知识库文档 URL (需要调用 API)</span>

<span class="sd">        知识库文档需要:</span>
<span class="sd">        1. 从 URL 提取 space_id 和 node_token</span>
<span class="sd">        2. 调用 Wiki API 获取 obj_token (实际的文档 token)</span>

<span class="sd">        Returns:</span>
<span class="sd">            DocumentInfo 或 None (如果不是知识库链接)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. 尝试匹配知识库链接</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">WIKI_LINK_PATTERN</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">space_id</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">node_token</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># 2. 调用 API 获取节点信息</span>
        <span class="n">node_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_wiki_node_info</span><span class="p">(</span><span class="n">space_id</span><span class="p">,</span> <span class="n">node_token</span><span class="p">)</span>

        <span class="c1"># 3. 构造 DocumentInfo</span>
        <span class="k">return</span> <span class="n">DocumentInfo</span><span class="p">(</span>
            <span class="n">doc_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_normalize_obj_type</span><span class="p">(</span><span class="n">node_info</span><span class="p">[</span><span class="s2">&quot;obj_type&quot;</span><span class="p">]),</span>
            <span class="n">doc_token</span><span class="o">=</span><span class="n">node_info</span><span class="p">[</span><span class="s2">&quot;obj_token&quot;</span><span class="p">],</span>  <span class="c1"># ⭐ 这是实际可用的 token</span>
            <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;wiki&quot;</span><span class="p">,</span>
            <span class="n">space_id</span><span class="o">=</span><span class="n">space_id</span><span class="p">,</span>
            <span class="n">node_token</span><span class="o">=</span><span class="n">node_token</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">node_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">),</span>
            <span class="n">owner</span><span class="o">=</span><span class="n">node_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;owner&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_wiki_node_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">space_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">node_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;调用 Wiki API 获取节点信息</span>

<span class="sd">        Args:</span>
<span class="sd">            space_id: 知识空间 ID</span>
<span class="sd">            node_token: 节点 token</span>

<span class="sd">        Returns:</span>
<span class="sd">            节点信息字典,包含:</span>
<span class="sd">            - obj_token: 实际的文档 token ⭐</span>
<span class="sd">            - obj_type: 文档类型</span>
<span class="sd">            - title: 标题</span>
<span class="sd">            - owner: 所有者</span>

<span class="sd">        Raises:</span>
<span class="sd">            ApiError: API 调用失败</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wiki_service</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">space_id</span><span class="o">=</span><span class="n">space_id</span><span class="p">,</span>
            <span class="n">node_token</span><span class="o">=</span><span class="n">node_token</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">success</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;获取知识库节点信息失败: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">msg</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(space_id=</span><span class="si">{</span><span class="n">space_id</span><span class="si">}</span><span class="s2">, node_token=</span><span class="si">{</span><span class="n">node_token</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="n">node</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">node</span>

        <span class="c1"># 处理快捷方式: 递归获取原始节点</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">node_type</span> <span class="o">==</span> <span class="s2">&quot;shortcut&quot;</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">origin_node_token</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_wiki_node_info</span><span class="p">(</span><span class="n">space_id</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">origin_node_token</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;obj_token&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">obj_token</span><span class="p">,</span>
            <span class="s2">&quot;obj_type&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">obj_type</span><span class="p">,</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">owner</span><span class="p">,</span>
            <span class="s2">&quot;creator&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">creator</span><span class="p">,</span>
            <span class="s2">&quot;obj_create_time&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">obj_create_time</span><span class="p">,</span>
            <span class="s2">&quot;obj_edit_time&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">obj_edit_time</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_obj_type</span><span class="p">(</span><span class="n">obj_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;标准化文档类型</span>

<span class="sd">        知识库 API 返回的 obj_type 可能与云空间不完全一致,需要标准化。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">type_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;doc&quot;</span><span class="p">:</span> <span class="s2">&quot;doc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;docx&quot;</span><span class="p">:</span> <span class="s2">&quot;docx&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sheet&quot;</span><span class="p">:</span> <span class="s2">&quot;sheet&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bitable&quot;</span><span class="p">:</span> <span class="s2">&quot;bitable&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mindnote&quot;</span><span class="p">:</span> <span class="s2">&quot;mindnote&quot;</span><span class="p">,</span>
            <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="s2">&quot;file&quot;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">type_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj_type</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">)</span>


<span class="c1"># ==================== 使用示例 ====================</span>

<span class="c1"># 初始化</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lark_oapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">builder</span><span class="p">()</span><span class="o">.</span><span class="n">app_id</span><span class="p">(</span><span class="s2">&quot;xxx&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">app_secret</span><span class="p">(</span><span class="s2">&quot;yyy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
<span class="n">wiki_service</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">wiki</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">space_node</span>

<span class="n">resolver</span> <span class="o">=</span> <span class="n">DocumentUrlResolver</span><span class="p">(</span><span class="n">wiki_service</span><span class="p">)</span>

<span class="c1"># 场景 1: 云空间文档 (直接提取 token)</span>
<span class="n">url1</span> <span class="o">=</span> <span class="s2">&quot;https://example.feishu.cn/docx/doxcnAbCdEfGhIjKlMnOpQr&quot;</span>
<span class="n">info1</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">url1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;文档类型: </span><span class="si">{</span><span class="n">info1</span><span class="o">.</span><span class="n">doc_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># &quot;docx&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;文档 token: </span><span class="si">{</span><span class="n">info1</span><span class="o">.</span><span class="n">doc_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># &quot;doxcnAbCdEfGhIjKlMnOpQr&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;来源: </span><span class="si">{</span><span class="n">info1</span><span class="o">.</span><span class="n">source_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># &quot;drive&quot;</span>

<span class="c1"># 场景 2: 知识库文档 (需要 API 调用)</span>
<span class="n">url2</span> <span class="o">=</span> <span class="s2">&quot;https://example.feishu.cn/wiki/7123456789/wikcnAbCdEfGhIjKlMnOpQr&quot;</span>
<span class="n">info2</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">url2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;文档类型: </span><span class="si">{</span><span class="n">info2</span><span class="o">.</span><span class="n">doc_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># &quot;docx&quot; (从 API 获取)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;文档 token: </span><span class="si">{</span><span class="n">info2</span><span class="o">.</span><span class="n">doc_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># &quot;doxcnXXXXXX&quot; (obj_token)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;来源: </span><span class="si">{</span><span class="n">info2</span><span class="o">.</span><span class="n">source_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># &quot;wiki&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;知识空间 ID: </span><span class="si">{</span><span class="n">info2</span><span class="o">.</span><span class="n">space_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># &quot;7123456789&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;节点 token: </span><span class="si">{</span><span class="n">info2</span><span class="o">.</span><span class="n">node_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># &quot;wikcnAbCdEfGhIjKlMnOpQr&quot;</span>

<span class="c1"># 场景 3: 快捷方法 - 仅获取 token</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">get_doc_token</span><span class="p">(</span><span class="n">url1</span><span class="p">)</span>  <span class="c1"># 直接返回 &quot;doxcnAbCdEfGhIjKlMnOpQr&quot;</span>

<span class="c1"># 场景 4: 批量处理</span>
<span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;https://example.feishu.cn/docx/doxcn123&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://example.feishu.cn/sheets/shtcn456&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://example.feishu.cn/wiki/7123/wikcn789&quot;</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">doc_token</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">source_type</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;解析失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id4">
<h5>0.3.2 核心设计说明<a class="headerlink" href="#id4" title="Link to this heading"></a></h5>
<p><strong>1. 双路径处理策略</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>URL 输入
    │
    ├─&gt; 尝试云空间解析 (正则表达式) ─&gt; 成功 ─&gt; 返回 DocumentInfo
    │                                  │
    │                                  └─&gt; 失败
    │                                       │
    └─&gt; 尝试知识库解析 (API 调用) ─────&gt; 成功 ─&gt; 返回 DocumentInfo
                                           │
                                           └─&gt; 失败 ─&gt; 抛出异常
</pre></div>
</div>
<p><strong>2. 为什么优先尝试云空间解析?</strong></p>
<ul class="simple">
<li><p>云空间解析只需要正则表达式,速度快,无 API 调用开销</p></li>
<li><p>知识库解析需要 API 调用,有网络延迟和配额消耗</p></li>
<li><p>大部分场景下,用户使用云空间文档更频繁</p></li>
</ul>
<p><strong>3. 快捷方式的递归处理</strong></p>
<p>知识库支持快捷方式 (shortcut),需要递归获取原始节点:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">node_type</span> <span class="o">==</span> <span class="s2">&quot;shortcut&quot;</span><span class="p">:</span>
    <span class="c1"># 递归获取原始节点的 obj_token</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_wiki_node_info</span><span class="p">(</span><span class="n">space_id</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">origin_node_token</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>4. 统一的返回格式</strong></p>
<p>无论是云空间还是知识库,都返回统一的 <code class="docutils literal notranslate"><span class="pre">DocumentInfo</span></code> 对象:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DocumentInfo</span><span class="p">:</span>
    <span class="n">doc_type</span><span class="p">:</span> <span class="nb">str</span>      <span class="c1"># 文档类型</span>
    <span class="n">doc_token</span><span class="p">:</span> <span class="nb">str</span>     <span class="c1"># ⭐ 实际可用的 token</span>
    <span class="n">source_type</span><span class="p">:</span> <span class="nb">str</span>   <span class="c1"># &quot;wiki&quot; 或 &quot;drive&quot;</span>
    <span class="c1"># ... 其他元数据</span>
</pre></div>
</div>
</section>
<section id="url">
<h5>0.3.3 支持的 URL 格式总结<a class="headerlink" href="#url" title="Link to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>文档类型</p></th>
<th class="head"><p>URL 格式</p></th>
<th class="head"><p>Token 提取方式</p></th>
<th class="head"><p>示例</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>云空间文档</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">https://xxx.feishu.cn/docx/{token}</span></code></p></td>
<td><p>正则表达式</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">docx/doxcn123</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>云空间旧文档</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">https://xxx.feishu.cn/doc/{token}</span></code></p></td>
<td><p>正则表达式</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">doc/doccn123</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>云空间表格</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">https://xxx.feishu.cn/sheets/{token}</span></code></p></td>
<td><p>正则表达式</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">sheets/shtcn123</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>云空间多维表格</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">https://xxx.feishu.cn/base/{token}</span></code></p></td>
<td><p>正则表达式</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">base/bascn123</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>云空间文件</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">https://xxx.feishu.cn/file/{token}</span></code></p></td>
<td><p>正则表达式</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">file/boxcn123</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>知识库文档</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">https://xxx.feishu.cn/wiki/{space_id}/{node_token}</span></code></p></td>
<td><p>API 调用</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">wiki/7123/wikcn456</span></code></p></td>
</tr>
</tbody>
</table>
</section>
<section id="id5">
<h5>0.3.4 错误处理<a class="headerlink" href="#id5" title="Link to this heading"></a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. URL 格式无法识别</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="s2">&quot;https://invalid.url&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;URL 格式错误: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 2. 知识库 API 调用失败</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="s2">&quot;https://example.feishu.cn/wiki/7123/wikcn456&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;获取知识库节点失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 3. 权限不足</span>
<span class="c1"># 知识库 API 会返回 403,需要在 _get_wiki_node_info 中处理</span>
</pre></div>
</div>
</section>
<section id="id6">
<h5>0.3.5 性能优化建议<a class="headerlink" href="#id6" title="Link to this heading"></a></h5>
<p><strong>1. 缓存 node_token → obj_token 映射</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CachedDocumentUrlResolver</span><span class="p">(</span><span class="n">DocumentUrlResolver</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;带缓存的文档 URL 解析器&quot;&quot;&quot;</span>

    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_wiki_node_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">space_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">node_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;缓存知识库节点信息 (避免重复 API 调用)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_wiki_node_info</span><span class="p">(</span><span class="n">space_id</span><span class="p">,</span> <span class="n">node_token</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>2. 批量解析优化</strong></p>
<p>如果需要批量解析知识库 URL,可以先分组,再批量调用 API:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">resolve_urls_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">urls</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">DocumentInfo</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;批量解析 URL&quot;&quot;&quot;</span>
    <span class="c1"># 1. 分离云空间和知识库 URL</span>
    <span class="n">drive_urls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">wiki_urls</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_parse_drive_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
            <span class="n">drive_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wiki_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="c1"># 2. 云空间 URL 直接解析 (无 API 调用)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_try_parse_drive_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">drive_urls</span><span class="p">]</span>

    <span class="c1"># 3. 知识库 URL 批量调用 API (如果 SDK 支持)</span>
    <span class="c1"># TODO: 实现批量 Wiki API 调用</span>

    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</section>
</section>
<section id="id7">
<h4>0.4 统一的文档访问客户端<a class="headerlink" href="#id7" title="Link to this heading"></a></h4>
<p>基于 <code class="docutils literal notranslate"><span class="pre">DocumentUrlResolver</span></code> 实现统一的文档访问接口。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">lark_service.clouddoc.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">DocumentUrlResolver</span>


<span class="k">class</span><span class="w"> </span><span class="nc">UnifiedDocClient</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;统一的文档访问客户端</span>

<span class="sd">    使用 DocumentUrlResolver 自动处理知识库和云空间文档的差异。</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">credential_pool</span><span class="p">:</span> <span class="n">CredentialPool</span><span class="p">,</span>
        <span class="n">retry_strategy</span><span class="p">:</span> <span class="n">RetryStrategy</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">credential_pool</span> <span class="o">=</span> <span class="n">credential_pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_strategy</span> <span class="o">=</span> <span class="n">retry_strategy</span>

        <span class="c1"># 初始化 URL 解析器</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lark_client</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url_resolver</span> <span class="o">=</span> <span class="n">DocumentUrlResolver</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">wiki</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">space_node</span><span class="p">)</span>

        <span class="c1"># 初始化各类型文档客户端</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc_client</span> <span class="o">=</span> <span class="n">DocClient</span><span class="p">(</span><span class="n">credential_pool</span><span class="p">,</span> <span class="n">retry_strategy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sheet_client</span> <span class="o">=</span> <span class="n">SheetClient</span><span class="p">(</span><span class="n">credential_pool</span><span class="p">,</span> <span class="n">retry_strategy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bitable_client</span> <span class="o">=</span> <span class="n">BitableClient</span><span class="p">(</span><span class="n">credential_pool</span><span class="p">,</span> <span class="n">retry_strategy</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_document_by_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Document</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;通过 URL 获取文档 (自动识别知识库/云空间)</span>

<span class="sd">        Args:</span>
<span class="sd">            url: 飞书文档 URL (支持知识库和云空间)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Document: 文档对象</span>

<span class="sd">        Examples:</span>
<span class="sd">            # 云空间文档</span>
<span class="sd">            &gt;&gt;&gt; doc = client.get_document_by_url(&quot;https://example.feishu.cn/docx/doxcn123&quot;)</span>

<span class="sd">            # 知识库文档 (自动调用 API 获取 obj_token)</span>
<span class="sd">            &gt;&gt;&gt; doc = client.get_document_by_url(&quot;https://example.feishu.cn/wiki/7123/wikcn456&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. 解析 URL 并获取 doc_token</span>
        <span class="n">doc_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="c1"># 2. 根据文档类型调用对应的客户端</span>
        <span class="k">if</span> <span class="n">doc_info</span><span class="o">.</span><span class="n">doc_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;doc&quot;</span><span class="p">,</span> <span class="s2">&quot;docx&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc_client</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span><span class="n">doc_info</span><span class="o">.</span><span class="n">doc_token</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">doc_info</span><span class="o">.</span><span class="n">doc_type</span> <span class="o">==</span> <span class="s2">&quot;sheet&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheet_client</span><span class="o">.</span><span class="n">get_sheet</span><span class="p">(</span><span class="n">doc_info</span><span class="o">.</span><span class="n">doc_token</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">doc_info</span><span class="o">.</span><span class="n">doc_type</span> <span class="o">==</span> <span class="s2">&quot;bitable&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitable_client</span><span class="o">.</span><span class="n">get_bitable</span><span class="p">(</span><span class="n">doc_info</span><span class="o">.</span><span class="n">doc_token</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;不支持的文档类型: </span><span class="si">{</span><span class="n">doc_info</span><span class="o">.</span><span class="n">doc_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_document_content_by_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;快捷方法: 获取文档纯文本内容</span>

<span class="sd">        Args:</span>
<span class="sd">            url: 飞书文档 URL</span>

<span class="sd">        Returns:</span>
<span class="sd">            文档纯文本内容</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">doc_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">doc_info</span><span class="o">.</span><span class="n">doc_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;doc&quot;</span><span class="p">,</span> <span class="s2">&quot;docx&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc_client</span><span class="o">.</span><span class="n">get_content</span><span class="p">(</span><span class="n">doc_info</span><span class="o">.</span><span class="n">doc_token</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;不支持的文档类型: </span><span class="si">{</span><span class="n">doc_info</span><span class="o">.</span><span class="n">doc_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">append_content_by_url</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ContentBlock</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;通过 URL 追加文档内容</span>

<span class="sd">        Args:</span>
<span class="sd">            url: 飞书文档 URL</span>
<span class="sd">            content: 要追加的内容块列表</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">doc_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">doc_info</span><span class="o">.</span><span class="n">doc_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;doc&quot;</span><span class="p">,</span> <span class="s2">&quot;docx&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doc_client</span><span class="o">.</span><span class="n">append_content</span><span class="p">(</span><span class="n">doc_info</span><span class="o">.</span><span class="n">doc_token</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;不支持的文档类型: </span><span class="si">{</span><span class="n">doc_info</span><span class="o">.</span><span class="n">doc_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lark_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;获取飞书客户端&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">lark_oapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>
        <span class="n">credential</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">credential_pool</span><span class="o">.</span><span class="n">get_credential</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Client</span><span class="o">.</span><span class="n">builder</span><span class="p">()</span> \
            <span class="o">.</span><span class="n">app_id</span><span class="p">(</span><span class="n">credential</span><span class="o">.</span><span class="n">app_id</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">app_secret</span><span class="p">(</span><span class="n">credential</span><span class="o">.</span><span class="n">app_secret</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">build</span><span class="p">()</span>


<span class="c1"># ==================== 使用示例 ====================</span>

<span class="c1"># 初始化</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">UnifiedDocClient</span><span class="p">(</span><span class="n">credential_pool</span><span class="p">,</span> <span class="n">retry_strategy</span><span class="p">)</span>

<span class="c1"># 场景 1: 通过 URL 获取文档 (自动识别知识库/云空间)</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://example.feishu.cn/wiki/7123456789/wikcnAbCdEfGhIjKlMnOpQr&quot;</span>
<span class="n">document</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_document_by_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;文档标题: </span><span class="si">{</span><span class="n">document</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 场景 2: 通过 URL 获取纯文本内容</span>
<span class="n">content</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_document_content_by_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

<span class="c1"># 场景 3: 通过 URL 追加内容</span>
<span class="n">client</span><span class="o">.</span><span class="n">append_content_by_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="p">[</span>
    <span class="n">ContentBlock</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;paragraph&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;新增的段落内容&quot;</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># 场景 4: 批量处理不同来源的文档</span>
<span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;https://example.feishu.cn/docx/doxcn123&quot;</span><span class="p">,</span>  <span class="c1"># 云空间</span>
    <span class="s2">&quot;https://example.feishu.cn/wiki/7123/wikcn456&quot;</span><span class="p">,</span>  <span class="c1"># 知识库</span>
    <span class="s2">&quot;https://example.feishu.cn/sheets/shtcn789&quot;</span>  <span class="c1"># 表格</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_document_by_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;成功获取文档: </span><span class="si">{</span><span class="n">doc</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;获取失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id8">
<h4>0.5 知识库相关数据模型<a class="headerlink" href="#id8" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WikiNode</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;知识库节点&quot;&quot;&quot;</span>
    <span class="n">space_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^[0-9]+$&#39;</span><span class="p">)</span>
    <span class="n">node_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9_-]+$&#39;</span><span class="p">)</span>
    <span class="n">obj_token</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># 实际的文档 token</span>
    <span class="n">obj_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;doc&quot;</span><span class="p">,</span> <span class="s2">&quot;docx&quot;</span><span class="p">,</span> <span class="s2">&quot;sheet&quot;</span><span class="p">,</span> <span class="s2">&quot;mindnote&quot;</span><span class="p">,</span> <span class="s2">&quot;bitable&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">]</span>
    <span class="n">parent_node_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">node_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">,</span> <span class="s2">&quot;shortcut&quot;</span><span class="p">]</span>
    <span class="n">origin_node_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 快捷方式指向的原始节点</span>
    <span class="n">has_child</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">obj_create_time</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># Unix timestamp</span>
    <span class="n">obj_edit_time</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">node_create_time</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">creator</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># open_id</span>
    <span class="n">owner</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># open_id</span>

<span class="k">class</span><span class="w"> </span><span class="nc">WikiSpace</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;知识空间&quot;&quot;&quot;</span>
    <span class="n">space_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^[0-9]+$&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">space_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;team&quot;</span><span class="p">,</span> <span class="s2">&quot;personal&quot;</span><span class="p">]</span>
    <span class="n">visibility</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;public&quot;</span><span class="p">,</span> <span class="s2">&quot;private&quot;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="api">
<h4>0.6 知识库 API 端点<a class="headerlink" href="#api" title="Link to this heading"></a></h4>
<p>需要在 <code class="docutils literal notranslate"><span class="pre">contracts/clouddoc.yaml</span></code> 中补充:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">paths</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 知识库节点操作</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">/wiki/v2/spaces/{space_id}/nodes/{node_token}</span><span class="p p-Indicator">:</span>
<span class="w">    </span><span class="nt">get</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">获取知识库节点信息</span>
<span class="w">      </span><span class="nt">operationId</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">getWikiNode</span>
<span class="w">      </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Wiki</span>
<span class="w">      </span><span class="nt">parameters</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">space_id</span>
<span class="w">          </span><span class="nt">in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">path</span>
<span class="w">          </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">schema</span><span class="p">:</span>
<span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node_token</span>
<span class="w">          </span><span class="nt">in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">path</span>
<span class="w">          </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">schema</span><span class="p">:</span>
<span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">      </span><span class="nt">responses</span><span class="p">:</span>
<span class="w">        </span><span class="s">&#39;200&#39;</span><span class="p p-Indicator">:</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">成功</span>
<span class="w">          </span><span class="nt">content</span><span class="p">:</span>
<span class="w">            </span><span class="nt">application/json</span><span class="p">:</span>
<span class="w">              </span><span class="nt">schema</span><span class="p">:</span>
<span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">                </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">                  </span><span class="nt">code</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">integer</span>
<span class="w">                  </span><span class="nt">msg</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">                  </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">                    </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">                      </span><span class="nt">node</span><span class="p">:</span>
<span class="w">                        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/components/schemas/WikiNode&#39;</span>
</pre></div>
</div>
</section>
<section id="id9">
<h4>0.7 完整使用场景示例<a class="headerlink" href="#id9" title="Link to this heading"></a></h4>
<section id="id10">
<h5>场景 1: 解析各种类型的文档 URL<a class="headerlink" href="#id10" title="Link to this heading"></a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">lark_service.clouddoc.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">DocumentUrlResolver</span>

<span class="c1"># 初始化解析器</span>
<span class="n">resolver</span> <span class="o">=</span> <span class="n">DocumentUrlResolver</span><span class="p">(</span><span class="n">wiki_service</span><span class="p">)</span>

<span class="c1"># 1. 云空间新版文档</span>
<span class="n">url1</span> <span class="o">=</span> <span class="s2">&quot;https://example.feishu.cn/docx/doxcnAbCdEfGhIjKlMnOpQr&quot;</span>
<span class="n">info1</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">url1</span><span class="p">)</span>
<span class="c1"># DocumentInfo(doc_type=&quot;docx&quot;, doc_token=&quot;doxcnAbCdEfGhIjKlMnOpQr&quot;, source_type=&quot;drive&quot;)</span>

<span class="c1"># 2. 云空间表格</span>
<span class="n">url2</span> <span class="o">=</span> <span class="s2">&quot;https://example.feishu.cn/sheets/shtcnAbCdEfGhIjKlMnOpQr&quot;</span>
<span class="n">info2</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">url2</span><span class="p">)</span>
<span class="c1"># DocumentInfo(doc_type=&quot;sheet&quot;, doc_token=&quot;shtcnAbCdEfGhIjKlMnOpQr&quot;, source_type=&quot;drive&quot;)</span>

<span class="c1"># 3. 云空间多维表格</span>
<span class="n">url3</span> <span class="o">=</span> <span class="s2">&quot;https://example.feishu.cn/base/bascnAbCdEfGhIjKlMnOpQr&quot;</span>
<span class="n">info3</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">url3</span><span class="p">)</span>
<span class="c1"># DocumentInfo(doc_type=&quot;bitable&quot;, doc_token=&quot;bascnAbCdEfGhIjKlMnOpQr&quot;, source_type=&quot;drive&quot;)</span>

<span class="c1"># 4. 知识库文档 (需要 API 调用)</span>
<span class="n">url4</span> <span class="o">=</span> <span class="s2">&quot;https://example.feishu.cn/wiki/7123456789/wikcnAbCdEfGhIjKlMnOpQr&quot;</span>
<span class="n">info4</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">url4</span><span class="p">)</span>
<span class="c1"># DocumentInfo(</span>
<span class="c1">#     doc_type=&quot;docx&quot;,  # 从 API 获取</span>
<span class="c1">#     doc_token=&quot;doxcnXXXXXX&quot;,  # obj_token</span>
<span class="c1">#     source_type=&quot;wiki&quot;,</span>
<span class="c1">#     space_id=&quot;7123456789&quot;,</span>
<span class="c1">#     node_token=&quot;wikcnAbCdEfGhIjKlMnOpQr&quot;</span>
<span class="c1"># )</span>
</pre></div>
</div>
</section>
<section id="id11">
<h5>场景 2: 使用统一客户端访问文档<a class="headerlink" href="#id11" title="Link to this heading"></a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">lark_service.clouddoc</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnifiedDocClient</span>

<span class="c1"># 初始化客户端</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">UnifiedDocClient</span><span class="p">(</span><span class="n">credential_pool</span><span class="p">,</span> <span class="n">retry_strategy</span><span class="p">)</span>

<span class="c1"># 用户提供任意文档链接,自动识别并获取内容</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://example.feishu.cn/wiki/7123456789/wikcnAbCdEfGhIjKlMnOpQr&quot;</span>

<span class="c1"># 方式 1: 获取完整文档对象</span>
<span class="n">document</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_document_by_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;文档标题: </span><span class="si">{</span><span class="n">document</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;文档所有者: </span><span class="si">{</span><span class="n">document</span><span class="o">.</span><span class="n">owner_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 方式 2: 仅获取纯文本内容</span>
<span class="n">content</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_document_content_by_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

<span class="c1"># 方式 3: 追加内容</span>
<span class="n">client</span><span class="o">.</span><span class="n">append_content_by_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="p">[</span>
    <span class="n">ContentBlock</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;paragraph&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;这是新增的段落&quot;</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</section>
<section id="id12">
<h5>场景 3: 批量处理混合来源的文档<a class="headerlink" href="#id12" title="Link to this heading"></a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 用户提供的文档列表 (混合知识库和云空间)</span>
<span class="n">document_urls</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;https://example.feishu.cn/docx/doxcn123&quot;</span><span class="p">,</span>  <span class="c1"># 云空间文档</span>
    <span class="s2">&quot;https://example.feishu.cn/wiki/7123/wikcn456&quot;</span><span class="p">,</span>  <span class="c1"># 知识库文档</span>
    <span class="s2">&quot;https://example.feishu.cn/sheets/shtcn789&quot;</span><span class="p">,</span>  <span class="c1"># 云空间表格</span>
    <span class="s2">&quot;https://example.feishu.cn/base/bascn012&quot;</span>  <span class="c1"># 云空间多维表格</span>
<span class="p">]</span>

<span class="c1"># 批量解析</span>
<span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">document_urls</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  类型: </span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">doc_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Token: </span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">doc_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  来源: </span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">source_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✗ </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="token">
<h5>场景 4: 快捷方法 - 仅获取 token<a class="headerlink" href="#token" title="Link to this heading"></a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 如果只需要 token,不需要其他元信息</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://example.feishu.cn/wiki/7123/wikcn456&quot;</span>
<span class="n">doc_token</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">get_doc_token</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="c1"># 直接返回 &quot;doxcnXXXXXX&quot; (实际可用的 token)</span>

<span class="c1"># 然后使用 token 调用其他 API</span>
<span class="n">doc_client</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span><span class="n">doc_token</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id13">
<h5>场景 5: 处理知识库快捷方式<a class="headerlink" href="#id13" title="Link to this heading"></a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 知识库支持快捷方式 (shortcut)</span>
<span class="c1"># DocumentUrlResolver 会自动递归获取原始节点的 obj_token</span>

<span class="n">shortcut_url</span> <span class="o">=</span> <span class="s2">&quot;https://example.feishu.cn/wiki/7123/wikcn_shortcut&quot;</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">shortcut_url</span><span class="p">)</span>

<span class="c1"># info.doc_token 是原始文档的 obj_token (自动递归获取)</span>
<span class="c1"># info.node_token 是快捷方式的 node_token</span>
</pre></div>
</div>
</section>
<section id="id14">
<h5>场景 6: 错误处理<a class="headerlink" href="#id14" title="Link to this heading"></a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. URL 格式无法识别</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="s2">&quot;https://invalid.url/document&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;URL 格式错误: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># 错误消息会列出支持的格式</span>

<span class="c1"># 2. 知识库节点不存在</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="s2">&quot;https://example.feishu.cn/wiki/7123/wikcn_notfound&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;节点不存在: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 3. 权限不足</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="s2">&quot;https://example.feishu.cn/wiki/7123/wikcn_noperm&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;权限不足: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="id15">
<h4>0.8 重要注意事项<a class="headerlink" href="#id15" title="Link to this heading"></a></h4>
<section id="id16">
<h5>1. 权限要求<a class="headerlink" href="#id16" title="Link to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>操作</p></th>
<th class="head"><p>所需权限</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>访问知识库文档</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">wiki:wiki:readonly</span></code></p></td>
<td><p>获取节点信息和文档内容</p></td>
</tr>
<tr class="row-odd"><td><p>访问云空间文档</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">drive:drive:readonly</span></code></p></td>
<td><p>读取文档内容</p></td>
</tr>
<tr class="row-even"><td><p>编辑云空间文档</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">drive:drive:readwrite</span></code></p></td>
<td><p>修改文档内容</p></td>
</tr>
</tbody>
</table>
<p><strong>关键点</strong>:</p>
<ul class="simple">
<li><p>知识库和云空间需要<strong>不同的权限</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DocumentUrlResolver</span></code> 会自动调用 Wiki API,需要确保应用有 <code class="docutils literal notranslate"><span class="pre">wiki:wiki:readonly</span></code> 权限</p></li>
<li><p>如果只访问云空间文档,可以不申请 Wiki 权限</p></li>
</ul>
</section>
<section id="id17">
<h5>2. Token 格式差异<a class="headerlink" href="#id17" title="Link to this heading"></a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 知识库 node_token (可能包含 - 和 _)</span>
<span class="s2">&quot;wikcnAbCdEfGhIjKlMnOpQr&quot;</span>
<span class="s2">&quot;wikcn_AbCdEfGhIjKlMnOpQr&quot;</span>  <span class="c1"># 可能有下划线</span>
<span class="s2">&quot;wikcn-AbCdEfGhIjKlMnOpQr&quot;</span>  <span class="c1"># 可能有连字符</span>

<span class="c1"># 云空间 doc_token (通常是纯字母数字)</span>
<span class="s2">&quot;doxcnAbCdEfGhIjKlMnOpQr&quot;</span>  <span class="c1"># 文档</span>
<span class="s2">&quot;shtcnAbCdEfGhIjKlMnOpQr&quot;</span>  <span class="c1"># 表格</span>
<span class="s2">&quot;bascnAbCdEfGhIjKlMnOpQr&quot;</span>  <span class="c1"># 多维表格</span>
<span class="s2">&quot;boxcnAbCdEfGhIjKlMnOpQr&quot;</span>  <span class="c1"># 文件</span>

<span class="c1"># 知识库 obj_token (从 API 获取,格式与云空间一致)</span>
<span class="s2">&quot;doxcnXXXXXXXXXXXXXXXX&quot;</span>  <span class="c1"># 实际的文档 token</span>
</pre></div>
</div>
</section>
<section id="id18">
<h5>3. 快捷方式处理<a class="headerlink" href="#id18" title="Link to this heading"></a></h5>
<p>知识库支持快捷方式 (shortcut),<code class="docutils literal notranslate"><span class="pre">DocumentUrlResolver</span></code> 会<strong>自动递归</strong>获取原始文档:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 快捷方式 URL</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://example.feishu.cn/wiki/7123/wikcn_shortcut&quot;</span>

<span class="c1"># 自动递归获取原始节点</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="c1"># info.doc_token 是原始文档的 obj_token (不是快捷方式的 node_token)</span>
</pre></div>
</div>
<p><strong>实现逻辑</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">node_type</span> <span class="o">==</span> <span class="s2">&quot;shortcut&quot;</span><span class="p">:</span>
    <span class="c1"># 递归获取原始节点</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_wiki_node_info</span><span class="p">(</span><span class="n">space_id</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">origin_node_token</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id19">
<h5>4. 缓存策略建议<a class="headerlink" href="#id19" title="Link to this heading"></a></h5>
<p><strong>4.1 缓存什么?</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 缓存 node_token → obj_token 的映射</span>
<span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;wiki_node:</span><span class="si">{</span><span class="n">space_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">node_token</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">cache_value</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;obj_token&quot;</span><span class="p">:</span> <span class="s2">&quot;doxcnXXXXXX&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obj_type&quot;</span><span class="p">:</span> <span class="s2">&quot;docx&quot;</span><span class="p">,</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;文档标题&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>4.2 缓存时长</strong></p>
<ul class="simple">
<li><p><strong>TTL: 1 小时</strong> (知识库结构变化较少)</p></li>
<li><p>如果文档被删除或移动,缓存会自然过期</p></li>
</ul>
<p><strong>4.3 缓存实现</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CachedDocumentUrlResolver</span><span class="p">(</span><span class="n">DocumentUrlResolver</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;带缓存的文档 URL 解析器&quot;&quot;&quot;</span>

    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_wiki_node_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">space_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">node_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;缓存知识库节点信息&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_wiki_node_info</span><span class="p">(</span><span class="n">space_id</span><span class="p">,</span> <span class="n">node_token</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id20">
<h5>5. 性能考虑<a class="headerlink" href="#id20" title="Link to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>操作</p></th>
<th class="head"><p>耗时</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>云空间 URL 解析</p></td>
<td><p>&lt; 1 ms</p></td>
<td><p>正则表达式,无网络请求</p></td>
</tr>
<tr class="row-odd"><td><p>知识库 URL 解析</p></td>
<td><p>100-500 ms</p></td>
<td><p>需要调用 Wiki API</p></td>
</tr>
<tr class="row-even"><td><p>缓存命中</p></td>
<td><p>&lt; 1 ms</p></td>
<td><p>无 API 调用</p></td>
</tr>
</tbody>
</table>
<p><strong>优化建议</strong>:</p>
<ol class="arabic simple">
<li><p>优先尝试云空间解析 (速度快)</p></li>
<li><p>使用缓存减少 Wiki API 调用</p></li>
<li><p>批量处理时,先分组再处理</p></li>
</ol>
</section>
<section id="id21">
<h5>6. 错误处理<a class="headerlink" href="#id21" title="Link to this heading"></a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. URL 格式无法识别</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># e.message 会列出支持的格式</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;URL 格式错误: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 2. 知识库 API 调用失败</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">wiki_url</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># 可能原因: 节点不存在、权限不足、网络超时</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;获取知识库节点失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id22">
<h5>7. 测试建议<a class="headerlink" href="#id22" title="Link to this heading"></a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 测试用例应覆盖:</span>
<span class="n">test_cases</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># 云空间文档</span>
    <span class="p">(</span><span class="s2">&quot;https://example.feishu.cn/docx/doxcn123&quot;</span><span class="p">,</span> <span class="s2">&quot;doxcn123&quot;</span><span class="p">,</span> <span class="s2">&quot;drive&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;https://example.feishu.cn/sheets/shtcn456&quot;</span><span class="p">,</span> <span class="s2">&quot;shtcn456&quot;</span><span class="p">,</span> <span class="s2">&quot;drive&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;https://example.feishu.cn/base/bascn789&quot;</span><span class="p">,</span> <span class="s2">&quot;bascn789&quot;</span><span class="p">,</span> <span class="s2">&quot;drive&quot;</span><span class="p">),</span>

    <span class="c1"># 知识库文档</span>
    <span class="p">(</span><span class="s2">&quot;https://example.feishu.cn/wiki/7123/wikcn456&quot;</span><span class="p">,</span> <span class="s2">&quot;doxcnXXX&quot;</span><span class="p">,</span> <span class="s2">&quot;wiki&quot;</span><span class="p">),</span>

    <span class="c1"># 错误格式</span>
    <span class="p">(</span><span class="s2">&quot;https://invalid.url&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">url</span><span class="p">,</span> <span class="n">expected_token</span><span class="p">,</span> <span class="n">expected_source</span> <span class="ow">in</span> <span class="n">test_cases</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">info</span><span class="o">.</span><span class="n">doc_token</span> <span class="o">==</span> <span class="n">expected_token</span>
        <span class="k">assert</span> <span class="n">info</span><span class="o">.</span><span class="n">source_type</span> <span class="o">==</span> <span class="n">expected_source</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">expected_source</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span>
</pre></div>
</div>
</section>
<section id="id23">
<h5>8. 最佳实践<a class="headerlink" href="#id23" title="Link to this heading"></a></h5>
<ol class="arabic">
<li><p><strong>统一使用 <code class="docutils literal notranslate"><span class="pre">UnifiedDocClient</span></code></strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ✓ 推荐: 使用统一客户端</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">UnifiedDocClient</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_document_by_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="c1"># ✗ 不推荐: 手动判断和处理</span>
<span class="k">if</span> <span class="s2">&quot;wiki&quot;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
    <span class="c1"># 手动处理知识库...</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># 手动处理云空间...</span>
</pre></div>
</div>
</li>
<li><p><strong>提前验证 URL 格式</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 在接收用户输入时就验证</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">user_input_url</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;URL 格式不正确&quot;</span><span class="p">,</span> <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</pre></div>
</div>
</li>
<li><p><strong>记录来源类型</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 记录文档来源,便于后续分析</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;文档访问&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
    <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
    <span class="s2">&quot;source_type&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">source_type</span><span class="p">,</span>  <span class="c1"># &quot;wiki&quot; or &quot;drive&quot;</span>
    <span class="s2">&quot;doc_type&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">doc_type</span>
<span class="p">})</span>
</pre></div>
</div>
</li>
</ol>
<p><strong>参考文档</strong>: <a class="reference external" href="https://open.feishu.cn/document/server-docs/docs/wiki-v2/space-node/get_node?appId=cli_a8c8dc731cb9900e">获取知识空间节点信息 - 飞书开放平台</a></p>
</section>
</section>
</section>
<hr class="docutils" />
<section id="id24">
<h3>1. 文档内容结构定义<a class="headerlink" href="#id24" title="Link to this heading"></a></h3>
<section id="contentblock">
<h4>1.1 ContentBlock 数据结构<a class="headerlink" href="#contentblock" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ContentBlock</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;文档内容块&quot;&quot;&quot;</span>
    <span class="n">block_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^blk_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;paragraph&quot;</span><span class="p">,</span> <span class="s2">&quot;heading&quot;</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;divider&quot;</span><span class="p">]</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">attributes</span><span class="p">:</span> <span class="n">BlockAttributes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BlockAttributes</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Block 属性&quot;&quot;&quot;</span>
    <span class="n">style</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="s2">&quot;italic&quot;</span><span class="p">,</span> <span class="s2">&quot;underline&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;normal&quot;</span>
    <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>  <span class="c1"># 标题级别 (heading 专用)</span>
    <span class="n">language</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 代码语言 (code 专用)</span>
    <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^#[0-9A-Fa-f]</span><span class="si">{6}</span><span class="s1">$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="block">
<h4>1.2 支持的 Block 类型<a class="headerlink" href="#block" title="Link to this heading"></a></h4>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>类型</p></th>
<th class="head"><p>说明</p></th>
<th class="head"><p>content 类型</p></th>
<th class="head"><p>属性</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">paragraph</span></code></p></td>
<td><p>段落</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">str</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">style</span></code>, <code class="docutils literal notranslate"><span class="pre">color</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">heading</span></code></p></td>
<td><p>标题</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">str</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">level</span></code> (1-6), <code class="docutils literal notranslate"><span class="pre">style</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">image</span></code></p></td>
<td><p>图片</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{&quot;file_token&quot;:</span> <span class="pre">str,</span> <span class="pre">&quot;width&quot;:</span> <span class="pre">int,</span> <span class="pre">&quot;height&quot;:</span> <span class="pre">int}</span></code></p></td>
<td><p>-</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">table</span></code></p></td>
<td><p>表格</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{&quot;rows&quot;:</span> <span class="pre">int,</span> <span class="pre">&quot;cols&quot;:</span> <span class="pre">int,</span> <span class="pre">&quot;cells&quot;:</span> <span class="pre">list}</span></code></p></td>
<td><p>-</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">code</span></code></p></td>
<td><p>代码块</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">str</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">language</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">list</span></code></p></td>
<td><p>列表</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{&quot;items&quot;:</span> <span class="pre">list[str],</span> <span class="pre">&quot;ordered&quot;:</span> <span class="pre">bool}</span></code></p></td>
<td><p>-</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">divider</span></code></p></td>
<td><p>分隔线</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">None</span></code></p></td>
<td><p>-</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id25">
<h4>1.3 文档内容限制<a class="headerlink" href="#id25" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DocumentLimits</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;文档限制&quot;&quot;&quot;</span>
    <span class="n">MAX_BLOCKS_PER_DOCUMENT</span> <span class="o">=</span> <span class="mi">10000</span>  <span class="c1"># 单个文档最大 block 数</span>
    <span class="n">MAX_BLOCKS_PER_APPEND</span> <span class="o">=</span> <span class="mi">100</span>      <span class="c1"># 单次追加最大 block 数</span>
    <span class="n">MAX_BLOCK_SIZE</span> <span class="o">=</span> <span class="mi">102400</span>          <span class="c1"># 单个 block 最大大小 (100 KB)</span>
    <span class="n">MAX_TITLE_LENGTH</span> <span class="o">=</span> <span class="mi">255</span>           <span class="c1"># 标题最大长度</span>
    <span class="n">MAX_CONTENT_LENGTH</span> <span class="o">=</span> <span class="mi">1048576</span>     <span class="c1"># 单个 block 内容最大长度 (1 MB)</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="bitable">
<h3>2. Bitable 过滤器语法<a class="headerlink" href="#bitable" title="Link to this heading"></a></h3>
<section id="queryfilter">
<h4>2.1 QueryFilter 数据结构<a class="headerlink" href="#queryfilter" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">QueryFilter</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;查询过滤器&quot;&quot;&quot;</span>
    <span class="n">conjunction</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;and&quot;</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;and&quot;</span>
    <span class="n">conditions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">FilterCondition</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FilterCondition</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;过滤条件&quot;&quot;&quot;</span>
    <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">operator</span><span class="p">:</span> <span class="n">FilterOperator</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># is_empty/is_not_empty 时为 None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FilterOperator</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;过滤操作符&quot;&quot;&quot;</span>
    <span class="n">IS</span> <span class="o">=</span> <span class="s2">&quot;is&quot;</span>                    <span class="c1"># 等于</span>
    <span class="n">IS_NOT</span> <span class="o">=</span> <span class="s2">&quot;is_not&quot;</span>            <span class="c1"># 不等于</span>
    <span class="n">CONTAINS</span> <span class="o">=</span> <span class="s2">&quot;contains&quot;</span>        <span class="c1"># 包含 (字符串)</span>
    <span class="n">NOT_CONTAINS</span> <span class="o">=</span> <span class="s2">&quot;not_contains&quot;</span>  <span class="c1"># 不包含</span>
    <span class="n">GT</span> <span class="o">=</span> <span class="s2">&quot;gt&quot;</span>                    <span class="c1"># 大于 (数值/日期)</span>
    <span class="n">LT</span> <span class="o">=</span> <span class="s2">&quot;lt&quot;</span>                    <span class="c1"># 小于</span>
    <span class="n">GTE</span> <span class="o">=</span> <span class="s2">&quot;gte&quot;</span>                  <span class="c1"># 大于等于</span>
    <span class="n">LTE</span> <span class="o">=</span> <span class="s2">&quot;lte&quot;</span>                  <span class="c1"># 小于等于</span>
    <span class="n">IS_EMPTY</span> <span class="o">=</span> <span class="s2">&quot;is_empty&quot;</span>        <span class="c1"># 为空</span>
    <span class="n">IS_NOT_EMPTY</span> <span class="o">=</span> <span class="s2">&quot;is_not_empty&quot;</span>  <span class="c1"># 不为空</span>
</pre></div>
</div>
</section>
<section id="id26">
<h4>2.2 过滤器示例<a class="headerlink" href="#id26" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 示例 1: 查询状态为 active 的记录</span>
<span class="nb">filter</span> <span class="o">=</span> <span class="n">QueryFilter</span><span class="p">(</span>
    <span class="n">conjunction</span><span class="o">=</span><span class="s2">&quot;and&quot;</span><span class="p">,</span>
    <span class="n">conditions</span><span class="o">=</span><span class="p">[</span>
        <span class="n">FilterCondition</span><span class="p">(</span>
            <span class="n">field_name</span><span class="o">=</span><span class="s2">&quot;status&quot;</span><span class="p">,</span>
            <span class="n">operator</span><span class="o">=</span><span class="n">FilterOperator</span><span class="o">.</span><span class="n">IS</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="s2">&quot;active&quot;</span>
        <span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># 示例 2: 查询创建时间在某个范围内的记录</span>
<span class="nb">filter</span> <span class="o">=</span> <span class="n">QueryFilter</span><span class="p">(</span>
    <span class="n">conjunction</span><span class="o">=</span><span class="s2">&quot;and&quot;</span><span class="p">,</span>
    <span class="n">conditions</span><span class="o">=</span><span class="p">[</span>
        <span class="n">FilterCondition</span><span class="p">(</span>
            <span class="n">field_name</span><span class="o">=</span><span class="s2">&quot;created_at&quot;</span><span class="p">,</span>
            <span class="n">operator</span><span class="o">=</span><span class="n">FilterOperator</span><span class="o">.</span><span class="n">GTE</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="s2">&quot;2026-01-01&quot;</span>
        <span class="p">),</span>
        <span class="n">FilterCondition</span><span class="p">(</span>
            <span class="n">field_name</span><span class="o">=</span><span class="s2">&quot;created_at&quot;</span><span class="p">,</span>
            <span class="n">operator</span><span class="o">=</span><span class="n">FilterOperator</span><span class="o">.</span><span class="n">LTE</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="s2">&quot;2026-01-31&quot;</span>
        <span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># 示例 3: 查询名称包含特定关键词或描述不为空的记录</span>
<span class="nb">filter</span> <span class="o">=</span> <span class="n">QueryFilter</span><span class="p">(</span>
    <span class="n">conjunction</span><span class="o">=</span><span class="s2">&quot;or&quot;</span><span class="p">,</span>
    <span class="n">conditions</span><span class="o">=</span><span class="p">[</span>
        <span class="n">FilterCondition</span><span class="p">(</span>
            <span class="n">field_name</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="n">operator</span><span class="o">=</span><span class="n">FilterOperator</span><span class="o">.</span><span class="n">CONTAINS</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="s2">&quot;重要&quot;</span>
        <span class="p">),</span>
        <span class="n">FilterCondition</span><span class="p">(</span>
            <span class="n">field_name</span><span class="o">=</span><span class="s2">&quot;description&quot;</span><span class="p">,</span>
            <span class="n">operator</span><span class="o">=</span><span class="n">FilterOperator</span><span class="o">.</span><span class="n">IS_NOT_EMPTY</span>
        <span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id27">
<h4>2.3 分页参数<a class="headerlink" href="#id27" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PaginationParams</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;分页参数&quot;&quot;&quot;</span>
    <span class="n">page_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">page_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sort</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">SortField</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SortField</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;排序字段&quot;&quot;&quot;</span>
    <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">desc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># True: 降序, False: 升序</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="sheet">
<h3>3. Sheet 范围格式规范<a class="headerlink" href="#sheet" title="Link to this heading"></a></h3>
<section id="id28">
<h4>3.1 范围表示法<a class="headerlink" href="#id28" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SheetRange</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sheet 范围&quot;&quot;&quot;</span>
    <span class="nb">range</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^([A-Z]+[0-9]+:[A-Z]+[0-9]+|[A-Z]+:[A-Z]+|[0-9]+:[0-9]+|[A-Z]+[0-9]+)$&#39;</span><span class="p">)</span>
    <span class="n">sheet_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 跨 sheet 时需要</span>

<span class="c1"># 支持的格式:</span>
<span class="c1"># 1. 单元格范围: &quot;A1:B10&quot;</span>
<span class="c1"># 2. 整列: &quot;A:C&quot;</span>
<span class="c1"># 3. 整行: &quot;3:5&quot;</span>
<span class="c1"># 4. 单个单元格: &quot;A1&quot;</span>
<span class="c1"># 5. 跨 sheet: &quot;Sheet1!A1:B10&quot;</span>
</pre></div>
</div>
</section>
<section id="id29">
<h4>3.2 范围限制<a class="headerlink" href="#id29" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SheetLimits</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sheet 限制&quot;&quot;&quot;</span>
    <span class="n">MAX_ROWS</span> <span class="o">=</span> <span class="mi">1000000</span>           <span class="c1"># 最大行数</span>
    <span class="n">MAX_COLS</span> <span class="o">=</span> <span class="mi">18278</span>             <span class="c1"># 最大列数 (ZZZ)</span>
    <span class="n">MAX_CELLS_PER_READ</span> <span class="o">=</span> <span class="mi">100000</span>  <span class="c1"># 单次读取最大单元格数</span>
    <span class="n">MAX_CELLS_PER_UPDATE</span> <span class="o">=</span> <span class="mi">10000</span> <span class="c1"># 单次更新最大单元格数</span>
    <span class="n">MAX_MERGE_CELLS</span> <span class="o">=</span> <span class="mi">1000</span>       <span class="c1"># 单次合并最大单元格数</span>
    <span class="n">MAX_FREEZE_ROWS</span> <span class="o">=</span> <span class="mi">100</span>        <span class="c1"># 冻结窗格最大行数</span>
    <span class="n">MAX_FREEZE_COLS</span> <span class="o">=</span> <span class="mi">100</span>        <span class="c1"># 冻结窗格最大列数</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id30">
<h3>4. 媒体上传限制<a class="headerlink" href="#id30" title="Link to this heading"></a></h3>
<section id="id31">
<h4>4.1 图片上传限制<a class="headerlink" href="#id31" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ImageUploadLimits</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;图片上传限制&quot;&quot;&quot;</span>
    <span class="n">SUPPORTED_FORMATS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;.jpg&quot;</span><span class="p">:</span> <span class="s2">&quot;image/jpeg&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.jpeg&quot;</span><span class="p">:</span> <span class="s2">&quot;image/jpeg&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.png&quot;</span><span class="p">:</span> <span class="s2">&quot;image/png&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.gif&quot;</span><span class="p">:</span> <span class="s2">&quot;image/gif&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.bmp&quot;</span><span class="p">:</span> <span class="s2">&quot;image/bmp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.webp&quot;</span><span class="p">:</span> <span class="s2">&quot;image/webp&quot;</span>
    <span class="p">}</span>
    <span class="n">MAX_SIZE</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 10 MB</span>
    <span class="n">MAX_WIDTH</span> <span class="o">=</span> <span class="mi">4096</span>              <span class="c1"># 最大宽度 (像素)</span>
    <span class="n">MAX_HEIGHT</span> <span class="o">=</span> <span class="mi">4096</span>             <span class="c1"># 最大高度 (像素)</span>
</pre></div>
</div>
</section>
<section id="id32">
<h4>4.2 文件上传限制<a class="headerlink" href="#id32" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">FileUploadLimits</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;文件上传限制&quot;&quot;&quot;</span>
    <span class="n">SUPPORTED_FORMATS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;.pdf&quot;</span><span class="p">:</span> <span class="s2">&quot;application/pdf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.doc&quot;</span><span class="p">:</span> <span class="s2">&quot;application/msword&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.docx&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.xls&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.ms-excel&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.xlsx&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.ppt&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.ms-powerpoint&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.pptx&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.openxmlformats-officedocument.presentationml.presentation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.zip&quot;</span><span class="p">:</span> <span class="s2">&quot;application/zip&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.rar&quot;</span><span class="p">:</span> <span class="s2">&quot;application/x-rar-compressed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.7z&quot;</span><span class="p">:</span> <span class="s2">&quot;application/x-7z-compressed&quot;</span>
    <span class="p">}</span>
    <span class="n">MAX_SIZE</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 30 MB</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id33">
<h3>5. 权限管理<a class="headerlink" href="#id33" title="Link to this heading"></a></h3>
<section id="id34">
<h4>5.1 权限类型定义<a class="headerlink" href="#id34" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PermissionType</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;权限类型&quot;&quot;&quot;</span>
    <span class="n">READ</span> <span class="o">=</span> <span class="s2">&quot;read&quot;</span>        <span class="c1"># 可阅读: 查看文档内容</span>
    <span class="n">WRITE</span> <span class="o">=</span> <span class="s2">&quot;write&quot;</span>      <span class="c1"># 可编辑: 修改文档内容</span>
    <span class="n">COMMENT</span> <span class="o">=</span> <span class="s2">&quot;comment&quot;</span>  <span class="c1"># 可评论: 添加评论,不能修改内容</span>
    <span class="n">MANAGE</span> <span class="o">=</span> <span class="s2">&quot;manage&quot;</span>    <span class="c1"># 可管理: 修改权限,删除文档</span>

<span class="c1"># 权限层级: manage &gt; write &gt; comment &gt; read</span>
</pre></div>
</div>
</section>
<section id="id35">
<h4>5.2 权限授予对象<a class="headerlink" href="#id35" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PermissionMember</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;权限成员&quot;&quot;&quot;</span>
    <span class="n">member_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="s2">&quot;anyone&quot;</span><span class="p">]</span>
    <span class="n">member_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># anyone 时为 None</span>
    <span class="n">member_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Permission</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;权限&quot;&quot;&quot;</span>
    <span class="n">member</span><span class="p">:</span> <span class="n">PermissionMember</span>
    <span class="n">permission</span><span class="p">:</span> <span class="n">PermissionType</span>
    <span class="n">granted_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 授予者 ID</span>
    <span class="n">granted_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id36">
<h3>6. 批量操作限制<a class="headerlink" href="#id36" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">BatchOperationLimits</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;批量操作限制&quot;&quot;&quot;</span>
    <span class="c1"># Bitable</span>
    <span class="n">BITABLE_BATCH_CREATE_MAX</span> <span class="o">=</span> <span class="mi">500</span>   <span class="c1"># 批量创建最大记录数</span>
    <span class="n">BITABLE_BATCH_UPDATE_MAX</span> <span class="o">=</span> <span class="mi">500</span>   <span class="c1"># 批量更新最大记录数</span>
    <span class="n">BITABLE_BATCH_DELETE_MAX</span> <span class="o">=</span> <span class="mi">500</span>   <span class="c1"># 批量删除最大记录数</span>
    <span class="n">BITABLE_QUERY_MAX</span> <span class="o">=</span> <span class="mi">500</span>          <span class="c1"># 单次查询最大返回数</span>

    <span class="c1"># Sheet</span>
    <span class="n">SHEET_BATCH_UPDATE_CELLS_MAX</span> <span class="o">=</span> <span class="mi">10000</span>  <span class="c1"># 批量更新最大单元格数</span>
    <span class="n">SHEET_BATCH_FORMAT_CELLS_MAX</span> <span class="o">=</span> <span class="mi">1000</span>   <span class="c1"># 批量格式化最大单元格数</span>
    <span class="n">SHEET_BATCH_MERGE_MAX</span> <span class="o">=</span> <span class="mi">100</span>           <span class="c1"># 批量合并最大区域数</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="contact">
<h2>Contact 模块补充<a class="headerlink" href="#contact" title="Link to this heading"></a></h2>
<section id="id">
<h3>1. 用户 ID 类型说明<a class="headerlink" href="#id" title="Link to this heading"></a></h3>
<section id="id37">
<h4>1.1 ID 类型对比<a class="headerlink" href="#id37" title="Link to this heading"></a></h4>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>ID 类型</p></th>
<th class="head"><p>作用域</p></th>
<th class="head"><p>格式</p></th>
<th class="head"><p>使用场景</p></th>
<th class="head"><p>稳定性</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">open_id</span></code></p></td>
<td><p>应用内</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ou_xxx</span></code> (16位)</p></td>
<td><p>消息发送、权限管理</p></td>
<td><p>应用级稳定</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">user_id</span></code></p></td>
<td><p>租户内</p></td>
<td><p>数字字符串</p></td>
<td><p>通讯录查询、组织架构</p></td>
<td><p>租户级稳定</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">union_id</span></code></p></td>
<td><p>跨租户</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">on_xxx</span></code> (16位)</p></td>
<td><p>多租户用户关联</p></td>
<td><p>全局稳定</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id38">
<h4>1.2 ID 转换规则<a class="headerlink" href="#id38" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>同一用户在不同应用有<strong>不同</strong> <code class="docutils literal notranslate"><span class="pre">open_id</span></code></p></li>
<li><p>同一用户在同一租户有<strong>唯一</strong> <code class="docutils literal notranslate"><span class="pre">user_id</span></code></p></li>
<li><p>同一用户跨租户有<strong>唯一</strong> <code class="docutils literal notranslate"><span class="pre">union_id</span></code></p></li>
</ul>
</section>
<section id="id39">
<h4>1.3 推荐使用策略<a class="headerlink" href="#id39" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. 消息发送: 使用 open_id</span>
<span class="n">client</span><span class="o">.</span><span class="n">messaging</span><span class="o">.</span><span class="n">send_text_message</span><span class="p">(</span>
    <span class="n">receiver_id</span><span class="o">=</span><span class="s2">&quot;ou_abc123...&quot;</span><span class="p">,</span>  <span class="c1"># open_id</span>
    <span class="n">receive_id_type</span><span class="o">=</span><span class="s2">&quot;open_id&quot;</span>
<span class="p">)</span>

<span class="c1"># 2. 缓存存储: 使用 union_id 作为主键</span>
<span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;user:</span><span class="si">{</span><span class="n">app_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">union_id</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># 3. 组织架构: 使用 user_id</span>
<span class="n">department_users</span> <span class="o">=</span> <span class="n">contact</span><span class="o">.</span><span class="n">get_department_users</span><span class="p">(</span><span class="n">dept_id</span><span class="p">)</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">department_users</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>  <span class="c1"># 租户内唯一</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id40">
<h3>2. 缓存策略详细定义<a class="headerlink" href="#id40" title="Link to this heading"></a></h3>
<section id="id41">
<h4>2.1 缓存刷新行为<a class="headerlink" href="#id41" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_user_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">app_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">User</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;获取用户 (同步刷新策略)&quot;&quot;&quot;</span>
    <span class="c1"># 1. 检查缓存</span>
    <span class="n">cached</span> <span class="o">=</span> <span class="n">check_cache</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">app_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cached</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_expired</span><span class="p">(</span><span class="n">cached</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cache hit&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">cached</span>

    <span class="c1"># 2. 缓存未命中或已过期,同步调用 API</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">fetch_from_lark_api</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">app_id</span><span class="p">)</span>
        <span class="n">update_cache</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>
    <span class="k">except</span> <span class="n">APIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># 3. API 调用失败,如果有过期缓存则返回</span>
        <span class="k">if</span> <span class="n">cached</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;API failed, using expired cache&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
            <span class="k">return</span> <span class="n">cached</span>
        <span class="k">raise</span>
</pre></div>
</div>
</section>
<section id="id42">
<h4>2.2 缓存失效策略<a class="headerlink" href="#id42" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CacheInvalidationStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;缓存失效策略&quot;&quot;&quot;</span>

    <span class="c1"># 1. TTL 过期失效 (自动)</span>
    <span class="n">TTL</span> <span class="o">=</span> <span class="mi">86400</span>  <span class="c1"># 24 小时</span>

    <span class="c1"># 2. 主动失效 (用户信息更新时)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">invalidate_on_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">union_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">app_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;user:</span><span class="si">{</span><span class="n">app_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">union_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">redis</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>

    <span class="c1"># 3. 强制失效 (管理员操作)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">force_invalidate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">union_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">app_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;user:</span><span class="si">{</span><span class="n">app_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">union_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">redis</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>

    <span class="c1"># 4. 容量淘汰 (LRU)</span>
    <span class="n">MAX_CACHE_SIZE</span> <span class="o">=</span> <span class="mi">100000</span>  <span class="c1"># 最大缓存 100,000 条记录</span>
</pre></div>
</div>
</section>
<section id="key">
<h4>2.3 缓存 key 命名规则<a class="headerlink" href="#key" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 用户缓存</span>
<span class="sa">f</span><span class="s2">&quot;user:</span><span class="si">{</span><span class="n">app_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">union_id</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># 部门缓存</span>
<span class="sa">f</span><span class="s2">&quot;dept:</span><span class="si">{</span><span class="n">app_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">dept_id</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># 群组缓存</span>
<span class="sa">f</span><span class="s2">&quot;chat:</span><span class="si">{</span><span class="n">app_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">chat_id</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># 权限缓存</span>
<span class="sa">f</span><span class="s2">&quot;perm:</span><span class="si">{</span><span class="n">app_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">doc_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id43">
<h3>3. 批量操作限制<a class="headerlink" href="#id43" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ContactBatchLimits</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Contact 批量操作限制&quot;&quot;&quot;</span>
    <span class="n">BATCH_QUERY_USERS_MAX</span> <span class="o">=</span> <span class="mi">200</span>      <span class="c1"># 批量查询用户最大数</span>
    <span class="n">BATCH_UPDATE_CACHE_MAX</span> <span class="o">=</span> <span class="mi">1000</span>    <span class="c1"># 批量更新缓存最大数</span>
    <span class="n">DEPARTMENT_USERS_MAX</span> <span class="o">=</span> <span class="mi">1000</span>      <span class="c1"># 单个部门最大用户数</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id44">
<h2>错误码体系<a class="headerlink" href="#id44" title="Link to this heading"></a></h2>
<section id="id45">
<h3>1. CloudDoc 错误码<a class="headerlink" href="#id45" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CloudDocErrorCode</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CloudDoc 错误码&quot;&quot;&quot;</span>
    <span class="c1"># 40xxx - 客户端错误</span>
    <span class="n">DOCUMENT_NOT_FOUND</span> <span class="o">=</span> <span class="mi">40001</span>       <span class="c1"># 文档不存在</span>
    <span class="n">PERMISSION_DENIED</span> <span class="o">=</span> <span class="mi">40002</span>        <span class="c1"># 权限不足</span>
    <span class="n">CONTENT_TOO_LARGE</span> <span class="o">=</span> <span class="mi">40003</span>        <span class="c1"># 文档内容过大</span>
    <span class="n">INVALID_BLOCK_ID</span> <span class="o">=</span> <span class="mi">40004</span>         <span class="c1"># block_id 无效</span>
    <span class="n">UNSUPPORTED_FILE_TYPE</span> <span class="o">=</span> <span class="mi">40005</span>    <span class="c1"># 文件类型不支持</span>
    <span class="n">FILE_SIZE_EXCEEDED</span> <span class="o">=</span> <span class="mi">40006</span>       <span class="c1"># 文件大小超限</span>
    <span class="n">INVALID_RANGE</span> <span class="o">=</span> <span class="mi">40007</span>            <span class="c1"># Sheet 范围无效</span>
    <span class="n">INVALID_FILTER</span> <span class="o">=</span> <span class="mi">40008</span>           <span class="c1"># Bitable 过滤器无效</span>

    <span class="c1"># 50xxx - 服务端错误</span>
    <span class="n">DOCUMENT_CREATE_FAILED</span> <span class="o">=</span> <span class="mi">50001</span>   <span class="c1"># 文档创建失败</span>
    <span class="n">CONTENT_APPEND_FAILED</span> <span class="o">=</span> <span class="mi">50002</span>    <span class="c1"># 内容追加失败</span>
    <span class="n">MEDIA_UPLOAD_FAILED</span> <span class="o">=</span> <span class="mi">50003</span>      <span class="c1"># 媒体上传失败</span>
    <span class="n">PERMISSION_GRANT_FAILED</span> <span class="o">=</span> <span class="mi">50004</span>  <span class="c1"># 权限授予失败</span>
</pre></div>
</div>
</section>
<section id="id46">
<h3>2. Contact 错误码<a class="headerlink" href="#id46" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ContactErrorCode</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Contact 错误码&quot;&quot;&quot;</span>
    <span class="c1"># 40xxx - 客户端错误</span>
    <span class="n">USER_NOT_FOUND</span> <span class="o">=</span> <span class="mi">40101</span>           <span class="c1"># 用户不存在</span>
    <span class="n">INVALID_EMAIL</span> <span class="o">=</span> <span class="mi">40102</span>            <span class="c1"># 邮箱格式错误</span>
    <span class="n">DEPARTMENT_NOT_FOUND</span> <span class="o">=</span> <span class="mi">40103</span>     <span class="c1"># 部门不存在</span>
    <span class="n">CHAT_NOT_FOUND</span> <span class="o">=</span> <span class="mi">40104</span>           <span class="c1"># 群组不存在</span>
    <span class="n">PERMISSION_DENIED</span> <span class="o">=</span> <span class="mi">40105</span>        <span class="c1"># 权限不足</span>
    <span class="n">INVALID_MOBILE</span> <span class="o">=</span> <span class="mi">40106</span>           <span class="c1"># 手机号格式错误</span>

    <span class="c1"># 50xxx - 服务端错误</span>
    <span class="n">CACHE_WRITE_FAILED</span> <span class="o">=</span> <span class="mi">50101</span>       <span class="c1"># 缓存写入失败</span>
    <span class="n">API_TIMEOUT</span> <span class="o">=</span> <span class="mi">50102</span>              <span class="c1"># API 调用超时</span>
    <span class="n">CACHE_VERSION_CONFLICT</span> <span class="o">=</span> <span class="mi">50103</span>   <span class="c1"># 缓存版本冲突</span>
</pre></div>
</div>
</section>
<section id="id47">
<h3>3. 错误响应格式<a class="headerlink" href="#id47" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ErrorResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;错误响应&quot;&quot;&quot;</span>
    <span class="n">code</span><span class="p">:</span> <span class="nb">int</span>                        <span class="c1"># 错误码</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>                     <span class="c1"># 错误消息</span>
    <span class="n">details</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 错误详情</span>
    <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span>                  <span class="c1"># 请求 ID</span>

<span class="c1"># 示例</span>
<span class="p">{</span>
    <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">40001</span><span class="p">,</span>
    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;文档不存在&quot;</span><span class="p">,</span>
    <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;doc_id&quot;</span><span class="p">:</span> <span class="s2">&quot;doc_abc123&quot;</span><span class="p">,</span>
        <span class="s2">&quot;suggestion&quot;</span><span class="p">:</span> <span class="s2">&quot;请检查文档 ID 是否正确&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;request_id&quot;</span><span class="p">:</span> <span class="s2">&quot;req_xyz789&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id48">
<h2>非功能性需求<a class="headerlink" href="#id48" title="Link to this heading"></a></h2>
<section id="id49">
<h3>1. 性能需求<a class="headerlink" href="#id49" title="Link to this heading"></a></h3>
<section id="id50">
<h4>1.1 CloudDoc 性能要求<a class="headerlink" href="#id50" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CloudDocPerformance</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CloudDoc 性能要求&quot;&quot;&quot;</span>
    <span class="n">DOCUMENT_CREATE_TIMEOUT</span> <span class="o">=</span> <span class="mf">2.0</span>    <span class="c1"># 文档创建 &lt; 2 秒</span>
    <span class="n">CONTENT_READ_TIMEOUT</span> <span class="o">=</span> <span class="mf">1.0</span>       <span class="c1"># 内容读取 &lt; 1 秒</span>
    <span class="n">CONTENT_APPEND_TIMEOUT</span> <span class="o">=</span> <span class="mf">3.0</span>     <span class="c1"># 内容追加 &lt; 3 秒</span>
    <span class="n">BITABLE_QUERY_TIMEOUT</span> <span class="o">=</span> <span class="mf">2.0</span>      <span class="c1"># Bitable 查询 &lt; 2 秒</span>
    <span class="n">MEDIA_UPLOAD_TIMEOUT</span> <span class="o">=</span> <span class="mf">30.0</span>      <span class="c1"># 媒体上传 (10MB) &lt; 30 秒</span>
    <span class="n">SHEET_READ_TIMEOUT</span> <span class="o">=</span> <span class="mf">2.0</span>         <span class="c1"># Sheet 读取 &lt; 2 秒</span>
    <span class="n">SHEET_UPDATE_TIMEOUT</span> <span class="o">=</span> <span class="mf">3.0</span>       <span class="c1"># Sheet 更新 &lt; 3 秒</span>

    <span class="c1"># 并发性能</span>
    <span class="n">CONCURRENT_OPERATIONS_PER_SECOND</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># 支持每秒 50 次并发操作</span>
</pre></div>
</div>
</section>
<section id="id51">
<h4>1.2 Contact 性能要求<a class="headerlink" href="#id51" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ContactPerformance</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Contact 性能要求&quot;&quot;&quot;</span>
    <span class="n">CACHE_HIT_RESPONSE_TIME</span> <span class="o">=</span> <span class="mf">0.1</span>    <span class="c1"># 缓存命中 &lt; 100 ms</span>
    <span class="n">CACHE_MISS_RESPONSE_TIME</span> <span class="o">=</span> <span class="mf">2.0</span>   <span class="c1"># 缓存未命中 &lt; 2 秒</span>
    <span class="n">BATCH_QUERY_TIMEOUT</span> <span class="o">=</span> <span class="mf">5.0</span>        <span class="c1"># 批量查询 (200 用户) &lt; 5 秒</span>
    <span class="n">CACHE_REFRESH_TIMEOUT</span> <span class="o">=</span> <span class="mf">3.0</span>      <span class="c1"># 缓存刷新 &lt; 3 秒</span>

    <span class="c1"># 并发性能</span>
    <span class="n">CONCURRENT_QUERIES_PER_SECOND</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># 支持每秒 100 次并发查询</span>

    <span class="c1"># 缓存性能</span>
    <span class="n">CACHE_HIT_RATE_TARGET</span> <span class="o">=</span> <span class="mf">0.8</span>      <span class="c1"># 缓存命中率目标 &gt; 80%</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id52">
<h3>2. 安全需求<a class="headerlink" href="#id52" title="Link to this heading"></a></h3>
<section id="id53">
<h4>2.1 权限验证<a class="headerlink" href="#id53" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SecurityRequirements</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;安全需求&quot;&quot;&quot;</span>

    <span class="c1"># 1. 权限验证时机</span>
    <span class="n">VERIFY_PERMISSION_ON_EVERY_OPERATION</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 每次操作前验证权限</span>

    <span class="c1"># 2. 权限缓存</span>
    <span class="n">PERMISSION_CACHE_TTL</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1"># 权限缓存 5 分钟</span>

    <span class="c1"># 3. 权限变更同步</span>
    <span class="n">INVALIDATE_PERMISSION_CACHE_ON_CHANGE</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 权限变更后立即失效缓存</span>
</pre></div>
</div>
</section>
<section id="id54">
<h4>2.2 数据隐私<a class="headerlink" href="#id54" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DataPrivacy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;数据隐私&quot;&quot;&quot;</span>

    <span class="c1"># 1. 缓存数据加密</span>
    <span class="n">ENCRYPT_CACHE_DATA</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 使用 AES-256 加密</span>

    <span class="c1"># 2. 敏感字段脱敏</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mask_email</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;邮箱脱敏: z***@example.com&quot;&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">***@</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mask_mobile</span><span class="p">(</span><span class="n">mobile</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;手机号脱敏: 138****5678&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mobile</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">****</span><span class="si">{</span><span class="n">mobile</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># 3. 日志脱敏</span>
    <span class="n">LOG_MASK_SENSITIVE_FIELDS</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 日志中不记录完整邮箱和手机号</span>
</pre></div>
</div>
</section>
<section id="id55">
<h4>2.3 审计日志<a class="headerlink" href="#id55" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AuditLog</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;审计日志&quot;&quot;&quot;</span>

    <span class="c1"># 记录内容</span>
    <span class="n">AUDIT_PERMISSION_CHANGES</span> <span class="o">=</span> <span class="kc">True</span>   <span class="c1"># 记录所有权限变更</span>
    <span class="n">AUDIT_SENSITIVE_DATA_ACCESS</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 记录敏感数据访问</span>

    <span class="c1"># 日志保留</span>
    <span class="n">LOG_RETENTION_DAYS</span> <span class="o">=</span> <span class="mi">90</span>  <span class="c1"># 日志保留 90 天</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id56">
<h3>3. 可靠性需求<a class="headerlink" href="#id56" title="Link to this heading"></a></h3>
<section id="id57">
<h4>3.1 重试策略<a class="headerlink" href="#id57" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RetryStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;重试策略&quot;&quot;&quot;</span>

    <span class="c1"># CloudDoc 重试</span>
    <span class="n">CLOUDDOC_RETRYABLE_OPERATIONS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="s2">&quot;query&quot;</span><span class="p">]</span>  <span class="c1"># 可重试操作</span>
    <span class="n">CLOUDDOC_NON_RETRYABLE_OPERATIONS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">]</span>  <span class="c1"># 不可重试操作</span>

    <span class="c1"># Contact 重试</span>
    <span class="n">CONTACT_RETRYABLE_OPERATIONS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span><span class="p">]</span>  <span class="c1"># 可重试操作</span>

    <span class="c1"># 幂等性保证</span>
    <span class="n">USE_IDEMPOTENCY_KEY</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 使用 idempotency_key 保证幂等性</span>
</pre></div>
</div>
</section>
<section id="id58">
<h4>3.2 缓存一致性<a class="headerlink" href="#id58" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CacheConsistency</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;缓存一致性&quot;&quot;&quot;</span>

    <span class="c1"># 1. 缓存更新使用事务</span>
    <span class="n">USE_TRANSACTION_FOR_CACHE_UPDATE</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># 2. 并发更新使用乐观锁</span>
    <span class="n">USE_OPTIMISTIC_LOCK</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 使用 version 字段</span>

    <span class="c1"># 3. 冲突检测和重试</span>
    <span class="n">MAX_RETRY_ON_CONFLICT</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
</section>
<section id="id59">
<h4>3.3 数据持久化<a class="headerlink" href="#id59" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DataPersistence</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;数据持久化&quot;&quot;&quot;</span>

    <span class="c1"># 数据库写入重试</span>
    <span class="n">DB_WRITE_MAX_RETRY</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="c1"># 事务边界</span>
    <span class="n">USE_DATABASE_TRANSACTION</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># 数据备份</span>
    <span class="n">BACKUP_CACHE_DATA_DAILY</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 每日备份缓存数据</span>
</pre></div>
</div>
</section>
</section>
</section>
<hr class="docutils" />
<section id="id60">
<h2>数据验证规范<a class="headerlink" href="#id60" title="Link to this heading"></a></h2>
<section id="id61">
<h3>1. ID 格式验证<a class="headerlink" href="#id61" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">IDValidation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ID 格式验证&quot;&quot;&quot;</span>

    <span class="c1"># 正则表达式</span>
    <span class="n">DOC_ID_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^doc_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span>
    <span class="n">TABLE_ID_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^tbl_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span>
    <span class="n">SHEET_ID_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^sht_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span>
    <span class="n">RECORD_ID_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^rec_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span>
    <span class="n">FILE_TOKEN_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^file_v2_[a-zA-Z0-9]</span><span class="si">{32}</span><span class="s1">$&#39;</span>
    <span class="n">BLOCK_ID_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^blk_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span>

    <span class="n">OPEN_ID_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^ou_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span>
    <span class="n">UNION_ID_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^on_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span>
    <span class="n">DEPT_ID_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^dept_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span>
    <span class="n">CHAT_ID_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^oc_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span>
</pre></div>
</div>
</section>
<section id="id62">
<h3>2. 邮箱和手机号验证<a class="headerlink" href="#id62" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ContactValidation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;联系方式验证&quot;&quot;&quot;</span>

    <span class="c1"># 邮箱验证</span>
    <span class="n">EMAIL_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$&#39;</span>

    <span class="c1"># 手机号验证 (E.164 格式)</span>
    <span class="n">MOBILE_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^\+?[1-9]\d{1,14}$&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;验证邮箱格式&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ContactValidation</span><span class="o">.</span><span class="n">EMAIL_PATTERN</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_mobile</span><span class="p">(</span><span class="n">mobile</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;验证手机号格式&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ContactValidation</span><span class="o">.</span><span class="n">MOBILE_PATTERN</span><span class="p">,</span> <span class="n">mobile</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="id63">
<h3>3. 内容验证<a class="headerlink" href="#id63" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ContentValidation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;内容验证&quot;&quot;&quot;</span>

    <span class="c1"># 文档标题</span>
    <span class="n">TITLE_MIN_LENGTH</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">TITLE_MAX_LENGTH</span> <span class="o">=</span> <span class="mi">255</span>

    <span class="c1"># Block 内容</span>
    <span class="n">BLOCK_COUNT_MIN</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">BLOCK_COUNT_MAX</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># 单次追加</span>
    <span class="n">BLOCK_CONTENT_MAX_SIZE</span> <span class="o">=</span> <span class="mi">102400</span>  <span class="c1"># 100 KB</span>

    <span class="c1"># Bitable 字段</span>
    <span class="n">FIELD_NAME_MIN_LENGTH</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">FIELD_NAME_MAX_LENGTH</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">FIELD_VALUE_MAX_SIZE</span> <span class="o">=</span> <span class="mi">10240</span>  <span class="c1"># 10 KB</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id64">
<h2>数据模型完整定义<a class="headerlink" href="#id64" title="Link to this heading"></a></h2>
<section id="id65">
<h3>1. CloudDoc 数据模型<a class="headerlink" href="#id65" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Document 模型</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Document</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">doc_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^doc_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">folder_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^fld_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="n">owner_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^ou_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">updated_at</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">block_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># BaseRecord 模型 (Bitable)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BaseRecord</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">record_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^rec_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="n">fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">created_by</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">created_time</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># Unix timestamp</span>
    <span class="n">last_modified_by</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">last_modified_time</span><span class="p">:</span> <span class="nb">int</span>

<span class="c1"># SheetRange 模型</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SheetRange</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">range</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^([A-Z]+[0-9]+:[A-Z]+[0-9]+|[A-Z]+:[A-Z]+|[0-9]+:[0-9]+|[A-Z]+[0-9]+)$&#39;</span><span class="p">)</span>
    <span class="n">sheet_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># MediaAsset 模型</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MediaAsset</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">file_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^file_v2_[a-zA-Z0-9]</span><span class="si">{32}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">file_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">31457280</span><span class="p">)</span>  <span class="c1"># 最大 30 MB</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Permission 模型</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Permission</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">member_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="s2">&quot;anyone&quot;</span><span class="p">]</span>
    <span class="n">member_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">member_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">permission</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="s2">&quot;write&quot;</span><span class="p">,</span> <span class="s2">&quot;comment&quot;</span><span class="p">,</span> <span class="s2">&quot;manage&quot;</span><span class="p">]</span>
    <span class="n">granted_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">granted_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</section>
<section id="id66">
<h3>2. Contact 数据模型<a class="headerlink" href="#id66" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># User 模型</span>
<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">open_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^ou_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">union_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^on_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">en_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mobile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">avatar</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">department_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>  <span class="c1"># 1:正常, 2:停用, 4:未激活, 5:退出</span>
    <span class="n">employee_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">join_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># UserCache 模型</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserCache</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">app_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^cli_[a-z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="n">union_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^on_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="n">open_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^ou_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mobile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">avatar</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">department_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cached_at</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">ttl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">86400</span>  <span class="c1"># 24 hours</span>
    <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_at</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span>

<span class="c1"># Department 模型</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Department</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">department_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^dept_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">parent_department_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">leader_user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">member_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># 1:正常, 2:停用</span>
    <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># ChatGroup 模型</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ChatGroup</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">chat_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^oc_[a-zA-Z0-9]</span><span class="si">{16}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">owner_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">avatar</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">member_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">chat_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;private&quot;</span><span class="p">,</span> <span class="s2">&quot;public&quot;</span><span class="p">]</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id67">
<h2>参考资料<a class="headerlink" href="#id67" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="phase4-requirements-review.html"><span class="std std-doc">Phase 4 需求评审报告</span></a></p></li>
<li><p><a class="reference internal" href="#../specs/001-lark-service-core/checklists/phase4-requirements-quality.md"><span class="xref myst">Phase 4 检查清单</span></a></p></li>
<li><p><a class="reference internal" href="#../specs/001-lark-service-core/contracts/clouddoc.yaml"><span class="xref myst">CloudDoc API 契约</span></a></p></li>
<li><p><a class="reference internal" href="#../specs/001-lark-service-core/contracts/contact.yaml"><span class="xref myst">Contact API 契约</span></a></p></li>
<li><p><a class="reference external" href="https://open.feishu.cn/document/">飞书开放平台文档</a></p></li>
</ul>
<hr class="docutils" />
<p><strong>文档版本</strong>: v1.0
<strong>最后更新</strong>: 2026-01-15
<strong>维护者</strong>: Lark Service Team</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2026, Ray。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>