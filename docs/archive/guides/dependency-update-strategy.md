# ä¾èµ–æ›´æ–°ç­–ç•¥

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰ Lark Service é¡¹ç›®çš„ä¾èµ–åŒ…æ›´æ–°ç­–ç•¥ï¼ŒåŒ…æ‹¬æ›´æ–°é¢‘ç‡ã€å®‰å…¨è¡¥ä¸ã€ç‰ˆæœ¬ç®¡ç†å’Œè‡ªåŠ¨åŒ–æµç¨‹ã€‚

## ğŸ¯ æ›´æ–°åŸåˆ™

### 1. å®‰å…¨ä¼˜å…ˆ

- **å®‰å…¨æ¼æ´**: ç«‹å³ä¿®å¤ï¼ˆ24å°æ—¶å†…ï¼‰
- **é«˜å±æ¼æ´**: 2ä¸ªå·¥ä½œæ—¥å†…ä¿®å¤
- **ä¸­å±æ¼æ´**: 1å‘¨å†…ä¿®å¤
- **ä½å±æ¼æ´**: ä¸‹ä¸ªè¿­ä»£ä¿®å¤

### 2. ç¨³å®šæ€§ä¼˜å…ˆ

- ä¼˜å…ˆä½¿ç”¨ç¨³å®šç‰ˆæœ¬ï¼ˆé¿å… alpha/beta/rcï¼‰
- ä¸»ç‰ˆæœ¬å‡çº§éœ€è¦å……åˆ†æµ‹è¯•
- å…³é”®ä¾èµ–ï¼ˆå¦‚ FastAPI, SQLAlchemyï¼‰è°¨æ…å‡çº§

### 3. å…¼å®¹æ€§ä¿è¯

- éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶ï¼ˆSemVerï¼‰
- é”å®šä¸»ç‰ˆæœ¬ï¼Œå…è®¸æ¬¡ç‰ˆæœ¬å’Œè¡¥ä¸ç‰ˆæœ¬è‡ªåŠ¨æ›´æ–°
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç²¾ç¡®ç‰ˆæœ¬é”å®š

## ğŸ“… æ›´æ–°é¢‘ç‡

### å®šæœŸæ›´æ–°

| ä¾èµ–ç±»å‹ | æ›´æ–°é¢‘ç‡ | è´£ä»»äºº | æµç¨‹ |
|---------|---------|--------|------|
| **å®‰å…¨è¡¥ä¸** | æ£€æµ‹åˆ°åç«‹å³ | SRE/å¼€å‘ | è‡ªåŠ¨PR + äººå·¥å®¡æ ¸ |
| **æ¬¡ç‰ˆæœ¬æ›´æ–°** | æ¯æœˆç¬¬ä¸€å‘¨ | å¼€å‘å›¢é˜Ÿ | Dependabot PR |
| **ä¸»ç‰ˆæœ¬æ›´æ–°** | æ¯å­£åº¦è¯„ä¼° | æŠ€æœ¯è´Ÿè´£äºº | æ‰‹åŠ¨å‡çº§ + å®Œæ•´æµ‹è¯• |
| **å¼€å‘ä¾èµ–** | éšæ—¶æ›´æ–° | å¼€å‘è€… | æœ¬åœ°æµ‹è¯•ååˆå¹¶ |

### ç‰¹æ®Šä¾èµ–ç­–ç•¥

#### æ ¸å¿ƒæ¡†æ¶

```toml
# ä¿æŒä¸»ç‰ˆæœ¬ç¨³å®šï¼Œå…è®¸æ¬¡ç‰ˆæœ¬æ›´æ–°
fastapi = "^0.115.0"       # å…è®¸ 0.115.x, 0.116.x
sqlalchemy = "^2.0.0"      # å…è®¸ 2.x.x
pydantic = "^2.10.0"       # å…è®¸ 2.10.x, 2.11.x
```

#### é£ä¹¦SDK

```toml
# è·Ÿéšå®˜æ–¹æ¨èç‰ˆæœ¬
lark-oapi = "^1.3.0"       # é£ä¹¦å®˜æ–¹SDK
```

#### å®‰å…¨ç›¸å…³

```toml
# å§‹ç»ˆä½¿ç”¨æœ€æ–°å®‰å…¨ç‰ˆæœ¬
cryptography = "^43.0.3"   # å®‰å…¨ç›¸å…³ï¼Œç§¯ææ›´æ–°
certifi = "^2024.0.0"      # è¯ä¹¦ï¼Œä¿æŒæœ€æ–°
```

## ğŸ” ä¾èµ–å®¡æŸ¥æ¸…å•

### æ›´æ–°å‰æ£€æŸ¥

- [ ] **å®‰å…¨æ€§**: æ£€æŸ¥CVEæ•°æ®åº“ï¼Œæ— å·²çŸ¥æ¼æ´
- [ ] **è®¸å¯è¯**: å…¼å®¹é¡¹ç›®è®¸å¯è¯ï¼ˆMIT/Apache 2.0ï¼‰
- [ ] **ç»´æŠ¤çŠ¶æ€**: é¡¹ç›®æ´»è·ƒï¼Œæœ‰æŒç»­ç»´æŠ¤
- [ ] **å…¼å®¹æ€§**: ä¸ç°æœ‰ä¾èµ–æ— å†²çª
- [ ] **æ€§èƒ½å½±å“**: æ— æ˜¾è‘—æ€§èƒ½å›å½’
- [ ] **ç ´åæ€§å˜æ›´**: é˜…è¯» CHANGELOGï¼Œè¯„ä¼°å½±å“

### æ›´æ–°åéªŒè¯

- [ ] **å•å…ƒæµ‹è¯•**: 100%é€šè¿‡
- [ ] **é›†æˆæµ‹è¯•**: å…³é”®è·¯å¾„éªŒè¯
- [ ] **Linting**: ruff + mypy æ— é”™è¯¯
- [ ] **å®‰å…¨æ‰«æ**: bandit + safety é€šè¿‡
- [ ] **æ€§èƒ½æµ‹è¯•**: æ— æ˜¾è‘—é€€åŒ–
- [ ] **æ–‡æ¡£æ›´æ–°**: æ›´æ–°ç›¸å…³æ–‡æ¡£

## ğŸ¤– è‡ªåŠ¨åŒ–å·¥å…·

### 1. Dependabot é…ç½®

`.github/dependabot.yml`:

```yaml
version: 2
updates:
  # Pythonä¾èµ–
  - package-ecosystem: "pip"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "09:00"
      timezone: "Asia/Shanghai"
    open-pull-requests-limit: 10
    reviewers:
      - "backend-team"
    labels:
      - "dependencies"
      - "automerge"
    commit-message:
      prefix: "deps"
      include: "scope"
    # ç‰ˆæœ¬æ›´æ–°ç­–ç•¥
    versioning-strategy: increase-if-necessary
    # å®‰å…¨æ›´æ–°ä¼˜å…ˆ
    allow:
      - dependency-type: "direct"
      - dependency-type: "indirect"
    # å¿½ç•¥ç‰¹å®šä¾èµ–
    ignore:
      - dependency-name: "lark-oapi"
        update-types: ["version-update:semver-major"]

  # GitHub Actions
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "monthly"
    labels:
      - "ci/cd"
```

### 2. Safety å®‰å…¨æ‰«æ

```bash
# æ¯æ—¥è‡ªåŠ¨æ‰«æ
safety check --json --output safety-report.json

# CI é›†æˆ
- name: Security Scan
  run: |
    uv pip install safety
    safety check --continue-on-error
```

### 3. pip-audit æ¼æ´æ£€æµ‹

```bash
# å®¡è®¡å½“å‰ç¯å¢ƒ
pip-audit

# ç”ŸæˆæŠ¥å‘Š
pip-audit --format json --output audit-report.json
```

## ğŸ“¦ ç‰ˆæœ¬ç®¡ç†

### requirements.txt ç®¡ç†

#### å¼€å‘ç¯å¢ƒï¼ˆrequirements.txtï¼‰

```txt
# ä½¿ç”¨ ~ å…è®¸è¡¥ä¸ç‰ˆæœ¬æ›´æ–°
fastapi~=0.115.0
sqlalchemy~=2.0.36
pydantic~=2.10.6
```

#### ç”Ÿäº§ç¯å¢ƒï¼ˆrequirements-prod.txtï¼‰

```txt
# ç²¾ç¡®ç‰ˆæœ¬é”å®š
fastapi==0.115.6
sqlalchemy==2.0.36
pydantic==2.10.6
# ... åŒ…æ‹¬æ‰€æœ‰ä¼ é€’ä¾èµ–
```

#### ç”Ÿæˆç”Ÿäº§é”å®šæ–‡ä»¶

```bash
# ä½¿ç”¨ uv ç”Ÿæˆ
uv pip compile requirements.txt --output-file requirements-prod.txt

# æˆ–ä½¿ç”¨ pip-tools
pip-compile requirements.txt --output-file requirements-prod.txt
```

### æ›´æ–°æµç¨‹

```bash
# 1. æ›´æ–°å¼€å‘ä¾èµ–
uv pip install --upgrade fastapi

# 2. è¿è¡Œæµ‹è¯•
pytest tests/

# 3. ç”Ÿæˆæ–°çš„é”å®šæ–‡ä»¶
uv pip freeze > requirements-prod.txt

# 4. æäº¤æ›´æ”¹
git add requirements.txt requirements-prod.txt
git commit -m "deps: upgrade fastapi to 0.115.6"
```

## ğŸ”„ æ›´æ–°å·¥ä½œæµ

### æœˆåº¦æ›´æ–°æµç¨‹

**ç¬¬ä¸€å‘¨å‘¨ä¸€**ï¼š

1. **è‡ªåŠ¨æ£€æµ‹**ï¼ˆDependabotï¼‰
   - ç”Ÿæˆä¾èµ–æ›´æ–°PR
   - è‡ªåŠ¨è¿è¡ŒCIæµ‹è¯•

2. **äººå·¥å®¡æ ¸**ï¼ˆå½“æ—¥å®Œæˆï¼‰
   - å®¡æŸ¥ CHANGELOG
   - è¯„ä¼°ç ´åæ€§å˜æ›´
   - å®¡æ‰¹å®‰å…¨è¡¥ä¸

3. **æµ‹è¯•éªŒè¯**ï¼ˆ2ä¸ªå·¥ä½œæ—¥ï¼‰
   - å•å…ƒæµ‹è¯•
   - é›†æˆæµ‹è¯•
   - stagingç¯å¢ƒéªŒè¯

4. **åˆå¹¶éƒ¨ç½²**ï¼ˆå‘¨ä¸‰å‰ï¼‰
   - åˆå¹¶PR
   - éƒ¨ç½²åˆ°staging
   - ç›‘æ§24å°æ—¶

5. **ç”Ÿäº§éƒ¨ç½²**ï¼ˆå‘¨äº”ï¼‰
   - éƒ¨ç½²åˆ°production
   - æŒç»­ç›‘æ§

### ç´§æ€¥å®‰å…¨æ›´æ–°

**æ£€æµ‹åˆ°é«˜å±æ¼æ´**ï¼š

1. **ç«‹å³å“åº”**ï¼ˆ1å°æ—¶å†…ï¼‰
   - è¯„ä¼°å½±å“èŒƒå›´
   - åˆ›å»ºhotfixåˆ†æ”¯

2. **å¿«é€Ÿä¿®å¤**ï¼ˆ4å°æ—¶å†…ï¼‰
   - æ›´æ–°ä¾èµ–ç‰ˆæœ¬
   - è¿è¡Œå…³é”®æµ‹è¯•
   - ä»£ç å®¡æŸ¥

3. **ç´§æ€¥éƒ¨ç½²**ï¼ˆ8å°æ—¶å†…ï¼‰
   - éƒ¨ç½²åˆ°staging
   - å¿«é€ŸéªŒè¯
   - éƒ¨ç½²åˆ°production

4. **äº‹åå¤ç›˜**ï¼ˆæ¬¡æ—¥ï¼‰
   - åˆ†ææ ¹å› 
   - æ›´æ–°ç›‘æ§
   - æ”¹è¿›æµç¨‹

## ğŸ“Š ä¾èµ–å¥åº·åº¦ç›‘æ§

### å…³é”®æŒ‡æ ‡

- **å·²çŸ¥æ¼æ´æ•°**: ç›®æ ‡ 0
- **è¿‡æ—¶ä¾èµ–æ•°**: ç›®æ ‡ < 5
- **ä¸»ç‰ˆæœ¬è½å**: ç›®æ ‡ < 2ä¸ªå¤§ç‰ˆæœ¬
- **æ›´æ–°å“åº”æ—¶é—´**: å®‰å…¨è¡¥ä¸ < 24h, å¸¸è§„æ›´æ–° < 7å¤©

### ç›‘æ§å·¥å…·

```bash
# æ£€æŸ¥è¿‡æ—¶ä¾èµ–
uv pip list --outdated

# å®‰å…¨æ¼æ´æ‰«æ
safety check

# è®¸å¯è¯åˆè§„
pip-licenses --format=markdown

# ä¾èµ–æ ‘åˆ†æ
pipdeptree
```

## ğŸš¨ å›æ»šç­–ç•¥

### å›æ»šè§¦å‘æ¡ä»¶

- CIæµ‹è¯•å¤±è´¥
- ç”Ÿäº§ç¯å¢ƒé”™è¯¯ç‡ä¸Šå‡ >5%
- æ€§èƒ½ä¸‹é™ >20%
- å‘ç°æ–°çš„å®‰å…¨æ¼æ´

### å›æ»šæ­¥éª¤

```bash
# 1. å›æ»šåˆ°ä¹‹å‰çš„é”å®šæ–‡ä»¶
git checkout HEAD~1 requirements-prod.txt

# 2. é‡æ–°å®‰è£…ä¾èµ–
uv pip install -r requirements-prod.txt

# 3. éªŒè¯æœåŠ¡æ­£å¸¸
./scripts/health_check.sh

# 4. é‡æ–°éƒ¨ç½²
./scripts/deploy_production.sh
```

## ğŸ“š å‚è€ƒèµ„æº

- [Python å®‰å…¨å…¬å‘Š](https://pypi.org/security/)
- [CVE æ•°æ®åº“](https://cve.mitre.org/)
- [Dependabot æ–‡æ¡£](https://docs.github.com/en/code-security/dependabot)
- [Safety DB](https://github.com/pyupio/safety-db)

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [CI/CD Pipeline](.github/workflows/ci.yml)
- [å®‰å…¨æ‰«æé…ç½®](../docs/security-guide.md)
- [éƒ¨ç½²æ–‡æ¡£](../docs/deployment.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-01-18
**è´Ÿè´£äºº**: Backend Team
**å®¡æ ¸å‘¨æœŸ**: å­£åº¦
