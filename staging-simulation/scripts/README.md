# Stagingæ¨¡æ‹Ÿç¯å¢ƒ - å·¥å…·è„šæœ¬

æœ¬ç›®å½•åŒ…å«ç”¨äºç®¡ç†stagingæ¨¡æ‹Ÿç¯å¢ƒçš„å„ç§è„šæœ¬ã€‚

---

## ğŸ“‹ è„šæœ¬åˆ—è¡¨

### ç¯å¢ƒç®¡ç†

#### `start.sh`
**åŠŸèƒ½**: ä¸€é”®å¯åŠ¨Dockerç¯å¢ƒ
**ä½¿ç”¨**: `bash start.sh`

- æ£€æŸ¥Dockerç¯å¢ƒ
- å¯åŠ¨æ‰€æœ‰DockeræœåŠ¡
- ç­‰å¾…æœåŠ¡å°±ç»ª
- éªŒè¯æ•°æ®åº“é…ç½®
- æ˜¾ç¤ºè¿æ¥ä¿¡æ¯

### é…ç½®ç®¡ç†

#### `check_config.sh`
**åŠŸèƒ½**: æ£€æŸ¥`.env.local`é…ç½®å®Œæ•´æ€§
**ä½¿ç”¨**: `bash check_config.sh`

æ£€æŸ¥é¡¹:
- é£ä¹¦åº”ç”¨å‡­è¯
- æ•°æ®åº“é…ç½®
- Tokenç®¡ç†é…ç½®
- é£ä¹¦APIé…ç½®
- ç¯å¢ƒæ ‡è¯†

#### `update_test_tokens.sh`
**åŠŸèƒ½**: è‡ªåŠ¨æ·»åŠ é›†æˆæµ‹è¯•èµ„æºtoken
**ä½¿ç”¨**: `bash update_test_tokens.sh`

- è‡ªåŠ¨å¤‡ä»½åŸé…ç½®
- æ·»åŠ TEST_*ç¯å¢ƒå˜é‡
- éªŒè¯é…ç½®å®Œæ•´æ€§

#### `verify_test_config.sh`
**åŠŸèƒ½**: éªŒè¯æµ‹è¯•é…ç½®æ˜¯å¦å°±ç»ª
**ä½¿ç”¨**: `bash verify_test_config.sh`

éªŒè¯é¡¹:
- LARK_APP_ID/LARK_APP_SECRET
- TEST_BITABLE_APP_TOKEN
- TEST_SHEET_TOKEN
- TEST_DOC_TOKEN

### æ•°æ®åº“ç®¡ç†

#### `backup_docker.sh`
**åŠŸèƒ½**: å¤‡ä»½Dockerä¸­çš„PostgreSQLæ•°æ®åº“
**ä½¿ç”¨**: `bash backup_docker.sh`

ç‰¹æ€§:
- ä½¿ç”¨Dockerå†…çš„pg_dump
- è‡ªåŠ¨å‹ç¼©å¤‡ä»½æ–‡ä»¶
- æ¸…ç†7å¤©å‰çš„æ—§å¤‡ä»½
- éªŒè¯å¤‡ä»½å®Œæ•´æ€§

#### `restore_docker.sh`
**åŠŸèƒ½**: ä»å¤‡ä»½æ¢å¤æ•°æ®åº“
**ä½¿ç”¨**: `bash restore_docker.sh <backup_file>`

ç‰¹æ€§:
- è‡ªåŠ¨åˆ›å»ºå®‰å…¨å¤‡ä»½
- æ”¯æŒ.sqlå’Œ.sql.gzæ ¼å¼
- éªŒè¯æ¢å¤ç»“æœ
- æ¢å¤pgcryptoæ‰©å±•

### æµ‹è¯•

#### `test-deployment.sh`
**åŠŸèƒ½**: è¿è¡Œå®Œæ•´éƒ¨ç½²æµ‹è¯•æµç¨‹
**ä½¿ç”¨**: `bash test-deployment.sh`

æµ‹è¯•æ­¥éª¤:
1. éªŒè¯ç¯å¢ƒé…ç½®
2. è¿è¡Œå¥åº·æ£€æŸ¥
3. æ‰§è¡Œæ•°æ®åº“è¿ç§»
4. è¿è¡Œå•å…ƒæµ‹è¯•
5. è¿è¡Œé›†æˆæµ‹è¯•
6. æµ‹è¯•æ•°æ®åº“å¤‡ä»½
7. æµ‹è¯•è¿ç§»å›æ»š

---

## ğŸš€ å¸¸ç”¨å·¥ä½œæµ

### é¦–æ¬¡è®¾ç½®

```bash
# 1. å¯åŠ¨ç¯å¢ƒ
bash start.sh

# 2. é…ç½®ç¯å¢ƒå˜é‡
cd ..
cp env.local.template .env.local
vim .env.local

# 3. æ£€æŸ¥é…ç½®
bash check_config.sh

# 4. æ·»åŠ æµ‹è¯•èµ„æºï¼ˆå¯é€‰ï¼‰
bash update_test_tokens.sh

# 5. éªŒè¯æµ‹è¯•é…ç½®
bash verify_test_config.sh
```

### æ—¥å¸¸å¼€å‘

```bash
# å¯åŠ¨ç¯å¢ƒ
bash start.sh

# è¿è¡Œå®Œæ•´æµ‹è¯•
bash test-deployment.sh

# å¤‡ä»½æ•°æ®åº“
bash backup_docker.sh

# åœæ­¢ç¯å¢ƒ
cd ..
docker compose down
```

### æ•…éšœæ¢å¤

```bash
# ä»å¤‡ä»½æ¢å¤
bash restore_docker.sh ../backups/lark_service_full_20260118_070000.sql.gz

# é‡å¯ç¯å¢ƒ
cd ..
docker compose restart

# éªŒè¯æ¢å¤
bash check_config.sh
```

---

## ğŸ“ è„šæœ¬å¼€å‘è§„èŒƒ

### é€šç”¨è§„èŒƒ

1. **Shebang**: ä½¿ç”¨`#!/bin/bash`
2. **é”™è¯¯å¤„ç†**: æ·»åŠ `set -e`åœ¨è„šæœ¬å¼€å¤´
3. **é¢œè‰²è¾“å‡º**: ä½¿ç”¨æ ‡å‡†é¢œè‰²å˜é‡
4. **å¸®åŠ©ä¿¡æ¯**: æä¾›æ¸…æ™°çš„ä½¿ç”¨è¯´æ˜
5. **é”™è¯¯æç¤º**: æä¾›å…·ä½“çš„é”™è¯¯åŸå› å’Œè§£å†³æ–¹æ³•

### é¢œè‰²å®šä¹‰

```bash
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color
```

### å‡½æ•°å‘½å

- é…ç½®æ£€æŸ¥: `check_*`
- æœåŠ¡éªŒè¯: `verify_*`
- èµ„æºåˆ›å»º: `create_*`
- æ¸…ç†æ“ä½œ: `cleanup_*`

---

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒå˜é‡**: è„šæœ¬åº”ä»`.env.local`åŠ è½½é…ç½®
2. **å¯†é’¥ä¿æŠ¤**: æ˜¾ç¤ºå¯†é’¥æ—¶ä½¿ç”¨è„±æ•
3. **å¤‡ä»½å®‰å…¨**: å¤‡ä»½æ–‡ä»¶åº”åŠ å¯†å­˜å‚¨
4. **æƒé™æ§åˆ¶**: å…³é”®è„šæœ¬åº”è®¾ç½®æ‰§è¡Œæƒé™

---

## ğŸ› æ•…éšœæ’æŸ¥

### è„šæœ¬æ‰§è¡Œå¤±è´¥

```bash
# æ£€æŸ¥æ‰§è¡Œæƒé™
chmod +x script_name.sh

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
bash -x script_name.sh
```

### Dockerå‘½ä»¤å¤±è´¥

```bash
# æ£€æŸ¥DockeræœåŠ¡
systemctl status docker

# æ£€æŸ¥Docker Composeç‰ˆæœ¬
docker compose version
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Stagingæ¨¡æ‹Ÿç¯å¢ƒREADME](../README.md)
- [é›†æˆæµ‹è¯•é…ç½®æŒ‡å—](../../docs/integration-test-setup-guide.md)
- [éƒ¨ç½²æŒ‡å—](../../docs/deployment.md)

---

**ç»´æŠ¤è€…**: Backend Team
**æœ€åæ›´æ–°**: 2026-01-18
